<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Chat IA DUIMP">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#075e54">
  <meta name="msapplication-TileColor" content="#075e54">
  
  <!-- Apple Touch Icons (para adicionar √† tela inicial) -->
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%23075e54' width='180' height='180'/%3E%3Ctext x='50%25' y='50%25' font-size='80' fill='white' text-anchor='middle' dominant-baseline='middle' font-family='Arial'%3Eü§ñ%3C/text%3E%3C/svg%3E">
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%23075e54' width='32' height='32'/%3E%3Ctext x='50%25' y='50%25' font-size='20' fill='white' text-anchor='middle' dominant-baseline='middle' font-family='Arial'%3Eü§ñ%3C/text%3E%3C/svg%3E">
  
  <title>mAIke - Assistente DUIMP</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #ece5dd;
      height: 100vh;
      height: 100dvh; /* ‚úÖ Dynamic viewport height para mobile */
      overflow: hidden;
      display: flex;
      flex-direction: column;
      -webkit-tap-highlight-color: transparent;
      /* ‚úÖ Safe area para iPhone com notch */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    
    /* ‚úÖ Esconder barra de navega√ß√£o do Safari quando em modo standalone */
    body.standalone-mode {
      /* Remove espa√ßo da barra de navega√ß√£o */
      padding-bottom: env(safe-area-inset-bottom);
      height: 100vh;
      height: -webkit-fill-available;
      height: 100dvh;
    }
    
    @media all and (display-mode: standalone) {
      body {
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
    
    /* ‚úÖ Esconder barra de endere√ßo no iOS Safari quando em modo standalone */
    @supports (-webkit-touch-callout: none) {
      body.standalone-mode {
        /* Remove espa√ßo da barra de navega√ß√£o */
        padding-bottom: 0;
        height: 100vh;
        height: -webkit-fill-available;
      }
    }
    
    /* Cabe√ßalho estilo WhatsApp */
    .chat-header {
      background: #075e54;
      color: #fff;
      padding: 12px 16px;
      padding-top: max(12px, env(safe-area-inset-top, 0px) + 12px); /* ‚úÖ Safe area para notch */
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
      min-height: 44px; /* ‚úÖ Altura m√≠nima para touch targets no iOS */
    }
    
    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .chat-header-title {
      font-size: 16px;
      font-weight: 500;
      color: #fff;
    }
    
    .chat-header-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      margin-top: 2px;
    }
    
    .btn-fechar {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn-fechar:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .btn-fechar:active {
      background: rgba(255,255,255,0.4);
    }
    
    /* √Årea de mensagens */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: #ece5dd;
      background-image: 
        url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='a' patternUnits='userSpaceOnUse' width='100' height='100' patternTransform='scale(0.5) rotate(0)'%3E%3Crect id='b' width='100%25' height='100%25' fill='hsla(0,0%25,100%25,0)'/%3E%3Cpath d='M100 50L50 0 0 50 50 100z' stroke-width='0.5' stroke='hsla(259,0%25,53%25,0.05)' fill='none'/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill='url(%23a)' width='100%25' height='100%25'/%3E%3C/svg%3E");
      -webkit-overflow-scrolling: touch;
      /* ‚úÖ Otimiza√ß√µes para performance em mobile com respostas grandes */
      touch-action: pan-y; /* Permite scroll vertical, bloqueia gestos horizontais */
      will-change: scroll-position; /* Otimiza renderiza√ß√£o durante scroll */
      contain: layout style paint; /* Isola renderiza√ß√£o do container */
      transform: translateZ(0); /* For√ßa acelera√ß√£o de hardware */
      -webkit-transform: translateZ(0); /* Safari */
      backface-visibility: hidden; /* Melhora performance de anima√ß√µes */
      -webkit-backface-visibility: hidden; /* Safari */
    }
    
    /* Mensagem */
    .chat-message {
      padding: 6px 10px;
      border-radius: 7.5px;
      max-width: 85%;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
      margin-bottom: 1px;
      font-size: 14px;
      line-height: 1.35;
      color: #303030;
      word-wrap: break-word;
      animation: slideIn 0.2s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-message.usuario {
      background: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
    }
    
    .chat-message.assistente {
      background: #ffffff;
      align-self: flex-start;
    }
    
    .chat-message-header {
      display: block;
      margin-bottom: 2px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .chat-message.usuario .chat-message-header {
      color: #075e54;
    }
    
    .chat-message.assistente .chat-message-header {
      color: #128c7e;
    }
    
    .chat-message-content {
      font-size: 14px;
      line-height: 1.35;
      color: #303030;
      word-wrap: break-word;
    }

    /* ‚úÖ Cores sem√¢nticas (relat√≥rios no chat) */
    .mk-color-recebido { color: #2e7d32; font-weight: 700; }
    .mk-color-aberto { color: #c62828; font-weight: 700; }
    .mk-color-cliente { color: #1565c0; font-weight: 700; }
    .mk-color-empresa { color: #ef6c00; font-weight: 800; }
    .mk-color-muted { color: #666; }

    /* ‚úÖ Badge de processo (estilo "bot√£o") */
    :root{
      /* Pantone 143 C (aproxima√ß√£o em hex) */
      /* ‚úÖ Mais suave (transparente) */
      --mk-proc-badge-bg: rgba(244, 176, 0, 0.28);
      --mk-proc-badge-fg: #2b1b00;
      --mk-proc-badge-border: rgba(0, 0, 0, 0.12);
    }
    .mk-proc-badge{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
      line-height: 1.35;
      white-space: nowrap;
      background: var(--mk-proc-badge-bg);
      color: var(--mk-proc-badge-fg);
      border: 1px solid var(--mk-proc-badge-border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 1px 0.5px rgba(0,0,0,0.18);
      margin: 0 2px;
      letter-spacing: 0.2px;
    }
    
    /* ‚úÖ Timestamp das mensagens (bem pequeno) */
    .chat-message-time {
      font-size: 10px;
      color: rgba(0, 0, 0, 0.4);
      margin-top: 2px;
      text-align: right;
      padding-right: 4px;
    }
    
    .chat-message.usuario .chat-message-time {
      color: rgba(0, 0, 0, 0.35);
    }
    
    .chat-message.assistente .chat-message-time {
      color: rgba(0, 0, 0, 0.4);
    }
    
    /* Input area */
    .chat-input-area {
      border-top: 1px solid #e0e0e0;
      padding: 8px 12px;
      padding-bottom: max(8px, env(safe-area-inset-bottom, 0px) + 8px); /* ‚úÖ Safe area para home indicator */
      background: #f0f0f0;
      min-height: 60px; /* ‚úÖ Altura m√≠nima para touch targets */
    }
    
    #chat-form {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 24px;
      font-size: 15px;
      outline: none;
      background: #fff;
      -webkit-appearance: none;
      font-family: inherit;
      min-width: 0;
      box-sizing: border-box;
    }
    
    .chat-input:focus {
      border-color: #075e54;
    }
    
    .chat-attach-btn {
      border-radius: 50%;
      font-size: 18px;
      background: #075e54;
      color: #fff;
      border: none;
      cursor: pointer;
      width: 44px;
      height: 44px;
      min-width: 44px;
      min-height: 44px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }
    
    .chat-mic-btn {
      border-radius: 50%;
      font-size: 18px;
      background: #128c7e;
      color: #fff;
      border: none;
      cursor: pointer;
      width: 44px;
      height: 44px;
      min-width: 44px;
      min-height: 44px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }
    
    .chat-mic-btn:hover {
      background: #0f7a6b;
    }
    
    .chat-mic-btn:active {
      background: #0c6357;
      transform: scale(0.96);
    }
    
    .chat-mic-btn.recording {
      background: #d32f2f;
      animation: pulseMic 1s infinite;
    }
    
    @keyframes pulseMic {
      0% { box-shadow: 0 0 0 0 rgba(211,47,47,0.6); }
      70% { box-shadow: 0 0 0 10px rgba(211,47,47,0); }
      100% { box-shadow: 0 0 0 0 rgba(211,47,47,0); }
    }
    
    .chat-attach-btn:hover {
      background: #064e47;
    }
    
    .chat-attach-btn:active {
      background: #053d37;
    }
    
    .chat-send-btn {
      border-radius: 50%;
      font-size: 18px;
      background: #075e54;
      color: #fff;
      border: none;
      cursor: pointer;
      width: 44px;
      height: 44px;
      min-width: 44px;
      min-height: 44px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }
    
    .chat-send-btn:hover {
      background: #064e47;
    }
    
    .chat-send-btn:active {
      background: #053d37;
    }
    
    .chat-send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Status */
    .chat-status {
      display: none;
      margin: 8px 12px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
      color: #856404;
    }
    
    .chat-status.error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    /* Loading indicator */
    .chat-loading {
      padding: 6px 10px;
      background: #ffffff;
      border-radius: 7.5px;
      max-width: 85%;
      align-self: flex-start;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
      font-size: 13px;
      color: #666;
      font-style: italic;
    }
    
    /* Scrollbar personalizada */
    .chat-messages::-webkit-scrollbar {
      width: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 2px;
    }
    
    /* ‚úÖ Melhorias para iPhone - experi√™ncia tipo app */
    @media (max-width: 480px) {
      .chat-message {
        font-size: 15px; /* Levemente maior no mobile */
        padding: 8px 12px;
      }
      
      .chat-input {
        font-size: 16px; /* Previne zoom no iOS */
        padding: 12px 16px;
      }
      
      .chat-input-area {
        padding: 10px 12px;
      }
    }
    
    /* ‚úÖ Prevenir pull-to-refresh no iOS */
    body {
      overscroll-behavior-y: none;
      -webkit-overflow-scrolling: touch;
      /* ‚úÖ Otimiza√ß√µes adicionais para touch em mobile */
      touch-action: manipulation; /* Remove delay de 300ms em toques */
      -webkit-tap-highlight-color: transparent; /* Remove highlight azul no iOS */
    }
    
    /* Mobile optimizations */
    @media (max-width: 480px) {
      .chat-message {
        max-width: 90%;
        font-size: 13px;
        /* ‚úÖ Otimiza√ß√µes de performance para mensagens grandes */
        will-change: transform;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
      }
      
      .chat-input {
        font-size: 15px;
        padding: 10px 14px;
      }
      
      .chat-send-btn {
        width: 44px;
        height: 44px;
        min-width: 44px;
        min-height: 44px;
        font-size: 16px;
      }
      
      .chat-header {
        padding: 10px 12px;
        padding-top: max(10px, env(safe-area-inset-top, 0px) + 10px);
      }
      
      .chat-header-title {
        font-size: 15px;
      }
      
      .chat-header-subtitle {
        font-size: 11px;
      }
    }
    
    /* ‚úÖ iPhone espec√≠fico - otimiza√ß√µes adicionais */
    @supports (-webkit-touch-callout: none) {
      /* iOS Safari */
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      .chat-input {
        font-size: 16px; /* ‚úÖ Previne zoom autom√°tico no iOS ao focar */
      }
      
      .chat-messages {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }
    }
    
    /* ‚úÖ Landscape mode - ajustes para iPhone em modo paisagem */
    @media (max-width: 896px) and (orientation: landscape) {
      .chat-header {
        padding: 8px 12px;
        padding-top: max(8px, env(safe-area-inset-top, 0px) + 8px);
        min-height: 40px;
      }
      
      .chat-input-area {
        padding: 8px 10px;
        padding-bottom: max(8px, env(safe-area-inset-bottom, 0px) + 8px);
        min-height: 60px;
      }
      
      #chat-form {
        gap: 8px;
      }
      
      .chat-input {
        font-size: 15px;
        padding: 10px 14px;
      }
      
      .chat-send-btn {
        width: 40px;
        height: 40px;
        min-width: 40px;
        min-height: 40px;
        font-size: 16px;
      }
      
      .chat-message {
        max-width: 75%;
        font-size: 12px;
      }
    }
    
    /* ‚úÖ Menu Lateral (Drawer) Moderno */
    #menu-drawer {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      max-width: 90vw;
      height: 100vh;
      height: 100dvh;
      background: #fff;
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 2000;
      transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #menu-drawer.drawer-open {
      right: 0;
    }
    
    #menu-drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    #menu-drawer-overlay.overlay-visible {
      opacity: 1;
      pointer-events: all;
    }
    
    .menu-drawer-header {
      background: linear-gradient(135deg, #075e54 0%, #128c7e 100%);
      color: #fff;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .menu-drawer-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .menu-drawer-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    
    .menu-drawer-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .menu-drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
    }
    
    .menu-section {
      margin-bottom: 24px;
    }
    
    .menu-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 24px 8px;
      margin-bottom: 8px;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 24px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      color: #333;
      text-decoration: none;
    }
    
    .menu-item:hover {
      background: #f5f5f5;
      border-left-color: #075e54;
      transform: translateX(2px);
    }
    
    .menu-item-icon {
      font-size: 22px;
      width: 32px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .menu-item-content {
      flex: 1;
    }
    
    .menu-item-title {
      font-size: 15px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }
    
    .menu-item-desc {
      font-size: 12px;
      color: #999;
    }
    
    .menu-item-badge {
      background: #f44336;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
    }
    
    /* ‚úÖ Modal de Configura√ß√£o */
    /* ‚úÖ Modal overlay estilo WhatsApp - suave e elegante */
    #modal-config, 
    #modal-import-legislacao, 
    #modal-sync-banco, 
    #modal-conciliacao-lancamentos, 
    #modal-classificar-lancamento,
    #modal-aprovar-boleto,
    #modal-historico-pagamentos,
    #modal-status-atualizacoes {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    /* Anima√ß√£o de entrada do modal content */
    #modal-config .modal-content, 
    #modal-import-legislacao .modal-content, 
    #modal-sync-banco .modal-content, 
    #modal-conciliacao-lancamentos .modal-content, 
    #modal-classificar-lancamento .modal-content,
    #modal-aprovar-boleto .modal-content,
    #modal-historico-pagamentos .modal-content,
    #modal-status-atualizacoes .modal-content {
      animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* ‚úÖ Modal content estilo WhatsApp - clean e moderno */
    #modal-config .modal-content, 
    #modal-import-legislacao .modal-content, 
    #modal-sync-banco .modal-content, 
    #modal-conciliacao-lancamentos .modal-content, 
    #modal-classificar-lancamento .modal-content,
    #modal-aprovar-boleto .modal-content,
    #modal-historico-pagamentos .modal-content,
    #modal-status-atualizacoes .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 28px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    /* Modal de concilia√ß√£o maior */
    #modal-conciliacao-lancamentos .modal-content {
      max-width: 900px;
      padding: 24px;
    }
    
    /* Modal de classifica√ß√£o */
    #modal-classificar-lancamento .modal-content {
      max-width: 700px;
    }
    
    /* Responsivo para iPhone */
    @media (max-width: 480px) {
      #modal-config .modal-content, 
      #modal-import-legislacao .modal-content, 
      #modal-sync-banco .modal-content, 
      #modal-conciliacao-lancamentos .modal-content, 
      #modal-classificar-lancamento .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 100vh;
        border-radius: 0;
        padding: 20px;
      }
    }
    
    #modal-import-legislacao .modal-content {
      max-width: 600px;
    }
    
    .modal-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .modal-input:focus {
      outline: none;
      border-color: #075e54;
    }
    
    /* ‚úÖ Header do modal estilo WhatsApp */
    #modal-config .modal-header,
    #modal-conciliacao-lancamentos .modal-header,
    #modal-classificar-lancamento .modal-header,
    #modal-sync-banco .modal-header,
    #modal-import-legislacao .modal-header,
    #modal-status-atualizacoes .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e9edef;
    }
    
    #modal-config .modal-header h2,
    #modal-conciliacao-lancamentos .modal-header h2,
    #modal-classificar-lancamento .modal-header h2,
    #modal-sync-banco .modal-header h2,
    #modal-import-legislacao .modal-header h2,
    #modal-status-atualizacoes .modal-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 400;
      color: #111b21;
      letter-spacing: -0.3px;
    }
    
    /* ‚úÖ Bot√£o fechar estilo WhatsApp */
    #modal-config .modal-close,
    #modal-conciliacao-lancamentos .modal-close,
    #modal-classificar-lancamento .modal-close,
    #modal-sync-banco .modal-close,
    #modal-import-legislacao .modal-close,
    #modal-historico-pagamentos .modal-close,
    #modal-status-atualizacoes .modal-close {
      background: rgba(0,0,0,0.05);
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #54656f;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
      font-weight: 300;
    }
    
    #modal-config .modal-close:hover,
    #modal-conciliacao-lancamentos .modal-close:hover,
    #modal-classificar-lancamento .modal-close:hover,
    #modal-sync-banco .modal-close:hover,
    #modal-import-legislacao .modal-close:hover,
    #modal-historico-pagamentos .modal-close:hover,
    #modal-status-atualizacoes .modal-close:hover {
      background: rgba(0,0,0,0.1);
      color: #111b21;
      transform: scale(1.1);
    }
    
    #modal-config .modal-close:active,
    #modal-conciliacao-lancamentos .modal-close:active,
    #modal-classificar-lancamento .modal-close:active,
    #modal-sync-banco .modal-close:active,
    #modal-import-legislacao .modal-close:active,
    #modal-historico-pagamentos .modal-close:active,
    #modal-status-atualizacoes .modal-close:active {
      transform: scale(0.95);
    }
    
    #modal-config .modal-body {
      margin-bottom: 16px;
    }
    
    #modal-config label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    
    #modal-config input[type="email"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    #modal-config input[type="email"]:focus {
      outline: none;
      border-color: #075e54;
    }
    
    #modal-config .modal-help {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }
    
    /* ‚úÖ Estilos WhatsApp para modais */
    #modal-config .modal-footer,
    #modal-conciliacao-lancamentos .modal-footer,
    #modal-classificar-lancamento .modal-footer,
    #modal-sync-banco .modal-footer,
    #modal-import-legislacao .modal-footer,
    #modal-status-atualizacoes .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 16px;
      margin-top: 16px;
      border-top: 1px solid #e9edef;
    }
    
    /* ‚úÖ Bot√µes modernos estilo WhatsApp */
    #modal-config .modal-btn,
    #modal-conciliacao-lancamentos .modal-btn,
    #modal-classificar-lancamento .modal-btn,
    #modal-sync-banco .modal-btn,
    #modal-import-legislacao .modal-btn,
    #modal-status-atualizacoes .modal-btn {
      padding: 12px 24px;
      border-radius: 24px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      border: none;
      transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
      min-width: 100px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    /* Bot√£o Cancelar/Fechar - estilo WhatsApp (cinza suave) */
    #modal-config .modal-btn-cancel,
    #modal-conciliacao-lancamentos .modal-btn-cancel,
    #modal-classificar-lancamento .modal-btn-cancel,
    #modal-sync-banco .modal-btn-cancel,
    #modal-import-legislacao .modal-btn-cancel,
    #modal-status-atualizacoes .modal-btn-cancel {
      background: #f0f2f5;
      color: #54656f;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    #modal-config .modal-btn-cancel:hover,
    #modal-conciliacao-lancamentos .modal-btn-cancel:hover,
    #modal-classificar-lancamento .modal-btn-cancel:hover,
    #modal-sync-banco .modal-btn-cancel:hover,
    #modal-import-legislacao .modal-btn-cancel:hover,
    #modal-status-atualizacoes .modal-btn-cancel:hover {
      background: #e4e6eb;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #modal-config .modal-btn-cancel:active,
    #modal-conciliacao-lancamentos .modal-btn-cancel:active,
    #modal-classificar-lancamento .modal-btn-cancel:active,
    #modal-sync-banco .modal-btn-cancel:active,
    #modal-import-legislacao .modal-btn-cancel:active,
    #modal-status-atualizacoes .modal-btn-cancel:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* Bot√£o Salvar/Atualizar - estilo WhatsApp (verde) */
    #modal-config .modal-btn-save,
    #modal-conciliacao-lancamentos .modal-btn-save,
    #modal-classificar-lancamento .modal-btn-save,
    #modal-sync-banco .modal-btn-save,
    #modal-import-legislacao .modal-btn-save,
    #modal-status-atualizacoes .modal-btn-save {
      background: linear-gradient(135deg, #25D366 0%, #20BA5A 100%);
      color: #fff;
      box-shadow: 0 2px 6px rgba(37, 211, 102, 0.3);
    }
    
    #modal-config .modal-btn-save:hover,
    #modal-conciliacao-lancamentos .modal-btn-save:hover,
    #modal-classificar-lancamento .modal-btn-save:hover,
    #modal-sync-banco .modal-btn-save:hover,
    #modal-import-legislacao .modal-btn-save:hover,
    #modal-status-atualizacoes .modal-btn-save:hover {
      background: linear-gradient(135deg, #20BA5A 0%, #1DA851 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    }
    
    #modal-config .modal-btn-save:active,
    #modal-conciliacao-lancamentos .modal-btn-save:active,
    #modal-classificar-lancamento .modal-btn-save:active,
    #modal-sync-banco .modal-btn-save:active,
    #modal-import-legislacao .modal-btn-save:active,
    #modal-status-atualizacoes .modal-btn-save:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(37, 211, 102, 0.3);
    }
    
    /* Estado de loading para bot√µes */
    #modal-config .modal-btn:disabled,
    #modal-conciliacao-lancamentos .modal-btn:disabled,
    #modal-classificar-lancamento .modal-btn:disabled,
    #modal-sync-banco .modal-btn:disabled,
    #modal-import-legislacao .modal-btn:disabled,
    #modal-status-atualizacoes .modal-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Responsivo para iPhone */
    @media (max-width: 480px) {
      #modal-config .modal-footer,
      #modal-conciliacao-lancamentos .modal-footer,
      #modal-classificar-lancamento .modal-footer,
      #modal-sync-banco .modal-footer,
      #modal-import-legislacao .modal-footer,
      #modal-status-atualizacoes .modal-footer {
        flex-direction: column-reverse;
        gap: 10px;
      }
      
      #modal-config .modal-btn,
      #modal-conciliacao-lancamentos .modal-btn,
      #modal-classificar-lancamento .modal-btn,
      #modal-sync-banco .modal-btn,
      #modal-import-legislacao .modal-btn,
      #modal-status-atualizacoes .modal-btn {
        width: 100%;
        min-width: auto;
        padding: 14px 24px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Cabe√ßalho -->
  <div class="chat-header">
    <div class="chat-header-left">
      <div>
        <div class="chat-header-title">ü§ñ mAIke</div>
        <div class="chat-header-subtitle">Assistente DUIMP ‚Ä¢ <span id="modelo-indicator" style="font-size:11px; opacity:0.9;">gpt-3.5-turbo</span> ‚Ä¢ <span id="ptax-indicator" style="font-size:11px; opacity:0.9;">PTAX: --</span></div>
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <!-- ‚úÖ NOVO: Bot√£o √∫nico de menu (substitui todos os outros) -->
      <button id="menu-btn" 
              class="btn-menu"
              onclick="abrirMenuDrawer()"
              title="Abrir menu (ou digite 'maike menu')">
        ‚ò∞
      </button>
      <!-- Indicador de consultas pendentes (se houver) -->
      <div id="consultas-pendentes-badge" 
           style="display:none; position:relative; cursor:pointer;"
           onclick="abrirMenuDrawer(); setTimeout(() => mostrarConsultasPendentes(), 350);"
           title="Consultas pendentes - Clique para ver">
        <div style="width:32px; height:32px; background:#f44336; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
          <span id="consultas-pendentes-count">0</span>
        </div>
      </div>
      <button class="btn-fechar" onclick="fecharChat()" title="Fechar">‚úï</button>
    </div>
  </div>
  
  <!-- Status -->
  <div id="chat-status" class="chat-status"></div>
  
  <!-- √Årea de mensagens -->
  <div id="chat-messages" class="chat-messages">
    <div class="chat-message assistente">
      <span class="chat-message-header">ü§ñ mAIke</span>
      <div class="chat-message-content">
        Ol√°, eu sou a Maike, assistente de COMEX da Make Consultores. üëã Como posso ajud√°-lo hoje? Voc√™ pode me perguntar sobre processos, criar DUIMPs ou consultar status de documentos.<br><br>üí° Se precisar de ajuda, √© s√≥ pedir!
      </div>
      <div class="chat-message-time" id="initial-message-time"></div>
    </div>
  </div>
  
  <!-- ‚úÖ Modal de Configura√ß√£o -->
  <div id="modal-config">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è Configura√ß√µes</h2>
        <button class="modal-close" onclick="fecharModalConfig()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <label for="email-sender-input">Email de Envio:</label>
        <input type="email" 
               id="email-sender-input" 
               placeholder="exemplo@makeconsultores.com.br"
               onkeypress="if(event.key==='Enter') salvarEmailSender()">
        <p class="modal-help">Email remetente para envio de emails</p>

        <label for="email-mailbox-input" style="margin-top: 12px;">Caixa de Leitura (Microsoft 365):</label>
        <input type="email"
               id="email-mailbox-input"
               placeholder="ex: maffra@makeconsultores.com.br"
               onkeypress="if(event.key==='Enter') salvarEmailSender()">
        <p class="modal-help">Mailbox lida pelo mAIke via Microsoft Graph (pode ser diferente do email de envio)</p>
        
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
        
        <label for="mercante-user-input">CPF Mercante:</label>
        <input type="text" 
               id="mercante-user-input" 
               placeholder="Ex: 07969797741"
               onkeypress="if(event.key==='Enter') salvarConfigMercante()">
        <p class="modal-help">CPF para login no Mercante (renova√ß√£o a cada 20 dias)</p>
        
        <label for="mercante-pass-input">Senha Mercante:</label>
        <input type="password" 
               id="mercante-pass-input" 
               placeholder="Deixe em branco para manter senha atual"
               onkeypress="if(event.key==='Enter') salvarConfigMercante()">
        <p class="modal-help">Senha do Mercante (opcional - deixe em branco para manter atual)</p>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
        <h3 style="margin-bottom: 12px; color: #075e54; font-size: 16px;">üåê Conectividade e Rede</h3>

        <label for="sql-mode-select">Ambiente SQL Server:</label>
        <select id="sql-mode-select" class="modal-input" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 12px;">
          <option value="auto">Auto (Detectar Escrit√≥rio/VPN)</option>
          <option value="office">Escrit√≥rio (172.16.10.8)</option>
          <option value="vpn">VPN (172.16.20.10)</option>
          <option value="legacy">Legado (Configura√ß√£o padr√£o)</option>
        </select>
        <p class="modal-help">For√ßa a conex√£o por um caminho espec√≠fico se o autom√°tico falhar.</p>

        <label for="kanban-url-input" style="margin-top: 12px;">URL API Kanban:</label>
        <input type="text" 
               id="kanban-url-input" 
               placeholder="http://172.16.10.211:5000/api/kanban/pedidos"
               onkeypress="if(event.key==='Enter') salvarConfigRede()">
        <p class="modal-help">Endere√ßo do servi√ßo de pedidos do Kanban.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalConfig()">Cancelar</button>
        <button class="modal-btn modal-btn-save" onclick="salvarTodasConfigs()">Salvar Tudo</button>
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Modal de Sincroniza√ß√£o Banc√°ria -->
  <div id="modal-sync-banco">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>üí∞ Sincronizar Extratos Banc√°rios</h2>
        <button class="modal-close" onclick="fecharModalSincronizarBanco()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="modal-help" style="margin-bottom: 16px; color: #666; font-size: 13px;">
          Sincroniza extratos banc√°rios para o banco de dados. Duplicatas s√£o detectadas automaticamente.
        </p>
        
        <label for="banco-conta-select">Conta:</label>
        <select id="banco-conta-select" class="modal-input" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 16px;">
          <option value="">Carregando contas...</option>
        </select>
        <p class="modal-help" style="margin-top: -12px; margin-bottom: 12px; font-size: 11px; color: #999;">
          üí° As contas s√£o carregadas do .env. Para Santander, a API j√° est√° vinculada √† conta. Use "Conta Personalizada" para outras contas do BB.
        </p>
        
        <div id="banco-conta-custom" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <label for="banco-agencia-input">Ag√™ncia:</label>
            <input type="text" id="banco-agencia-input" class="modal-input" placeholder="Ex: 1251" style="width: 100%;">
          </div>
          <div>
            <label for="banco-conta-input">Conta:</label>
            <input type="text" id="banco-conta-input" class="modal-input" placeholder="Ex: 50483" style="width: 100%;">
          </div>
        </div>
        
        <label for="banco-dias-input">√öltimos N dias (padr√£o: 7):</label>
        <input type="number" id="banco-dias-input" class="modal-input" placeholder="7" value="7" min="1" max="90" style="width: 100%; margin-bottom: 16px;">
        
        <div id="banco-sync-status" style="margin-top: 12px; padding: 8px; border-radius: 6px; display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalSincronizarBanco()">Cancelar</button>
        <button class="modal-btn modal-btn-save" onclick="sincronizarExtratoBancario()" id="banco-sync-btn">üîÑ Sincronizar</button>
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Menu Lateral (Drawer) Moderno -->
  <div id="menu-drawer-overlay" onclick="fecharMenuDrawer()"></div>
  <div id="menu-drawer">
    <div class="menu-drawer-header">
      <div class="menu-drawer-title">
        <span>ü§ñ</span>
        <span>Menu mAIke</span>
      </div>
      <button class="menu-drawer-close" onclick="fecharMenuDrawer()" title="Fechar">‚úï</button>
    </div>
    <div class="menu-drawer-body">
      <!-- Se√ß√£o: Banc√°rio -->
      <div class="menu-section">
        <div class="menu-section-title">üí∞ Financeiro</div>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => abrirModalSincronizarBanco(), 350);">
          <div class="menu-item-icon">üí∞</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Sincronizar Extratos</div>
            <div class="menu-item-desc">Importar lan√ßamentos banc√°rios</div>
          </div>
        </a>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => abrirModalConciliacao(), 350);">
          <div class="menu-item-icon">üìã</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Concilia√ß√£o Banc√°ria</div>
            <div class="menu-item-desc">Classificar lan√ßamentos por despesa</div>
          </div>
        </a>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => abrirModalHistoricoPagamentos(), 350);">
          <div class="menu-item-icon">üí≥</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Hist√≥rico de Pagamentos</div>
            <div class="menu-item-desc">Ver todos os pagamentos realizados</div>
          </div>
        </a>
      </div>
      
      <!-- Se√ß√£o: Documentos -->
      <div class="menu-section">
        <div class="menu-section-title">üìÑ Documentos</div>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => abrirModalImportarLegislacao(), 350);">
          <div class="menu-item-icon">üìö</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Importar Legisla√ß√£o</div>
            <div class="menu-item-desc">Copiar/colar textos de legisla√ß√£o</div>
          </div>
        </a>
      </div>
      
      <!-- Se√ß√£o: Sistema -->
      <div class="menu-section">
        <div class="menu-section-title">‚öôÔ∏è Sistema</div>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => abrirModalConfig(), 350);">
          <div class="menu-item-icon">‚öôÔ∏è</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Configura√ß√µes</div>
            <div class="menu-item-desc">Ajustes e prefer√™ncias</div>
          </div>
        </a>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => abrirModalStatusAtualizacoes(), 350);">
          <div class="menu-item-icon">üîÑ</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Status de Atualiza√ß√µes</div>
            <div class="menu-item-desc">Kanban e rotinas autom√°ticas</div>
          </div>
        </a>
        <a href="#" class="menu-item" id="menu-item-consultas-pendentes" style="display:none;" onclick="event.preventDefault(); fecharMenuDrawer(); setTimeout(() => mostrarConsultasPendentes(), 350);">
          <div class="menu-item-icon">üîî</div>
          <div class="menu-item-content">
            <div class="menu-item-title">Consultas Pendentes</div>
            <div class="menu-item-desc">Aprovar ou rejeitar consultas</div>
          </div>
          <div class="menu-item-badge" id="menu-badge-count">0</div>
        </a>
      </div>
      
      <!-- Se√ß√£o: Ajuda -->
      <div class="menu-section">
        <div class="menu-section-title">üí° Ajuda</div>
        <a href="#" class="menu-item" onclick="event.preventDefault(); fecharMenuDrawer(); enviarMensagem('o que voce pode fazer?');">
          <div class="menu-item-icon">üí¨</div>
          <div class="menu-item-content">
            <div class="menu-item-title">O que posso fazer?</div>
            <div class="menu-item-desc">Perguntar ao mAIke sobre funcionalidades</div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal: Status de Atualiza√ß√µes (Kanban, etc.) -->
  <div id="modal-status-atualizacoes">
    <div class="modal-content" style="max-width: 560px;">
      <div class="modal-header">
        <h2>üîÑ Status de Atualiza√ß√µes</h2>
        <button class="modal-close" onclick="fecharModalStatusAtualizacoes()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="modal-help" style="margin-bottom: 12px; color: #666; font-size: 13px;">
          Mostra se as rotinas autom√°ticas est√£o atualizando o cache (ex.: Kanban) e quando foi a √∫ltima execu√ß√£o.
        </p>
        <div id="status-atualizacoes-body" style="padding: 10px; border: 1px solid #e9edef; border-radius: 8px; background: #f8f9fa; font-size: 13px; color: #333;">
          Carregando...
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalStatusAtualizacoes()">Fechar</button>
        <button class="modal-btn modal-btn-save" id="btn-sync-kanban" onclick="dispararSyncKanban()">üîÑ Sincronizar Kanban</button>
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Modal de Concilia√ß√£o/Classifica√ß√£o de Lan√ßamentos -->
  <div id="modal-conciliacao-lancamentos">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2>üìã Conciliar/Classificar Lan√ßamentos</h2>
        <button class="modal-close" onclick="fecharModalConciliacao()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="modal-help" style="margin-bottom: 16px; color: #666; font-size: 13px;">
          Classifique lan√ßamentos banc√°rios vinculando-os a tipos de despesa e processos. Um lan√ßamento pode ter m√∫ltiplas despesas de m√∫ltiplos processos.
        </p>
        
        <!-- ‚úÖ NOVO: Toggle para usar servi√ßo V2 (robusto) -->
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 6px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #666;">
            <input 
              type="checkbox" 
              id="toggle-servico-v2" 
              onchange="toggleServicoV2(this.checked)"
              style="cursor: pointer;"
            />
            <span>üîí Usar servi√ßo robusto (V2) - Valida√ß√µes rigorosas e auditoria</span>
          </label>
        </div>

        <!-- ‚úÖ NOVO (24/01/2026): Filtro para lan√ßamentos de impostos de importa√ß√£o (Siscomex/PUCOMEX) -->
        <div id="filtro-siscomex-container" style="margin-bottom: 12px; padding: 8px; background: #f0f7ff; border-radius: 6px; border: 1px solid #bbdefb;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #1565c0;">
            <input 
              type="checkbox" 
              id="filtro-impostos-siscomex" 
              onchange="atualizarListaConciliacao()" 
              style="cursor: pointer;"
            />
            <span>Mostrar apenas despesas de impostos de importa√ß√£o (Siscomex / PUCOMEX)</span>
          </label>
          <p style="margin-top: 4px; font-size: 11px; color: #1976d2;">
            Usa a detec√ß√£o autom√°tica da aplica√ß√£o (SISCOMEX/PUCOMEX) para facilitar a concilia√ß√£o manual quando n√£o houver sugest√£o autom√°tica.
          </p>
        </div>
        
        <!-- ‚úÖ NOVO: Abas para alternar entre n√£o classificados, classificados e sugest√µes -->
        <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #e0e0e0;">
          <button 
            id="tab-nao-classificados" 
            onclick="alternarAbaConciliacao('nao-classificados')"
            style="flex: 1; padding: 10px; background: #075e54; color: #fff; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
            ‚ö™ N√£o Classificados
          </button>
          <button 
            id="tab-classificados" 
            onclick="alternarAbaConciliacao('classificados')"
            style="flex: 1; padding: 10px; background: #e0e0e0; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
            ‚úÖ Classificados
          </button>
          <button 
            id="tab-sugestoes" 
            onclick="alternarAbaConciliacao('sugestoes')"
            style="flex: 1; padding: 10px; background: #e0e0e0; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; position: relative;">
            üí° Sugest√µes
            <span id="badge-sugestoes" style="display: none; position: absolute; top: 4px; right: 4px; background: #e74c3c; color: #fff; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: bold;">0</span>
          </button>
        </div>
        
        <!-- Lista de lan√ßamentos n√£o classificados -->
        <div id="conciliacao-lancamentos-lista" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
          <p style="text-align: center; color: #999; padding: 20px;">Carregando lan√ßamentos...</p>
        </div>
        
        <!-- ‚úÖ NOVO: Lista de lan√ßamentos classificados (oculta por padr√£o) -->
        <div id="conciliacao-lancamentos-classificados" style="display: none; max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
          <p style="text-align: center; color: #999; padding: 20px;">Carregando lan√ßamentos classificados...</p>
        </div>
        
        <!-- ‚úÖ NOVO (23/01/2026): Lista de sugest√µes de vincula√ß√£o (oculta por padr√£o) -->
        <div id="conciliacao-lancamentos-sugestoes" style="display: none; max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
          <p style="text-align: center; color: #999; padding: 20px;">Carregando sugest√µes de vincula√ß√£o...</p>
        </div>
        
        <div id="conciliacao-status" style="margin-top: 12px; padding: 8px; border-radius: 6px; display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalConciliacao()">Fechar</button>
        <button class="modal-btn modal-btn-save" onclick="atualizarListaConciliacao()" id="conciliacao-refresh-btn">
          <span style="display: inline-block; transition: transform 0.3s;" id="refresh-icon">üîÑ</span>
          <span>Atualizar</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Modal de Classifica√ß√£o Individual (ao clicar em um lan√ßamento) -->
  <div id="modal-classificar-lancamento">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>üìù Classificar Lan√ßamento</h2>
        <button class="modal-close" onclick="fecharModalClassificar()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="classificar-lancamento-info" style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px;">
          <!-- Informa√ß√µes do lan√ßamento ser√£o preenchidas aqui -->
        </div>
        
        <!-- ‚úÖ NOVO (24/01/2026): Se√ß√£o de Lastro Financeiro (Compliance IN 1986) -->
        <div id="secao-lastro-financeiro" style="display: none; margin-bottom: 16px; padding: 12px; background: #e8f5e9; border: 1px solid #2e7d32; border-radius: 6px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 18px;">‚öñÔ∏è</span>
            <strong style="color: #2e7d32; font-size: 14px;">Lastro Financeiro (IN 1986/2020)</strong>
          </div>
          <div id="lastro-info-corpo" style="font-size: 12px; color: #1b5e20;">
            Verificando saldo do cliente...
          </div>
        </div>
        
        <!-- ‚úÖ NOVO: Interface de distribui√ß√£o de impostos (oculta por padr√£o) -->
        <div id="distribuicao-impostos" style="display: none; margin-bottom: 16px; padding: 16px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 6px;">
          <div style="margin-bottom: 12px;">
            <strong style="color: #2e7d32; font-size: 14px;">üí∞ Distribuir Impostos de Importa√ß√£o</strong>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #555;">
              Distribua o valor total entre os tipos de imposto. Os valores sugeridos v√™m da DI/DUIMP do processo.
            </p>
          </div>
          <div id="impostos-lista" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- Impostos ser√£o adicionados aqui dinamicamente -->
          </div>
          <div id="impostos-total" style="margin-top: 12px; padding: 8px; background: #fff; border-radius: 4px; font-size: 13px; font-weight: bold;">
            <span>Total distribu√≠do: </span><span id="impostos-total-valor" style="color: #2e7d32;">R$ 0,00</span>
            <span> / </span><span id="impostos-total-lancamento" style="color: #e74c3c;"></span>
          </div>
          <div id="impostos-status" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
        </div>
        
        <!-- ‚úÖ CORRE√á√ÉO 3: Lista de despesas (split) -->
        <div id="classificacoes-container">
          <div id="classificacoes-lista" style="margin-bottom: 16px;">
            <!-- Despesas ser√£o adicionadas aqui dinamicamente -->
          </div>
          
          <!-- ‚úÖ NOVO: Sugest√£o autom√°tica de split (n√£o grava nada; usu√°rio confirma) -->
          <button
            type="button"
            onclick="sugerirSplitLancamento()"
            id="btn-sugerir-split"
            style="width: 100%; padding: 8px; background: #8e44ad; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; font-size: 14px;"
          >
            ‚ú® Sugerir split
          </button>

          <!-- ‚úÖ CORRE√á√ÉO 3: Bot√£o para adicionar nova despesa -->
          <button type="button" onclick="adicionarDespesa()" style="width: 100%; padding: 8px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 16px; font-size: 14px;">
            ‚ûï Adicionar Despesa
          </button>
        </div>
        
        <div id="classificar-status" style="margin-top: 12px; padding: 8px; border-radius: 6px; display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalClassificar()">Cancelar</button>
        <button class="modal-btn modal-btn-save" onclick="salvarClassificacao()" id="classificar-salvar-btn">üíæ Salvar Classifica√ß√µes</button>
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Modal de Hist√≥rico de Pagamentos -->
  <div id="modal-historico-pagamentos">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header">
        <h2>üí≥ Hist√≥rico de Pagamentos</h2>
        <button class="modal-close" onclick="fecharModalHistoricoPagamentos()" title="Fechar" style="background: rgba(0,0,0,0.05); border: none; font-size: 20px; cursor: pointer; color: #54656f; padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1); font-weight: 300;">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="modal-help" style="margin-bottom: 16px; color: #666; font-size: 13px;">
          Visualize todos os pagamentos realizados (BOLETO, PIX, TED). Dados salvos em SQL Server e cache local.
        </p>
        
        <!-- Filtros -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px;">
          <div>
            <label for="filtro-banco" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Banco:</label>
            <select id="filtro-banco" class="modal-input" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="filtrarHistoricoPagamentos()">
              <option value="">Todos</option>
              <option value="SANTANDER">Santander</option>
              <option value="BANCO_DO_BRASIL">Banco do Brasil</option>
            </select>
          </div>
          <div>
            <label for="filtro-ambiente" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ambiente:</label>
            <select id="filtro-ambiente" class="modal-input" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="filtrarHistoricoPagamentos()">
              <option value="">Todos</option>
              <option value="SANDBOX">Sandbox</option>
              <option value="PRODUCAO">Produ√ß√£o</option>
            </select>
          </div>
          <div>
            <label for="filtro-tipo" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Tipo:</label>
            <select id="filtro-tipo" class="modal-input" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="filtrarHistoricoPagamentos()">
              <option value="">Todos</option>
              <option value="BOLETO">Boleto</option>
              <option value="PIX">PIX</option>
              <option value="TED">TED</option>
              <option value="BARCODE">C√≥digo de Barras</option>
            </select>
          </div>
          <div>
            <label for="filtro-status" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Status:</label>
            <select id="filtro-status" class="modal-input" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="filtrarHistoricoPagamentos()">
              <option value="">Todos</option>
              <option value="READY_TO_PAY">Pronto para Pagar</option>
              <option value="PENDING_VALIDATION">Pendente</option>
              <option value="PAYED">Pago</option>
              <option value="CANCELLED">Cancelado</option>
              <option value="FAILED">Falhou</option>
            </select>
          </div>
          <div>
            <label for="filtro-data-inicio" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Data In√≠cio:</label>
            <input type="date" id="filtro-data-inicio" class="modal-input" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="filtrarHistoricoPagamentos()">
          </div>
          <div>
            <label for="filtro-data-fim" style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Data Fim:</label>
            <input type="date" id="filtro-data-fim" class="modal-input" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" onchange="filtrarHistoricoPagamentos()">
          </div>
        </div>
        
        <!-- Resumo -->
        <div id="historico-resumo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 12px; background: #e8f5e9; border-radius: 6px;">
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #2e7d32;" id="resumo-total">0</div>
            <div style="font-size: 11px; color: #666;">Total</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #2e7d32;" id="resumo-valor-total">R$ 0,00</div>
            <div style="font-size: 11px; color: #666;">Valor Total</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #1976d2;" id="resumo-pagos">0</div>
            <div style="font-size: 11px; color: #666;">Pagos</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #f57c00;" id="resumo-pendentes">0</div>
            <div style="font-size: 11px; color: #666;">Pendentes</div>
          </div>
        </div>
        
        <!-- Lista de pagamentos -->
        <div id="historico-pagamentos-lista" style="max-height: 500px; overflow-y: auto; margin-bottom: 16px;">
          <p style="text-align: center; color: #999; padding: 20px;">Carregando hist√≥rico...</p>
        </div>
        
        <div id="historico-status" style="margin-top: 12px; padding: 8px; border-radius: 6px; display: none;"></div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e0e0e0;">
        <button onclick="fecharModalHistoricoPagamentos()" style="background: #f0f0f0; color: #54656f; border: none; padding: 10px 20px; border-radius: 24px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f0f0f0'">
          <span style="font-size: 16px;">‚úï</span>
          <span>Fechar</span>
        </button>
        <button onclick="carregarHistoricoPagamentos()" id="historico-refresh-btn" style="background: #075e54; color: #fff; border: none; padding: 10px 20px; border-radius: 24px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#064e47'" onmouseout="this.style.background='#075e54'">
          <span style="display: inline-block; transition: transform 0.3s; font-size: 16px;" id="historico-refresh-icon">üîÑ</span>
          <span>Atualizar</span>
        </button>
        <button onclick="exportarHistoricoPagamentos()" style="background: #25d366; color: #fff; border: none; padding: 10px 20px; border-radius: 24px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#20ba5a'" onmouseout="this.style.background='#25d366'">
          <span style="font-size: 16px;">üì•</span>
          <span>Exportar</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Modal de Importa√ß√£o de Legisla√ß√£o -->
  <div id="modal-import-legislacao">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üìö Importar Legisla√ß√£o</h2>
        <button class="modal-close" onclick="fecharModalImportarLegislacao()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="modal-help" style="margin-bottom: 16px; color: #666; font-size: 13px;">
          Cole o texto completo da legisla√ß√£o abaixo e preencha os dados b√°sicos.
        </p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <label for="legislacao-tipo">Tipo do Ato:</label>
            <select id="legislacao-tipo" class="modal-input" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="IN">IN (Instru√ß√£o Normativa)</option>
              <option value="Decreto">Decreto</option>
              <option value="Lei">Lei</option>
              <option value="Lei Complementar">Lei Complementar</option>
              <option value="Portaria">Portaria</option>
              <option value="Resolu√ß√£o">Resolu√ß√£o</option>
            </select>
          </div>
          <div>
            <label for="legislacao-numero">N√∫mero:</label>
            <input type="text" id="legislacao-numero" class="modal-input" placeholder="Ex: 1984" style="width: 100%;">
          </div>
          <div>
            <label for="legislacao-ano">Ano:</label>
            <input type="number" id="legislacao-ano" class="modal-input" placeholder="Ex: 2020" min="1900" max="2100" style="width: 100%;">
          </div>
          <div>
            <label for="legislacao-orgao">√ìrg√£o (opcional):</label>
            <input type="text" id="legislacao-orgao" class="modal-input" placeholder="Ex: RFB, MF, PR (Presid√™ncia/Planalto)" style="width: 100%;">
          </div>
        </div>
        
        <label for="legislacao-texto">Texto da Legisla√ß√£o:</label>
        <div style="position: relative;">
          <textarea id="legislacao-texto" 
                    class="modal-input" 
                    placeholder="Cole aqui o texto completo da legisla√ß√£o (Ctrl+V ou Cmd+V)..."
                    rows="12"
                    onpaste="handlePasteLegislacao(event)"
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px; resize: vertical;"></textarea>
          <button type="button" 
                  onclick="limparFormatacaoTexto()"
                  style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 11px;"
                  title="Limpar formata√ß√£o extra (espa√ßos duplos, etc)">
            üßπ Limpar
          </button>
        </div>
        <p class="modal-help" style="margin-top: 4px; font-size: 12px; color: #666;">
          üí° <strong>Dica:</strong> Voc√™ pode colar diretamente do navegador (Ctrl+V / Cmd+V). 
          O sistema limpa automaticamente formata√ß√£o HTML extra.
        </p>
        
        <div id="legislacao-status" style="margin-top: 12px; padding: 8px; border-radius: 6px; display: none;"></div>

        <!-- ‚úÖ NOVO: A√ß√µes de RAG (File Search) ap√≥s importar -->
        <div id="legislacao-rag-actions" style="margin-top: 10px; display: none; padding: 10px; border: 1px dashed #bbb; border-radius: 8px; background: #fafafa;">
          <div id="legislacao-rag-hint" style="font-size: 12px; color: #666; margin-bottom: 8px;">
            üìå Para aparecer no RAG (Assistants/File Search), exporte e/ou vetorize este ato.
          </div>
          <div id="legislacao-rag-status" style="display:none; margin-bottom: 10px; padding: 8px; border-radius: 6px; font-size: 12px;"></div>
          <div style="display: flex; gap: 8px;">
            <button type="button" id="legislacao-export-rag-btn"
              onclick="exportarLegislacaoParaRag()"
              style="flex: 1; padding: 8px; background: #607d8b; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
              üìå Exportar p/ RAG
            </button>
            <button type="button" id="legislacao-vetorizar-rag-btn"
              onclick="vetorizarLegislacaoParaRag()"
              style="flex: 1; padding: 8px; background: #6a1b9a; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
              üß† Vetorizar agora
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalImportarLegislacao()">Cancelar</button>
        <button class="modal-btn modal-btn-save" onclick="importarLegislacao()" id="legislacao-import-btn">Importar</button>
      </div>
    </div>
  </div>
  
  <!-- Input -->
  <div class="chat-input-area">
    <form id="chat-form" onsubmit="return enviarMensagemChat(event);">
      <button type="button" class="chat-attach-btn" id="chat-attach-btn" title="Anexar arquivo">üìé</button>
      <button type="button" class="chat-mic-btn" id="chat-mic-btn" title="Gravar mensagem de voz">üé§</button>
      <input 
        type="file" 
        id="chat-file-input" 
        accept=".pdf"
        style="display: none;"
      />
      <input 
        type="text" 
        id="chat-input" 
        class="chat-input"
        placeholder="Digite sua mensagem..." 
        autocomplete="off"
        autofocus
      />
      <button type="submit" class="chat-send-btn" id="chat-send-btn">‚û§</button>
    </form>
  </div>
  
  <!-- ‚úÖ NOVO (13/01/2026): Modal de Aprova√ß√£o de Pagamento de Boleto -->
  <div id="modal-aprovar-boleto">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>üí≥ Aprovar Pagamento de Boleto</h2>
        <button class="modal-close" onclick="fecharModalAprovacaoBoleto()" title="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="boleto-dados-aprovacao" style="margin-bottom: 16px;">
          <!-- Dados do boleto ser√£o preenchidos aqui -->
        </div>
        <div id="boleto-status-aprovacao" style="margin-top: 12px; padding: 8px; border-radius: 6px; display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="fecharModalAprovacaoBoleto()">Cancelar</button>
        <button class="modal-btn modal-btn-save" onclick="confirmarPagamentoBoleto()" id="aprovar-boleto-btn">‚úÖ Confirmar e Pagar</button>
      </div>
    </div>
  </div>
  
  <script>
    let chatHistorico = [];
    
    // ‚úÖ NOVO: Fun√ß√£o para atualizar indicador do modelo no cabe√ßalho
    function atualizarIndicadorModelo(modelo) {
      const indicator = document.getElementById('modelo-indicator');
      if (indicator) {
        // Mostrar modelo completo (n√£o abreviado) para refletir o que est√° realmente sendo usado
        indicator.textContent = modelo || 'gpt-3.5-turbo';
        indicator.title = `Modelo LLM em uso: ${modelo || 'gpt-3.5-turbo'}`;
      }
    }
    
    // ‚úÖ NOVO: Carregar modelo salvo e atualizar indicador ao iniciar
    async function carregarModeloInicial() {
      try {
        // ‚úÖ PRIORIDADE 1: Buscar modelo real do backend (do .env)
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          if (config.model) {
            // ‚úÖ Atualizar indicador com modelo do backend
            atualizarIndicadorModelo(config.model);
            // ‚úÖ Sincronizar localStorage com modelo do backend (para manter consist√™ncia)
            localStorage.setItem('chat-ia-model', config.model);
            console.log('‚úÖ Modelo carregado do backend:', config.model);
            return;
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao buscar modelo do backend:', error);
      }
      
      // ‚úÖ FALLBACK: usar modelo do localStorage ou padr√£o (apenas se backend falhar)
      const modelSalvo = localStorage.getItem('chat-ia-model');
      const modelFinal = modelSalvo || 'gpt-3.5-turbo';
      atualizarIndicadorModelo(modelFinal);
      console.log('‚ö†Ô∏è Usando modelo do localStorage ou padr√£o:', modelFinal);
    }
    
    // ‚úÖ NOVO: Carregar PTAX e atualizar indicador no cabe√ßalho
    // Mostra PTAX para registro HOJE e AMANH√É (para decis√£o de quando registrar)
    async function carregarPTAX() {
      try {
        const response = await fetch('/api/ptax');
        if (response.ok) {
          const data = await response.json();
          const ptaxIndicator = document.getElementById('ptax-indicator');
          
          if (ptaxIndicator) {
            // Priorizar: registro_hoje e registro_amanha (para decis√£o de registro)
            const ptaxHoje = data.registro_hoje && data.registro_hoje.sucesso && data.registro_hoje.cotacao_venda 
              ? parseFloat(data.registro_hoje.cotacao_venda).toFixed(4) 
              : null;
            const ptaxAmanha = data.registro_amanha && data.registro_amanha.sucesso && data.registro_amanha.cotacao_venda 
              ? parseFloat(data.registro_amanha.cotacao_venda).toFixed(4) 
              : null;
            
            if (ptaxHoje && ptaxAmanha) {
              // Mostrar ambas as cota√ß√µes: HOJE | AMANH√É
              ptaxIndicator.textContent = `PTAX: R$ ${ptaxHoje} | R$ ${ptaxAmanha}`;
              ptaxIndicator.title = `PTAX para registro HOJE: R$ ${ptaxHoje} (${data.registro_hoje.data_util || 'hoje'}) | AMANH√É: R$ ${ptaxAmanha} (${data.registro_amanha.data_util || 'amanh√£'})`;
            } else if (ptaxHoje) {
              // Apenas hoje dispon√≠vel
              ptaxIndicator.textContent = `PTAX: R$ ${ptaxHoje}`;
              ptaxIndicator.title = `PTAX para registro HOJE: R$ ${ptaxHoje} (${data.registro_hoje.data_util || 'hoje'})`;
            } else if (ptaxAmanha) {
              // Apenas amanh√£ dispon√≠vel
              ptaxIndicator.textContent = `PTAX: R$ ${ptaxAmanha}`;
              ptaxIndicator.title = `PTAX para registro AMANH√É: R$ ${ptaxAmanha} (${data.registro_amanha.data_util || 'amanh√£'})`;
            } else {
              // Fallback: tentar mercado_hoje (somente informativa)
              const ptaxMercado = data.mercado_hoje && data.mercado_hoje.sucesso && data.mercado_hoje.cotacao_venda 
                ? parseFloat(data.mercado_hoje.cotacao_venda).toFixed(4) 
                : null;
              
              if (ptaxMercado) {
                ptaxIndicator.textContent = `PTAX: R$ ${ptaxMercado}`;
                ptaxIndicator.title = `PTAX de mercado hoje: R$ ${ptaxMercado} (somente informativa)`;
              } else {
                ptaxIndicator.textContent = 'PTAX: --';
                ptaxIndicator.title = 'PTAX n√£o dispon√≠vel';
              }
            }
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao carregar PTAX:', error);
        const ptaxIndicator = document.getElementById('ptax-indicator');
        if (ptaxIndicator) {
          ptaxIndicator.textContent = 'PTAX: --';
          ptaxIndicator.title = 'Erro ao carregar PTAX';
        }
      }
    }
    
    // ‚úÖ Fun√ß√µes do Modal de Importa√ß√£o de Legisla√ß√£o
    function abrirModalImportarLegislacao() {
      const modal = document.getElementById('modal-import-legislacao');
      if (modal) {
        modal.style.display = 'flex';
        // Limpar campos ao abrir
        document.getElementById('legislacao-tipo').value = 'IN';
        document.getElementById('legislacao-numero').value = '';
        document.getElementById('legislacao-ano').value = '';
        document.getElementById('legislacao-orgao').value = '';
        document.getElementById('legislacao-texto').value = '';
        document.getElementById('legislacao-status').style.display = 'none';
        document.getElementById('legislacao-import-btn').disabled = false;
      }
    }
    
    function fecharModalImportarLegislacao() {
      const modal = document.getElementById('modal-import-legislacao');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // ‚úÖ Fun√ß√£o para tratar colagem de texto (limpar HTML se houver)
    function handlePasteLegislacao(event) {
      // Aguardar um pouco para o texto ser colado
      setTimeout(() => {
        const textarea = document.getElementById('legislacao-texto');
        let texto = textarea.value;
        
        // Se parece ter HTML (tags HTML), tentar limpar
        if (texto.includes('<') && texto.includes('>')) {
          // Criar elemento tempor√°rio para extrair texto puro
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = texto;
          texto = tempDiv.textContent || tempDiv.innerText || texto;
          
          // Limpar espa√ßos m√∫ltiplos e quebras de linha excessivas
          texto = texto.replace(/\s+/g, ' ').replace(/\n\s*\n\s*\n/g, '\n\n');
          
          textarea.value = texto;
        }
      }, 10);
    }
    
    // ‚úÖ Fun√ß√£o para limpar formata√ß√£o do texto
    function limparFormatacaoTexto() {
      const textarea = document.getElementById('legislacao-texto');
      let texto = textarea.value;
      
      // Remover HTML se houver
      if (texto.includes('<') && texto.includes('>')) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = texto;
        texto = tempDiv.textContent || tempDiv.innerText || texto;
      }
      
      // Limpar espa√ßos m√∫ltiplos (mas manter quebras de linha)
      texto = texto.replace(/[ \t]+/g, ' ');
      
      // Limpar m√∫ltiplas quebras de linha (manter no m√°ximo 2)
      texto = texto.replace(/\n{3,}/g, '\n\n');
      
      // Limpar espa√ßos no in√≠cio/fim de linhas
      texto = texto.split('\n').map(line => line.trim()).join('\n');
      
      textarea.value = texto;
      
      // Feedback visual
      const statusDiv = document.getElementById('legislacao-status');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#e3f2fd';
      statusDiv.style.color = '#1565c0';
      statusDiv.textContent = '‚úÖ Formata√ß√£o limpa!';
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 2000);
    }
    
    async function importarLegislacao() {
      const tipo = document.getElementById('legislacao-tipo').value;
      const numero = document.getElementById('legislacao-numero').value.trim();
      const ano = document.getElementById('legislacao-ano').value.trim();
      const orgao = document.getElementById('legislacao-orgao').value.trim();
      let texto = document.getElementById('legislacao-texto').value.trim();
      
      // ‚úÖ Limpar formata√ß√£o antes de enviar (garantir texto limpo)
      if (texto.includes('<') && texto.includes('>')) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = texto;
        texto = tempDiv.textContent || tempDiv.innerText || texto;
      }
      
      // Limpar espa√ßos m√∫ltiplos (mas manter quebras de linha)
      texto = texto.replace(/[ \t]+/g, ' ');
      
      // Limpar m√∫ltiplas quebras de linha excessivas
      texto = texto.replace(/\n{3,}/g, '\n\n');
      const statusDiv = document.getElementById('legislacao-status');
      const importBtn = document.getElementById('legislacao-import-btn');
      const ragActions = document.getElementById('legislacao-rag-actions');
      const exportBtn = document.getElementById('legislacao-export-rag-btn');
      const vetorizarBtn = document.getElementById('legislacao-vetorizar-rag-btn');
      const ragStatus = document.getElementById('legislacao-rag-status');
      const ragHint = document.getElementById('legislacao-rag-hint');

      // Reset a√ß√µes RAG
      window.__lastLegislacaoImportId = null;
      if (ragActions) ragActions.style.display = 'none';
      if (exportBtn) exportBtn.disabled = false;
      if (vetorizarBtn) vetorizarBtn.disabled = false;
      if (ragStatus) { ragStatus.style.display = 'none'; ragStatus.innerHTML = ''; }
      if (ragHint) ragHint.style.display = 'block';
      
      // Valida√ß√£o
      if (!tipo || !numero || !ano || !texto) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.textContent = '‚ùå Preencha todos os campos obrigat√≥rios (Tipo, N√∫mero, Ano e Texto)';
        return;
      }
      
      // Validar ano
      const anoNum = parseInt(ano);
      if (isNaN(anoNum) || anoNum < 1900 || anoNum > 2100) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.textContent = '‚ùå Ano inv√°lido (deve ser entre 1900 e 2100)';
        return;
      }
      
      // Mostrar loading
      importBtn.disabled = true;
      importBtn.textContent = 'Importando...';
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#e3f2fd';
      statusDiv.style.color = '#1565c0';
      statusDiv.textContent = '‚è≥ Importando legisla√ß√£o...';
      
      try {
        const response = await fetch('/api/legislacao/importar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tipo_ato: tipo,
            numero: numero,
            ano: anoNum,
            sigla_orgao: orgao || null,
            texto: texto,
          }),
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
          statusDiv.style.background = '#e8f5e9';
          statusDiv.style.color = '#2e7d32';
          statusDiv.innerHTML = `‚úÖ <strong>Legisla√ß√£o importada com sucesso!</strong><br>ID: ${data.legislacao_id || 'N/A'}<br>Trechos: ${data.trechos_importados || 0}<br><span style="font-size:12px;color:#555;">üí° Agora voc√™ pode exportar/vetorizar para o RAG.</span>`;

          // Guardar ID para a√ß√µes de RAG
          window.__lastLegislacaoImportId = data.legislacao_id || null;
          if (window.__lastLegislacaoImportId && ragActions) {
            ragActions.style.display = 'block';
          }

          // Reabilitar bot√£o (permitir importar outro ato sem fechar o modal)
          importBtn.disabled = false;
          importBtn.textContent = 'Importar';

          // Adicionar mensagem no chat
          adicionarMensagemChat('mAIke', `‚úÖ **${tipo} ${numero}/${ano}** importada com sucesso!<br>üìÑ Trechos importados: ${data.trechos_importados || 0}`);
        } else {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.textContent = `‚ùå Erro: ${data.erro || data.mensagem || 'Erro desconhecido'}`;
          importBtn.disabled = false;
          importBtn.textContent = 'Importar';
        }
      } catch (error) {
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.textContent = `‚ùå Erro ao importar: ${error.message}`;
        importBtn.disabled = false;
        importBtn.textContent = 'Importar';
      }
    }

    async function exportarLegislacaoParaRag() {
      const id = window.__lastLegislacaoImportId;
      const statusDiv = document.getElementById('legislacao-status');
      const exportBtn = document.getElementById('legislacao-export-rag-btn');
      const vetorizarBtn = document.getElementById('legislacao-vetorizar-rag-btn');
      const ragStatus = document.getElementById('legislacao-rag-status');
      const ragHint = document.getElementById('legislacao-rag-hint');
      if (!id) {
        alert('Nenhuma legisla√ß√£o rec√©m-importada para exportar.');
        return;
      }
      try {
        if (exportBtn) { exportBtn.disabled = true; exportBtn.textContent = '‚è≥ Exportando...'; }
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#e3f2fd';
          statusDiv.style.color = '#1565c0';
          statusDiv.textContent = '‚è≥ Exportando para arquivo do RAG...';
        }
        if (ragStatus) {
          ragStatus.style.display = 'block';
          ragStatus.style.background = '#e3f2fd';
          ragStatus.style.color = '#1565c0';
          ragStatus.innerHTML = '‚è≥ Exportando...';
        }
        if (vetorizarBtn) vetorizarBtn.disabled = true;
        const resp = await fetch(`/api/legislacao/${id}/exportar-rag`, { method: 'POST' });
        const data = await resp.json();
        if (!data.sucesso) {
          if (statusDiv) {
            statusDiv.style.background = '#ffebee';
            statusDiv.style.color = '#c62828';
            statusDiv.textContent = `‚ùå ${data.mensagem || data.erro || 'Falha ao exportar'}`;
          }
          if (ragStatus) {
            ragStatus.style.display = 'block';
            ragStatus.style.background = '#ffebee';
            ragStatus.style.color = '#c62828';
            ragStatus.innerHTML = `‚ùå <strong>Exportar p/ RAG</strong>: ${data.mensagem || data.erro || 'Falha ao exportar'}`;
          }
          return;
        }
        if (ragHint) ragHint.style.display = 'none';
        if (ragStatus) {
          ragStatus.style.display = 'block';
          ragStatus.style.background = '#e8f5e9';
          ragStatus.style.color = '#2e7d32';
          ragStatus.innerHTML =
            `‚úÖ <strong>Exportar p/ RAG</strong><br>` +
            `üìÑ Arquivo: <strong>${data.nome_arquivo || 'arquivo'}</strong><br>` +
            `${data.arquivo ? `üìÅ Caminho: <span style="font-family: monospace;">${data.arquivo}</span><br>` : ''}` +
            `<span style="color:#555;">Pronto para vetorizar.</span>`;
        }
      } catch (e) {
        console.error(e);
        if (statusDiv) {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.textContent = `‚ùå Erro ao exportar: ${e.message || e}`;
        }
        if (ragStatus) {
          ragStatus.style.display = 'block';
          ragStatus.style.background = '#ffebee';
          ragStatus.style.color = '#c62828';
          ragStatus.innerHTML = `‚ùå <strong>Exportar p/ RAG</strong>: ${e.message || e}`;
        }
      } finally {
        if (exportBtn) { exportBtn.disabled = false; exportBtn.textContent = 'üìå Exportar p/ RAG'; }
        if (vetorizarBtn) vetorizarBtn.disabled = false;
      }
    }

    async function vetorizarLegislacaoParaRag() {
      const id = window.__lastLegislacaoImportId;
      const statusDiv = document.getElementById('legislacao-status');
      const exportBtn = document.getElementById('legislacao-export-rag-btn');
      const vetorizarBtn = document.getElementById('legislacao-vetorizar-rag-btn');
      const ragStatus = document.getElementById('legislacao-rag-status');
      const ragHint = document.getElementById('legislacao-rag-hint');
      if (!id) {
        alert('Nenhuma legisla√ß√£o rec√©m-importada para vetorizar.');
        return;
      }
      try {
        if (vetorizarBtn) { vetorizarBtn.disabled = true; vetorizarBtn.textContent = '‚è≥ Vetorizando...'; }
        if (exportBtn) exportBtn.disabled = true;
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#e3f2fd';
          statusDiv.style.color = '#1565c0';
          statusDiv.textContent = '‚è≥ Vetorizando e enviando para o File Search...';
        }
        if (ragStatus) {
          ragStatus.style.display = 'block';
          ragStatus.style.background = '#e3f2fd';
          ragStatus.style.color = '#1565c0';
          ragStatus.innerHTML = '‚è≥ Vetorizando...';
        }
        const resp = await fetch(`/api/legislacao/${id}/vetorizar-rag`, { method: 'POST' });
        const data = await resp.json();
        if (!data.sucesso) {
          if (statusDiv) {
            statusDiv.style.background = '#ffebee';
            statusDiv.style.color = '#c62828';
            statusDiv.textContent = `‚ùå ${data.mensagem || data.erro || 'Falha ao vetorizar'}`;
          }
          if (ragStatus) {
            ragStatus.style.display = 'block';
            ragStatus.style.background = '#ffebee';
            ragStatus.style.color = '#c62828';
            ragStatus.innerHTML = `‚ùå <strong>Vetorizar agora</strong>: ${data.mensagem || data.erro || 'Falha ao vetorizar'}`;
          }
          return;
        }
        if (ragHint) ragHint.style.display = 'none';
        if (ragStatus) {
          ragStatus.style.display = 'block';
          ragStatus.style.background = '#e8f5e9';
          ragStatus.style.color = '#2e7d32';
          ragStatus.innerHTML =
            `‚úÖ <strong>Vetorizar agora</strong><br>` +
            `${data.arquivo ? `üìÑ Arquivo: <span style="font-family: monospace;">${data.arquivo}</span><br>` : ''}` +
            `${data.file_id ? `üÜî file_id: <span style="font-family: monospace;">${data.file_id}</span><br>` : ''}` +
            `${data.vector_store_id ? `üóÑÔ∏è vector_store_id: <span style="font-family: monospace;">${data.vector_store_id}</span><br>` : ''}` +
            `${data.assistant_id ? `ü§ñ assistant_id: <span style="font-family: monospace;">${data.assistant_id}</span><br>` : ''}` +
            `<span style="color:#555;">Arquivo enviado e associado ao File Search.</span>`;
        }
      } catch (e) {
        console.error(e);
        if (statusDiv) {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.textContent = `‚ùå Erro ao vetorizar: ${e.message || e}`;
        }
        if (ragStatus) {
          ragStatus.style.display = 'block';
          ragStatus.style.background = '#ffebee';
          ragStatus.style.color = '#c62828';
          ragStatus.innerHTML = `‚ùå <strong>Vetorizar agora</strong>: ${e.message || e}`;
        }
      } finally {
        if (vetorizarBtn) { vetorizarBtn.disabled = false; vetorizarBtn.textContent = 'üß† Vetorizar agora'; }
        if (exportBtn) exportBtn.disabled = false;
      }
    }
    
    // Fechar modal de legisla√ß√£o ao clicar fora ou pressionar ESC
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('modal-import-legislacao');
      if (modal && event.target === modal) {
        fecharModalImportarLegislacao();
      }
    });
    
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('modal-import-legislacao');
        if (modal && modal.style.display === 'flex') {
          fecharModalImportarLegislacao();
        }
      }
    });
    
    // ‚úÖ Fun√ß√µes do Modal de Configura√ß√£o
    function abrirModalConfig() {
      const modal = document.getElementById('modal-config');
      if (modal) {
        modal.style.display = 'flex';
        // Carregar configura√ß√µes ao abrir o modal
        carregarEmailSender();  // J√° carrega Mercante e Rede tamb√©m
        // Focar no input de email
        setTimeout(() => {
          const emailInput = document.getElementById('email-sender-input');
          if (emailInput) {
            emailInput.focus();
            emailInput.select();
          }
        }, 100);
      }
    }
    
    function fecharModalConfig() {
      const modal = document.getElementById('modal-config');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // ‚úÖ Modal: Status de Atualiza√ß√µes
    function abrirModalStatusAtualizacoes() {
      const modal = document.getElementById('modal-status-atualizacoes');
      if (modal) {
        modal.style.display = 'flex';
        carregarStatusAtualizacoes();
      }
    }
    
    function fecharModalStatusAtualizacoes() {
      const modal = document.getElementById('modal-status-atualizacoes');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    async function carregarStatusAtualizacoes() {
      const body = document.getElementById('status-atualizacoes-body');
      if (!body) return;
      
      // ‚úÖ NOVO: Se j√° estiver carregando, n√£o limpar o body para evitar flicker
      if (body.innerHTML.includes('üîÑ')) {
        // manter
      } else {
        body.textContent = 'Carregando...';
      }

      try {
        const response = await fetch('/api/system/sync-status');
        const data = await response.json();
        if (!response.ok || !data || data.sucesso !== true) {
          body.innerHTML = `‚ùå Falha ao carregar status.`;
          return;
        }
        const k = data.kanban || {};
        const pk = data.processos_kanban || {};
        
        // Determinar status real
        let badge = '‚ÑπÔ∏è sem dados';
        let badgeColor = '#666';
        
        if (k.last_error && !k.last_success_at) {
          badge = '‚ö†Ô∏è ERRO';
          badgeColor = '#c62828';
        } else if (k.last_attempt_at && (!k.last_success_at || k.last_attempt_at > k.last_success_at)) {
          // Se houve tentativa ap√≥s o √∫ltimo sucesso e n√£o h√° erro novo, est√° em andamento
          if (!k.last_error) {
            badge = '‚è≥ EM ANDAMENTO';
            badgeColor = '#f39c12';
          } else {
            // Se houve erro na tentativa atual, mas temos um sucesso anterior
            badge = '‚úÖ OK (com alerta)';
            badgeColor = '#2e7d32';
          }
        } else if (k.last_success_at) {
          badge = '‚úÖ OK';
          badgeColor = '#2e7d32';
        }
        
        // ‚úÖ CORRE√á√ÉO: S√≥ mostrar erro se ele for da √öLTIMA tentativa
        const mostrarErro = k.last_error && (k.last_attempt_at >= k.last_success_at || !k.last_success_at);
        const err = mostrarErro ? `<div style="margin-top:8px; color:#c62828;"><strong>Erro:</strong> ${k.last_error}</div>` : '';
        
        // Formatar datas (ISO ‚Üí dd/mm/yyyy HH:MM no hor√°rio de Bras√≠lia UTC-3)
        function fmtDt(iso) {
          if (!iso) return '‚Äî';
          try {
            let isoStr = String(iso).trim();
            if (isoStr && !isoStr.match(/[+-]\d{2}:\d{2}$/) && !isoStr.endsWith('Z')) {
              isoStr = isoStr + 'Z';
            }
            const dt = new Date(isoStr);
            if (isNaN(dt.getTime())) return iso;
            return dt.toLocaleString('pt-BR', { 
              timeZone: 'America/Sao_Paulo', 
              day: '2-digit', month: '2-digit', year: 'numeric',
              hour: '2-digit', minute: '2-digit', hour12: false
            });
          } catch { return iso; }
        }
        
        body.innerHTML =
          `<div><strong>Kanban:</strong> <span style="color:${badgeColor}; font-weight:bold;">${badge}</span></div>` +
          `<div style="margin-top:8px;"><strong>√öltima tentativa:</strong> ${fmtDt(k.last_attempt_at)}</div>` +
          `<div><strong>√öltimo sucesso:</strong> ${fmtDt(k.last_success_at)}</div>` +
          `<div><strong>Dura√ß√£o (ms):</strong> ${k.last_duration_ms ?? '‚Äî'}</div>` +
          `<div><strong>Processos retornados:</strong> ${k.last_count ?? '‚Äî'}</div>` +
          `<hr style="margin:10px 0; border:none; border-top:1px solid #e9edef;">` +
          `<div><strong>Cache (processos_kanban):</strong></div>` +
          `<div><strong>Total:</strong> ${pk.total ?? '‚Äî'}</div>` +
          `<div><strong>Atualizado em:</strong> ${pk.max_atualizado_em ? fmtDt(pk.max_atualizado_em) : '‚Äî'}</div>` +
          err;
      } catch (e) {
        body.innerHTML = `‚ùå Erro ao carregar status: ${e.message || e}`;
      }
    }
    
    async function dispararSyncKanban() {
      const btn = document.getElementById('btn-sync-kanban');
      const body = document.getElementById('status-atualizacoes-body');
      if (!btn || !body) return;
      
      // Desabilitar bot√£o e mostrar loading
      btn.disabled = true;
      btn.textContent = '‚è≥ Sincronizando...';
      body.innerHTML = '<div style="color:#075e54;">üîÑ Sincronizando Kanban... Aguarde.</div>';
      
      try {
        const response = await fetch('/api/system/sync-kanban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (response.ok && data.sucesso) {
          body.innerHTML = '<div style="color:#25D366; margin-bottom:8px;">‚úÖ Sincroniza√ß√£o conclu√≠da! Recarregando status...</div>';
          // Aguardar um pouco e recarregar status
          setTimeout(() => {
            carregarStatusAtualizacoes();
          }, 1000);
        } else {
          body.innerHTML = `<div style="color:#c62828;">‚ùå Erro: ${data.erro || data.mensagem || 'Falha na sincroniza√ß√£o'}</div>`;
        }
      } catch (e) {
        body.innerHTML = `<div style="color:#c62828;">‚ùå Erro ao sincronizar: ${e.message || e}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Sincronizar Kanban';
      }
    }
    
    // Fechar modal ao clicar fora dele ou pressionar ESC
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('modal-config');
      if (modal && event.target === modal) {
        fecharModalConfig();
      }
    });

    document.addEventListener('click', function(event) {
      const modal = document.getElementById('modal-status-atualizacoes');
      if (modal && event.target === modal) {
        fecharModalStatusAtualizacoes();
      }
    });
    
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('modal-config');
        if (modal && modal.style.display === 'flex') {
          fecharModalConfig();
        }
      }
    });

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('modal-status-atualizacoes');
        if (modal && modal.style.display === 'flex') {
          fecharModalStatusAtualizacoes();
        }
      }
    });
    
    // ============================================
    // ‚úÖ Menu Lateral (Drawer) - Funcionalidades
    // ============================================
    
    function abrirMenuDrawer() {
      const drawer = document.getElementById('menu-drawer');
      const overlay = document.getElementById('menu-drawer-overlay');
      
      if (drawer && overlay) {
        drawer.classList.add('drawer-open');
        overlay.classList.add('overlay-visible');
        
        // Prevenir scroll do body quando menu aberto
        document.body.style.overflow = 'hidden';
      }
    }
    
    function fecharMenuDrawer() {
      const drawer = document.getElementById('menu-drawer');
      const overlay = document.getElementById('menu-drawer-overlay');
      
      if (drawer && overlay) {
        drawer.classList.remove('drawer-open');
        overlay.classList.remove('overlay-visible');
        
        // Restaurar scroll do body
        document.body.style.overflow = '';
      }
    }
    
    // ‚úÖ Fechar menu ao pressionar ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const drawer = document.getElementById('menu-drawer');
        if (drawer && drawer.classList.contains('drawer-open')) {
          fecharMenuDrawer();
        }
      }
    });
    
    // ‚úÖ Atualizar badge de consultas pendentes no menu
    function atualizarMenuConsultasPendentes(count) {
      const menuItem = document.getElementById('menu-item-consultas-pendentes');
      const badge = document.getElementById('menu-badge-count');
      
      if (menuItem && badge) {
        if (count > 0) {
          menuItem.style.display = '';
          badge.textContent = count;
        } else {
          menuItem.style.display = 'none';
        }
      }
    }
    
    // ‚úÖ Fun√ß√µes do Modal de Sincroniza√ß√£o Banc√°ria
    async function abrirModalSincronizarBanco() {
      const modal = document.getElementById('modal-sync-banco');
      if (modal) {
        modal.style.display = 'flex';
        // Resetar campos
        document.getElementById('banco-dias-input').value = '7';
        document.getElementById('banco-sync-status').style.display = 'none';
        document.getElementById('banco-sync-status').innerHTML = '';
        
        // ‚úÖ Resetar bot√£o de sincroniza√ß√£o
        const syncBtn = document.getElementById('banco-sync-btn');
        if (syncBtn) {
          syncBtn.disabled = false;
          syncBtn.textContent = 'üîÑ Sincronizar';
        }
        
        // Carregar contas configuradas
        await carregarContasBancarias();
      }
    }
    
    async function carregarContasBancarias() {
      const select = document.getElementById('banco-conta-select');
      
      try {
        const response = await fetch('/api/config/contas-bancarias');
        const data = await response.json();
        
        if (data.success && data.contas && data.contas.length > 0) {
          // Limpar op√ß√µes antigas
          select.innerHTML = '';
          
          // Adicionar contas configuradas
          data.contas.forEach(conta => {
            const option = document.createElement('option');
            const valor = conta.banco === 'SANTANDER' 
              ? `SANTANDER|${conta.id}`
              : `${conta.agencia}|${conta.conta}`;
            option.value = valor;
            option.textContent = conta.nome;
            select.appendChild(option);
          });
          
          // Adicionar op√ß√£o de conta personalizada
          const optionCustom = document.createElement('option');
          optionCustom.value = '';
          optionCustom.textContent = 'Conta Personalizada';
          select.appendChild(optionCustom);
          
          // Selecionar primeira conta por padr√£o
          if (data.contas.length > 0) {
            select.value = select.options[0].value;
          }
          
          atualizarContaCustomizada();
        } else {
          // Se n√£o houver contas configuradas, mostrar apenas op√ß√£o personalizada
          select.innerHTML = '<option value="">Conta Personalizada</option>';
          document.getElementById('banco-conta-custom').style.display = 'grid';
        }
      } catch (error) {
        console.error('Erro ao carregar contas:', error);
        select.innerHTML = '<option value="">Conta Personalizada</option>';
        document.getElementById('banco-conta-custom').style.display = 'grid';
      }
    }
    
    function fecharModalSincronizarBanco() {
      const modal = document.getElementById('modal-sync-banco');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // ============================================
    // ‚úÖ Hist√≥rico de Pagamentos
    // ============================================
    
    let historicoPagamentosCache = [];
    let historicoPagamentosFiltrado = [];
    
    function abrirModalHistoricoPagamentos() {
      const modal = document.getElementById('modal-historico-pagamentos');
      if (modal) {
        modal.style.display = 'flex';
        // Resetar filtros
        const filtroBanco = document.getElementById('filtro-banco');
        const filtroAmbiente = document.getElementById('filtro-ambiente');
        const filtroTipo = document.getElementById('filtro-tipo');
        const filtroStatus = document.getElementById('filtro-status');
        const filtroDataInicio = document.getElementById('filtro-data-inicio');
        const filtroDataFim = document.getElementById('filtro-data-fim');
        
        if (filtroBanco) filtroBanco.value = '';
        if (filtroAmbiente) filtroAmbiente.value = '';
        if (filtroTipo) filtroTipo.value = '';
        if (filtroStatus) filtroStatus.value = '';
        if (filtroDataInicio) filtroDataInicio.value = '';
        if (filtroDataFim) filtroDataFim.value = '';
        
        // Carregar hist√≥rico
        carregarHistoricoPagamentos();
      }
    }
    
    function fecharModalHistoricoPagamentos() {
      const modal = document.getElementById('modal-historico-pagamentos');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    async function carregarHistoricoPagamentos() {
      const lista = document.getElementById('historico-pagamentos-lista');
      const status = document.getElementById('historico-status');
      const refreshBtn = document.getElementById('historico-refresh-btn');
      const refreshIcon = document.getElementById('historico-refresh-icon');
      
      if (lista) {
        lista.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Carregando hist√≥rico...</p>';
      }
      
      if (refreshIcon) {
        refreshIcon.style.transform = 'rotate(360deg)';
        setTimeout(() => {
          refreshIcon.style.transform = 'rotate(0deg)';
        }, 500);
      }
      
      try {
        const response = await fetch('/api/pagamentos/historico');
        const data = await response.json();
        
        if (data.sucesso && data.pagamentos) {
          historicoPagamentosCache = data.pagamentos;
          historicoPagamentosFiltrado = data.pagamentos;
          atualizarResumo(data.pagamentos);
          renderizarHistoricoPagamentos(data.pagamentos);
          
          if (status) {
            status.style.display = 'none';
          }
        } else {
          if (lista) {
            lista.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå ${data.erro || 'Erro ao carregar hist√≥rico'}</p>`;
          }
        }
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        if (lista) {
          lista.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Erro ao carregar hist√≥rico: ${error.message}</p>`;
        }
      }
    }
    
    function filtrarHistoricoPagamentos() {
      const banco = document.getElementById('filtro-banco').value;
      const ambiente = document.getElementById('filtro-ambiente').value;
      const tipo = document.getElementById('filtro-tipo').value;
      const status = document.getElementById('filtro-status').value;
      const dataInicio = document.getElementById('filtro-data-inicio').value;
      const dataFim = document.getElementById('filtro-data-fim').value;
      
      historicoPagamentosFiltrado = historicoPagamentosCache.filter(p => {
        if (banco && p.banco !== banco) return false;
        if (ambiente && p.ambiente !== ambiente) return false;
        if (tipo && p.tipo_pagamento !== tipo) return false;
        if (status && p.status !== status) return false;
        if (dataInicio && p.data_efetivacao && p.data_efetivacao < dataInicio) return false;
        if (dataFim && p.data_efetivacao && p.data_efetivacao > dataFim) return false;
        return true;
      });
      
      atualizarResumo(historicoPagamentosFiltrado);
      renderizarHistoricoPagamentos(historicoPagamentosFiltrado);
    }
    
    function atualizarResumo(pagamentos) {
      const total = pagamentos.length;
      const valorTotal = pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0);
      const pagos = pagamentos.filter(p => p.status === 'PAYED').length;
      const pendentes = pagamentos.filter(p => p.status === 'READY_TO_PAY' || p.status === 'PENDING_VALIDATION').length;
      
      document.getElementById('resumo-total').textContent = total;
      document.getElementById('resumo-valor-total').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('resumo-pagos').textContent = pagos;
      document.getElementById('resumo-pendentes').textContent = pendentes;
    }
    
    function renderizarHistoricoPagamentos(pagamentos) {
      const lista = document.getElementById('historico-pagamentos-lista');
      if (!lista) return;
      
      if (pagamentos.length === 0) {
        lista.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhum pagamento encontrado.</p>';
        return;
      }
      
      lista.innerHTML = pagamentos.map(p => {
        const valor = parseFloat(p.valor) || 0;
        const dataEfetivacao = p.data_efetivacao ? new Date(p.data_efetivacao).toLocaleDateString('pt-BR') : '-';
        const dataInicio = p.data_inicio ? new Date(p.data_inicio).toLocaleDateString('pt-BR') : '-';
        
        const statusColors = {
          'PAYED': '#4caf50',
          'READY_TO_PAY': '#2196f3',
          'PENDING_VALIDATION': '#ff9800',
          'CANCELLED': '#9e9e9e',
          'FAILED': '#f44336'
        };
        
        const statusLabels = {
          'PAYED': '‚úÖ Pago',
          'READY_TO_PAY': '‚è≥ Pronto',
          'PENDING_VALIDATION': '‚è≥ Pendente',
          'CANCELLED': '‚ùå Cancelado',
          'FAILED': '‚ùå Falhou'
        };
        
        return `
          <div style="padding: 12px; margin-bottom: 8px; background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; transition: all 0.2s;" 
               onclick="toggleDetalhesPagamento('${p.payment_id}')"
               onmouseover="this.style.background='#f5f5f5'"
               onmouseout="this.style.background='#fff'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 4px;">
                  ${p.beneficiario || 'N/A'}
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${p.tipo_pagamento} ‚Ä¢ ${p.banco} ‚Ä¢ ${p.ambiente}
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: bold; font-size: 16px; color: #2e7d32; margin-bottom: 4px;">
                  R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
                <div style="font-size: 11px; padding: 2px 6px; background: ${statusColors[p.status] || '#999'}; color: #fff; border-radius: 12px; display: inline-block;">
                  ${statusLabels[p.status] || p.status}
                </div>
              </div>
            </div>
            <div style="font-size: 11px; color: #999; margin-top: 4px;">
              ${dataEfetivacao !== '-' ? `Efetivado: ${dataEfetivacao}` : `Iniciado: ${dataInicio}`}
            </div>
            <div id="detalhes-${p.payment_id}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0; font-size: 12px; color: #666;">
              <div style="margin-bottom: 4px;"><strong>Payment ID:</strong> ${p.payment_id}</div>
              ${p.codigo_barras ? `<div style="margin-bottom: 4px;"><strong>C√≥digo de Barras:</strong> ${p.codigo_barras}</div>` : ''}
              ${p.vencimento ? `<div style="margin-bottom: 4px;"><strong>Vencimento:</strong> ${p.vencimento}</div>` : ''}
              ${p.agencia_origem ? `<div style="margin-bottom: 4px;"><strong>Ag√™ncia/Conta:</strong> ${p.agencia_origem} / ${p.conta_origem || ''}</div>` : ''}
              ${p.saldo_disponivel_antes ? `<div style="margin-bottom: 4px;"><strong>Saldo Antes:</strong> R$ ${parseFloat(p.saldo_disponivel_antes).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>` : ''}
              ${p.saldo_apos_pagamento ? `<div style="margin-bottom: 4px;"><strong>Saldo Ap√≥s:</strong> R$ ${parseFloat(p.saldo_apos_pagamento).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>` : ''}
              ${p.observacoes ? `<div style="margin-bottom: 4px;"><strong>Observa√ß√µes:</strong> ${p.observacoes}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleDetalhesPagamento(paymentId) {
      const detalhes = document.getElementById(`detalhes-${paymentId}`);
      if (detalhes) {
        detalhes.style.display = detalhes.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    function exportarHistoricoPagamentos() {
      if (historicoPagamentosFiltrado.length === 0) {
        alert('Nenhum pagamento para exportar.');
        return;
      }
      
      const csv = [
        ['Payment ID', 'Tipo', 'Banco', 'Ambiente', 'Status', 'Valor', 'Benefici√°rio', 'Vencimento', 'Data In√≠cio', 'Data Efetiva√ß√£o', 'Ag√™ncia', 'Conta'].join(','),
        ...historicoPagamentosFiltrado.map(p => [
          p.payment_id,
          p.tipo_pagamento,
          p.banco,
          p.ambiente,
          p.status,
          p.valor,
          `"${(p.beneficiario || '').replace(/"/g, '""')}"`,
          p.vencimento || '',
          p.data_inicio || '',
          p.data_efetivacao || '',
          p.agencia_origem || '',
          p.conta_origem || ''
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `historico_pagamentos_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }
    
    // ============================================
    // ‚úÖ Menu Lateral (Drawer) - Funcionalidades
    // ============================================
    
    function abrirMenuDrawer() {
      const drawer = document.getElementById('menu-drawer');
      const overlay = document.getElementById('menu-drawer-overlay');
      
      if (drawer && overlay) {
        drawer.classList.add('drawer-open');
        overlay.classList.add('overlay-visible');
        
        // Prevenir scroll do body quando menu aberto
        document.body.style.overflow = 'hidden';
      }
    }
    
    function fecharMenuDrawer() {
      const drawer = document.getElementById('menu-drawer');
      const overlay = document.getElementById('menu-drawer-overlay');
      
      if (drawer && overlay) {
        drawer.classList.remove('drawer-open');
        overlay.classList.remove('overlay-visible');
        
        // Restaurar scroll do body
        document.body.style.overflow = '';
      }
    }
    
    // ‚úÖ Fechar menu ao pressionar ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        fecharMenuDrawer();
      }
    });
    
    // ‚úÖ Atualizar badge de consultas pendentes no menu
    function atualizarMenuConsultasPendentes(count) {
      const menuItem = document.getElementById('menu-item-consultas-pendentes');
      const badge = document.getElementById('menu-badge-count');
      
      if (menuItem && badge) {
        if (count > 0) {
          menuItem.style.display = '';
          badge.textContent = count;
        } else {
          menuItem.style.display = 'none';
        }
      }
    }
    
    // ============================================
    // ‚úÖ Modal de Concilia√ß√£o/Classifica√ß√£o de Lan√ßamentos
    // ============================================
    
    let lancamentoSelecionado = null;
    let tiposDespesa = [];
    let classificacoesAtuais = []; // ‚úÖ CORRE√á√ÉO 3: Armazenar m√∫ltiplas classifica√ß√µes (split)
    let distribuicaoImpostos = {}; // ‚úÖ NOVO: Armazenar distribui√ß√£o de impostos {II: 1000, IPI: 500, ...}
    let impostosConfirmados = false; // ‚úÖ NOVO: Flag se usu√°rio confirmou que s√£o impostos de importa√ß√£o
    let impostosSugeridos = []; // ‚úÖ NOVO: Impostos sugeridos da DI
    
    let abaConciliacaoAtiva = 'nao-classificados'; // ‚úÖ NOVO: Controlar aba ativa
    
    // ‚úÖ NOVO: Toggle para usar servi√ßo V2
    function toggleServicoV2(ativado) {
      localStorage.setItem('conciliacao_usar_v2', ativado ? 'true' : 'false');
      console.log(ativado ? 'üîí Servi√ßo V2 (robusto) ativado' : 'üìä Servi√ßo original ativado');
    }
    
    function abrirModalConciliacao() {
      const modal = document.getElementById('modal-conciliacao-lancamentos');
      if (modal) {
        modal.style.display = 'flex';
        abaConciliacaoAtiva = 'nao-classificados';
        alternarAbaConciliacao('nao-classificados');
        
        // ‚úÖ NOVO: Restaurar estado do toggle V2
        const toggleV2 = document.getElementById('toggle-servico-v2');
        if (toggleV2) {
          const usarV2 = localStorage.getItem('conciliacao_usar_v2') === 'true';
          toggleV2.checked = usarV2;
        }
        
        // ‚úÖ NOVO (23/01/2026): Atualizar badge de sugest√µes ao abrir modal
        atualizarBadgeSugestoes();
      }
    }
    
    // ‚úÖ NOVO (23/01/2026): Atualizar badge de sugest√µes pendentes
    async function atualizarBadgeSugestoes() {
      try {
        const response = await fetch('/api/banco/sugestoes-vinculacao?limite=1');
        const data = await response.json();
        
        const badge = document.getElementById('badge-sugestoes');
        if (badge) {
          if (data.sucesso && data.total > 0) {
            badge.textContent = data.total;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Erro ao atualizar badge de sugest√µes:', error);
      }
    }
    
    function fecharModalConciliacao() {
      const modal = document.getElementById('modal-conciliacao-lancamentos');
      if (modal) {
        modal.style.display = 'none';
      }
      lancamentoSelecionado = null;
      abaConciliacaoAtiva = 'nao-classificados';
    }
    
    // ‚úÖ NOVO: Alternar entre abas de concilia√ß√£o
    function alternarAbaConciliacao(aba) {
      abaConciliacaoAtiva = aba;
      
      const tabNaoClassificados = document.getElementById('tab-nao-classificados');
      const tabClassificados = document.getElementById('tab-classificados');
      const tabSugestoes = document.getElementById('tab-sugestoes');
      const listaNaoClassificados = document.getElementById('conciliacao-lancamentos-lista');
      const listaClassificados = document.getElementById('conciliacao-lancamentos-classificados');
      const listaSugestoes = document.getElementById('conciliacao-lancamentos-sugestoes');
      
      // Resetar todas as abas
      [tabNaoClassificados, tabClassificados, tabSugestoes].forEach(tab => {
        if (tab) {
          tab.style.background = '#e0e0e0';
          tab.style.color = '#666';
        }
      });
      
      // Esconder todas as listas
      [listaNaoClassificados, listaClassificados, listaSugestoes].forEach(lista => {
        if (lista) {
          lista.style.display = 'none';
        }
      });
      
      if (aba === 'nao-classificados') {
        // Ativar aba "N√£o Classificados"
        if (tabNaoClassificados) {
          tabNaoClassificados.style.background = '#075e54';
          tabNaoClassificados.style.color = '#fff';
        }
        if (listaNaoClassificados) {
          listaNaoClassificados.style.display = 'block';
        }
        carregarLancamentosNaoClassificados();
      } else if (aba === 'classificados') {
        // Ativar aba "Classificados"
        if (tabClassificados) {
          tabClassificados.style.background = '#075e54';
          tabClassificados.style.color = '#fff';
        }
        if (listaClassificados) {
          listaClassificados.style.display = 'block';
        }
        carregarLancamentosClassificados();
      } else if (aba === 'sugestoes') {
        // ‚úÖ NOVO: Ativar aba "Sugest√µes"
        if (tabSugestoes) {
          tabSugestoes.style.background = '#075e54';
          tabSugestoes.style.color = '#fff';
        }
        if (listaSugestoes) {
          listaSugestoes.style.display = 'block';
        }
        carregarSugestoesVinculacao();
      }
    }
    
    // ‚úÖ NOVO: Atualizar lista baseado na aba ativa
    function atualizarListaConciliacao() {
      // ‚úÖ Anima√ß√£o de rota√ß√£o no √≠cone de atualizar (estilo WhatsApp)
      const refreshIcon = document.getElementById('refresh-icon');
      const refreshBtn = document.getElementById('conciliacao-refresh-btn');
      
      if (refreshIcon && refreshBtn) {
        refreshIcon.style.transform = 'rotate(360deg)';
        refreshBtn.style.opacity = '0.8';
        refreshBtn.style.pointerEvents = 'none';
        
        setTimeout(() => {
          refreshIcon.style.transform = 'rotate(0deg)';
          refreshBtn.style.opacity = '1';
          refreshBtn.style.pointerEvents = 'auto';
        }, 500);
      }
      
      if (abaConciliacaoAtiva === 'nao-classificados') {
        carregarLancamentosNaoClassificados();
      } else if (abaConciliacaoAtiva === 'classificados') {
        carregarLancamentosClassificados();
      } else if (abaConciliacaoAtiva === 'sugestoes') {
        carregarSugestoesVinculacao();
      }
    }
    
    // ‚úÖ NOVO: Vari√°veis de pagina√ß√£o
    let paginaAtualNaoClassificados = 1;
    const itensPorPagina = 50;

    // ‚úÖ CORRE√á√ÉO (timezone): evitar "um dia pra tr√°s" ao renderizar YYYY-MM-DD
    // Observa√ß√£o: Date("2026-01-22") √© interpretado como UTC e em -03 vira 21/01.
    function formatarDataLancamento(dataMov) {
      if (!dataMov) return '';

      // Aceitar string ISO/date-only e sempre usar apenas a parte da data.
      const s = String(dataMov);
      const datePart = s.length >= 10 ? s.slice(0, 10) : s; // "YYYY-MM-DD"
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(datePart);
      if (m) {
        const y = parseInt(m[1], 10);
        const mo = parseInt(m[2], 10) - 1;
        const d = parseInt(m[3], 10);
        return new Date(y, mo, d).toLocaleDateString('pt-BR');
      }

      // Fallback: tenta parse normal
      const dt = new Date(s);
      if (!Number.isNaN(dt.getTime())) {
        return dt.toLocaleDateString('pt-BR');
      }
      return s;
    }
    
    async function carregarLancamentosNaoClassificados(page = 1) {
      const listaDiv = document.getElementById('conciliacao-lancamentos-lista');
      listaDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Carregando lan√ßamentos...</p>';
      
      paginaAtualNaoClassificados = page;
      
      try {
        // ‚úÖ NOVO (24/01/2026): Atualizar badge de sugest√µes sempre que carregar n√£o classificados
        atualizarBadgeSugestoes();

        // ‚úÖ NOVO (24/01/2026): Verificar filtro de impostos (Siscomex/PUCOMEX)
        const filtroSiscomexEl = document.getElementById('filtro-impostos-siscomex');
        const apenasImpostos = filtroSiscomexEl && filtroSiscomexEl.checked;

        // ‚úÖ Ajustar tamanho da p√°gina quando filtro de impostos estiver ativo (traz mais itens por vez)
        const perPage = apenasImpostos ? 200 : itensPorPagina;

        // ‚úÖ NOVO: Usar pagina√ß√£o em vez de limite fixo
        const response = await fetch(`/api/banco/lancamentos-nao-classificados?page=${page}&per_page=${perPage}`);
        const data = await response.json();

        // ‚úÖ CR√çTICO: se backend retornou erro, mostrar erro (n√£o "lista vazia")
        if (!data || data.sucesso !== true) {
          const msg = (data && (data.mensagem || data.erro)) ? (data.mensagem || data.erro) : 'Erro ao carregar lan√ßamentos';
          listaDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå ${msg}</p>`;
          return;
        }

        const lancamentosFonte = Array.isArray(data.lancamentos) ? data.lancamentos : [];
        const lancamentosFiltrados = apenasImpostos
          ? lancamentosFonte.filter(lanc => {
              const ehImposto = !!lanc.eh_possivel_imposto_importacao;
              const sinal = lanc.sinal || (lanc.valor < 0 ? '-' : '+');
              return ehImposto && sinal === '-';
            })
          : lancamentosFonte;
        
        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
        
        if (lancamentosFiltrados.length > 0) {
          lancamentosFiltrados.forEach(lanc => {
            const dataFormatada = formatarDataLancamento(lanc.data_movimentacao);
            const valorFormatado = new Intl.NumberFormat('pt-BR', {
              style: 'currency',
              currency: 'BRL'
            }).format(lanc.valor);
            
            // ‚úÖ CORRE√á√ÉO: Escapar descri√ß√£o corretamente e usar campos corretos
            const descricaoEscapada = (lanc.descricao || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
            const processoEscapado = (lanc.processo_vinculado || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            // ‚úÖ CORRE√á√ÉO: Usar campos corretos do objeto e mostrar sinal corretamente
            const sinal = lanc.sinal === '+' ? '+' : '-';
            const corValor = lanc.sinal === '+' ? '#27ae60' : '#e74c3c';
            
            // ‚úÖ CORRE√á√ÉO 1: Mostrar banco de origem (backend retorna 'banco', 'agencia', 'conta')
            const bancoInfo = (lanc.banco || lanc.banco_origem)
              ? `üè¶ ${lanc.banco || lanc.banco_origem || ''}${(lanc.agencia || lanc.agencia_origem) ? ` - Ag. ${lanc.agencia || lanc.agencia_origem}` : ''}${(lanc.conta || lanc.conta_origem) ? ` C/C ${lanc.conta || lanc.conta_origem}` : ''}`
              : '';
            
            // ‚úÖ NOVO: Armazenar objeto completo do lan√ßamento em data attribute
            const lancamentoJson = JSON.stringify(lanc).replace(/'/g, "&#39;").replace(/"/g, '&quot;');
            
            // ‚úÖ NOVO: Mostrar n√∫mero do documento se dispon√≠vel (ajuda a identificar duplicatas)
            const numeroDocInfo = lanc.numero_documento ? `<div style="color: #666; font-size: 10px; margin-top: 4px; font-family: monospace;">üìÑ Doc: ${lanc.numero_documento}</div>` : '';
            
            html += `
              <div style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; transition: background 0.2s;"
                   data-lancamento='${lancamentoJson}'
                   onclick="abrirModalClassificarCompleto(this)"
                   onmouseover="this.style.background='#f5f5f5'"
                   onmouseout="this.style.background='#fff'">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div>
                    <strong style="color: ${corValor};">${sinal}${valorFormatado}</strong>
                    <span style="color: #666; font-size: 12px; margin-left: 8px;">${dataFormatada}</span>
                  </div>
                  ${lanc.processo_vinculado ? `<span style="background: #3498db; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${lanc.processo_vinculado}</span>` : ''}
                </div>
                ${bancoInfo ? `<div style="color: #999; font-size: 11px; margin-bottom: 4px;">${bancoInfo}</div>` : ''}
                ${lanc.tipo && lanc.tipo !== 'N/A' ? `<div style="color: #666; font-size: 13px; margin-bottom: 4px;">${lanc.tipo}</div>` : ''}
                <div style="color: #999; font-size: 12px;">
                  ${lanc.descricao || 'Sem descri√ß√£o'}
                </div>
                ${numeroDocInfo}
                ${lanc.contrapartida && lanc.contrapartida.nome ? `<div style="color: #999; font-size: 11px; margin-top: 4px;">üë§ ${lanc.contrapartida.nome}</div>` : ''}
              </div>
            `;
          });
        } else {
          const mensagem = apenasImpostos
            ? '‚úÖ Nenhum lan√ßamento compat√≠vel com o filtro de impostos nesta p√°gina. Use a navega√ß√£o para ir para outra p√°gina ou remova o filtro.'
            : '‚úÖ Nenhum lan√ßamento n√£o classificado encontrado!';
          html += `<p style="text-align: center; color: #999; padding: 20px;">${mensagem}</p>`;
        }

        // ‚úÖ NOVO: Adicionar controles de pagina√ß√£o mesmo quando a p√°gina filtrada est√° vazia,
        // para permitir avan√ßar/voltar entre p√°ginas com o filtro ativo.
        if (data.total_pages > 1) {
          html += '<div style="margin-top: 20px; padding: 16px; background: #f5f5f5; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">';
          html += `<div style="color: #666; font-size: 13px;">P√°gina ${data.page} de ${data.total_pages} (${data.total} lan√ßamentos no total)</div>`;
          html += '<div style="display: flex; gap: 8px;">';
          
          // Bot√£o Anterior
          if (data.page > 1) {
            html += `<button onclick="carregarLancamentosNaoClassificados(${data.page - 1})" style="padding: 8px 16px; background: #075e54; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">‚Üê Anterior</button>`;
          } else {
            html += `<button disabled style="padding: 8px 16px; background: #ccc; color: #999; border: none; border-radius: 4px; font-size: 13px;">‚Üê Anterior</button>`;
          }
          
          // N√∫meros de p√°gina (mostrar at√© 5 p√°ginas)
          const inicioPagina = Math.max(1, data.page - 2);
          const fimPagina = Math.min(data.total_pages, data.page + 2);
          
          if (inicioPagina > 1) {
            html += `<button onclick="carregarLancamentosNaoClassificados(1)" style="padding: 8px 12px; background: #fff; color: #075e54; border: 1px solid #075e54; border-radius: 4px; cursor: pointer; font-size: 13px;">1</button>`;
            if (inicioPagina > 2) {
              html += `<span style="padding: 8px 4px; color: #999;">...</span>`;
            }
          }
          
          for (let p = inicioPagina; p <= fimPagina; p++) {
            if (p === data.page) {
              html += `<button disabled style="padding: 8px 12px; background: #075e54; color: #fff; border: none; border-radius: 4px; font-size: 13px; font-weight: bold;">${p}</button>`;
            } else {
              html += `<button onclick="carregarLancamentosNaoClassificados(${p})" style="padding: 8px 12px; background: #fff; color: #075e54; border: 1px solid #075e54; border-radius: 4px; cursor: pointer; font-size: 13px;">${p}</button>`;
            }
          }
          
          if (fimPagina < data.total_pages) {
            if (fimPagina < data.total_pages - 1) {
              html += `<span style="padding: 8px 4px; color: #999;">...</span>`;
            }
            html += `<button onclick="carregarLancamentosNaoClassificados(${data.total_pages})" style="padding: 8px 12px; background: #fff; color: #075e54; border: 1px solid #075e54; border-radius: 4px; cursor: pointer; font-size: 13px;">${data.total_pages}</button>`;
          }
          
          // Bot√£o Pr√≥xima
          if (data.page < data.total_pages) {
            html += `<button onclick="carregarLancamentosNaoClassificados(${data.page + 1})" style="padding: 8px 16px; background: #075e54; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Pr√≥xima ‚Üí</button>`;
          } else {
            html += `<button disabled style="padding: 8px 16px; background: #ccc; color: #999; border: none; border-radius: 4px; font-size: 13px;">Pr√≥xima ‚Üí</button>`;
          }
          
          html += '</div></div>';
        }
        
        html += '</div>';
        listaDiv.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar lan√ßamentos:', error);
        listaDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Erro ao carregar lan√ßamentos: ${error.message}</p>`;
      }
    }
    
    // ‚úÖ NOVO: Carregar lan√ßamentos classificados (para edi√ß√£o)
    async function carregarLancamentosClassificados() {
      const listaDiv = document.getElementById('conciliacao-lancamentos-classificados');
      if (!listaDiv) return;
      
      listaDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Carregando lan√ßamentos classificados...</p>';
      
      try {
        // ‚úÖ NOVO (24/01/2026): Atualizar badge de sugest√µes sempre que carregar classificados
        atualizarBadgeSugestoes();

        const response = await fetch('/api/banco/lancamentos-classificados?limite=50');
        const data = await response.json();

        // ‚úÖ CR√çTICO: se backend retornou erro, mostrar erro (n√£o "lista vazia")
        if (!data || data.sucesso !== true) {
          const msg = (data && (data.mensagem || data.erro)) ? (data.mensagem || data.erro) : 'Erro ao carregar lan√ßamentos classificados';
          listaDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå ${msg}</p>`;
          return;
        }
        
        if (data.lancamentos && data.lancamentos.length > 0) {
          let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
          
          data.lancamentos.forEach(lanc => {
            const dataFormatada = formatarDataLancamento(lanc.data_movimentacao);
            const valorFormatado = new Intl.NumberFormat('pt-BR', {
              style: 'currency',
              currency: 'BRL'
            }).format(lanc.valor);
            
            const sinal = lanc.sinal === '+' ? '+' : '-';
            const corValor = lanc.sinal === '+' ? '#27ae60' : '#e74c3c';
            
            const bancoInfo = lanc.banco
              ? `üè¶ ${lanc.banco}${lanc.agencia ? ` - Ag. ${lanc.agencia}` : ''}${lanc.conta ? ` C/C ${lanc.conta}` : ''}`
              : '';
            
            const lancamentoJson = JSON.stringify(lanc).replace(/'/g, "&#39;").replace(/"/g, '&quot;');
            
            // ‚úÖ NOVO: Mostrar n√∫mero do documento se dispon√≠vel
            const numeroDocInfo = lanc.numero_documento ? `<div style="color: #666; font-size: 10px; margin-top: 4px; font-family: monospace;">üìÑ Doc: ${lanc.numero_documento}</div>` : '';
            
            html += `
              <div style="padding: 12px; border: 1px solid #4caf50; border-radius: 6px; background: #f1f8f4; cursor: pointer; transition: background 0.2s; position: relative;"
                   data-lancamento='${lancamentoJson}'
                   onclick="editarLancamentoClassificado(this)"
                   onmouseover="this.style.background='#e8f5e9'"
                   onmouseout="this.style.background='#f1f8f4'">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div>
                    <strong style="color: ${corValor};">${sinal}${valorFormatado}</strong>
                    <span style="color: #666; font-size: 12px; margin-left: 8px;">${dataFormatada}</span>
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="background: #4caf50; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">‚úÖ Classificado</span>
                    <button onclick="event.stopPropagation(); desvincularLancamento(${lanc.id_movimentacao || lanc.id})" 
                            style="background: #e74c3c; color: #fff; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;"
                            title="Desvincular (remover todas as classifica√ß√µes)">
                      üîì Desvincular
                    </button>
                  </div>
                </div>
                ${bancoInfo ? `<div style="color: #999; font-size: 11px; margin-bottom: 4px;">${bancoInfo}</div>` : ''}
                ${lanc.processo_vinculado ? `<div style="color: #3498db; font-size: 12px; margin-bottom: 4px;">üìã Processo: <strong>${lanc.processo_vinculado}</strong></div>` : ''}
                <div style="color: #999; font-size: 12px;">
                  ${lanc.descricao || 'Sem descri√ß√£o'}
                </div>
                ${numeroDocInfo}
                <div style="position: absolute; top: 8px; right: 8px; color: #4caf50; font-size: 18px;" title="Clique para editar">‚úèÔ∏è</div>
              </div>
            `;
          });
          
          html += '</div>';
          listaDiv.innerHTML = html;
        } else {
          listaDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">‚ÑπÔ∏è Nenhum lan√ßamento classificado encontrado.</p>';
        }
      } catch (error) {
        console.error('Erro ao carregar lan√ßamentos classificados:', error);
        listaDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Erro ao carregar lan√ßamentos: ${error.message}</p>`;
      }
    }
    
    // ‚úÖ NOVO (23/01/2026): Carregar sugest√µes de vincula√ß√£o banc√°ria
    async function carregarSugestoesVinculacao() {
      const listaDiv = document.getElementById('conciliacao-lancamentos-sugestoes');
      if (!listaDiv) return;
      
      listaDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Carregando sugest√µes...</p>';
      
      try {
        // ‚úÖ NOVO (24/01/2026): Atualizar badge de sugest√µes
        atualizarBadgeSugestoes();

        const response = await fetch('/api/banco/sugestoes-vinculacao?limite=50');
        const data = await response.json();
        
        if (!data || data.sucesso !== true) {
          const msg = (data && (data.mensagem || data.erro)) ? (data.mensagem || data.erro) : 'Erro ao carregar sugest√µes';
          listaDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå ${msg}</p>`;
          return;
        }
        
        // Atualizar badge
        const badge = document.getElementById('badge-sugestoes');
        if (badge) {
          if (data.total > 0) {
            badge.textContent = data.total;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }
        
        if (data.sugestoes && data.sugestoes.length > 0) {
          let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
          
          data.sugestoes.forEach(sugestao => {
            const processoRef = sugestao.processo_referencia;
            const totalImpostos = new Intl.NumberFormat('pt-BR', {
              style: 'currency',
              currency: 'BRL'
            }).format(sugestao.total_impostos);
            
            const lancamento = sugestao.lancamento;
            const score = sugestao.score_confianca || 0;
            const scoreColor = score >= 90 ? '#27ae60' : score >= 70 ? '#f39c12' : '#e74c3c';
            
            html += `
              <div style="padding: 12px; border: 2px solid #3498db; border-radius: 6px; background: #ebf5fb; cursor: pointer; transition: background 0.2s;"
                   data-sugestao-id="${sugestao.id}"
                   onmouseover="this.style.background='#d6eaf8'"
                   onmouseout="this.style.background='#ebf5fb'">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div>
                    <strong style="color: #3498db; font-size: 16px;">${processoRef}</strong>
                    <span style="color: #666; font-size: 12px; margin-left: 8px;">${sugestao.tipo_documento} ${sugestao.numero_documento || 'N/A'}</span>
                  </div>
                  <span style="background: ${scoreColor}; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                    ${score}% confian√ßa
                  </span>
                </div>
                <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                  üí∞ Total Impostos: <strong style="color: #e74c3c;">${totalImpostos}</strong>
                </div>
                ${lancamento ? `
                  <div style="background: #fff; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                    <div style="color: #666; font-size: 12px; margin-bottom: 4px;">‚úÖ Lan√ßamento encontrado:</div>
                    <div style="color: #e74c3c; font-weight: bold;">-${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(lancamento.valor_movimentacao)}</div>
                    <div style="color: #999; font-size: 11px;">üìÖ ${new Date(lancamento.data_movimentacao).toLocaleDateString('pt-BR')}</div>
                    <div style="color: #999; font-size: 11px;">${lancamento.descricao_movimentacao || 'Sem descri√ß√£o'}</div>
                    ${lancamento.numero_documento ? `<div style="color: #666; font-size: 10px; font-family: monospace; margin-top: 4px;">üìÑ Doc: ${lancamento.numero_documento}</div>` : (lancamento.id_movimentacao ? `<div style="color: #666; font-size: 10px; font-family: monospace; margin-top: 4px;">üÜî ID: ${lancamento.id_movimentacao}</div>` : '')}
                  </div>
                ` : '<div style="color: #999; font-size: 12px;">‚ö†Ô∏è Lan√ßamento n√£o encontrado no banco</div>'}
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                  <button onclick="aplicarSugestao(${sugestao.id})" style="flex: 1; padding: 8px; background: #27ae60; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                    ‚úÖ Vincular
                  </button>
                  <button onclick="ignorarSugestao(${sugestao.id})" style="flex: 1; padding: 8px; background: #95a5a6; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    Ignorar
                  </button>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          
          // Bot√£o "Aplicar todas" se houver m√∫ltiplas sugest√µes
          if (data.total > 1) {
            html += `
              <div style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px; text-align: center;">
                <button onclick="aplicarTodasSugestoes()" style="padding: 10px 20px; background: #27ae60; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                  ‚úÖ Aplicar todas (${data.total})
                </button>
              </div>
            `;
          }
          
          listaDiv.innerHTML = html;
        } else {
          listaDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">‚úÖ Nenhuma sugest√£o pendente!</p>';
        }
      } catch (error) {
        console.error('Erro ao carregar sugest√µes:', error);
        listaDiv.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Erro ao carregar sugest√µes: ${error.message}</p>`;
      }
    }
    
    // ‚úÖ NOVO: Aplicar sugest√£o de vincula√ß√£o (busca impostos e abre modal de split)
    async function aplicarSugestao(sugestaoId) {
      try {
        // 1. Buscar dados da sugest√£o
        const responseSugestao = await fetch(`/api/banco/sugestoes-vinculacao?limite=100`);
        const dataSugestao = await responseSugestao.json();
        
        if (!dataSugestao.sucesso || !dataSugestao.sugestoes) {
          alert('‚ùå Erro ao buscar sugest√£o');
          return { sucesso: false };
        }
        
        const sugestao = dataSugestao.sugestoes.find(s => s.id === sugestaoId);
        if (!sugestao) {
          alert('‚ùå Sugest√£o n√£o encontrada');
          return { sucesso: false };
        }
        
        const processoRef = sugestao.processo_referencia;
        const lancamento = sugestao.lancamento;
        
        if (!lancamento || !lancamento.id_movimentacao) {
          alert('‚ùå Lan√ßamento n√£o encontrado na sugest√£o');
          return { sucesso: false };
        }
        
        // 2. Fechar modal de concilia√ß√£o
        fecharModalConciliacao();
        
        // 3. Abrir modal de classifica√ß√£o com o lan√ßamento
        abrirModalClassificar({
          id_movimentacao: lancamento.id_movimentacao,
          valor: lancamento.valor_movimentacao,
          descricao_movimentacao: lancamento.descricao_movimentacao || 'Importa√ß√£o siscomex',
          processo_referencia: processoRef,
          processo_vinculado: processoRef, // ‚úÖ Garantir que processo est√° preenchido
          processo: processoRef, // ‚úÖ M√∫ltiplos campos para garantir compatibilidade
          eh_possivel_imposto_importacao: true, // ‚úÖ Sempre marcar como poss√≠vel imposto
          requer_confirmacao: true
        });
        
        // 4. Aguardar um pouco para o modal abrir e ent√£o buscar impostos automaticamente
        setTimeout(async () => {
          // Marcar checkbox de impostos
          const checkbox = document.getElementById('confirmar-impostos-importacao');
          if (checkbox) {
            checkbox.checked = true;
            // ‚úÖ Garantir que processo est√° no lan√ßamento selecionado antes de buscar
            if (lancamentoSelecionado) {
              lancamentoSelecionado.processo = processoRef;
            }
            await toggleDistribuicaoImpostos(); // Isso vai buscar os impostos automaticamente
          }
        }, 500); // ‚úÖ Aumentar delay para garantir que modal est√° totalmente renderizado
        
        return { sucesso: true };
      } catch (error) {
        console.error('Erro ao aplicar sugest√£o:', error);
        alert(`‚ùå Erro ao aplicar sugest√£o: ${error.message}`);
        return { sucesso: false };
      }
    }
    
    // ‚úÖ NOVO: Ignorar sugest√£o
    async function ignorarSugestao(sugestaoId) {
      if (!confirm('Tem certeza que deseja ignorar esta sugest√£o?')) {
        return;
      }
      
      try {
        // Marcar como ignorada no banco
        const response = await fetch('/api/banco/ignorar-sugestao', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sugestao_id: sugestaoId })
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
          carregarSugestoesVinculacao();
          atualizarBadgeSugestoes(); // ‚úÖ Atualizar badge
        } else {
          alert(`‚ùå Erro: ${data.mensagem || data.erro || 'Erro desconhecido'}`);
        }
      } catch (error) {
        console.error('Erro ao ignorar sugest√£o:', error);
        alert(`‚ùå Erro ao ignorar sugest√£o: ${error.message}`);
      }
    }
    
    // ‚úÖ NOVO: Aplicar todas as sugest√µes
    async function aplicarTodasSugestoes() {
      if (!confirm('Tem certeza que deseja aplicar TODAS as sugest√µes pendentes?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/banco/sugestoes-vinculacao?limite=100');
        const data = await response.json();
        
        if (!data.sucesso || !data.sugestoes) {
          alert('‚ùå Erro ao buscar sugest√µes');
          return;
        }
        
        let aplicadas = 0;
        let erros = 0;
        
        for (const sugestao of data.sugestoes) {
          const result = await aplicarSugestao(sugestao.id);
          if (result && result.sucesso) {
            aplicadas++;
            // Pequeno delay para n√£o sobrecarregar
            await new Promise(resolve => setTimeout(resolve, 200));
          } else {
            erros++;
          }
        }
        
        alert(`‚úÖ ${aplicadas} sugest√£o(√µes) aplicada(s), ${erros} erro(s)`);
        carregarSugestoesVinculacao();
        if (abaConciliacaoAtiva === 'nao-classificados') {
          carregarLancamentosNaoClassificados();
        }
      } catch (error) {
        console.error('Erro ao aplicar todas:', error);
        alert(`‚ùå Erro: ${error.message}`);
      }
    }
    
    // ‚úÖ NOVO: Editar lan√ßamento classificado (abre modal de classifica√ß√£o com dados preenchidos)
    // ‚úÖ NOVO: Desvincular lan√ßamento (remover todas as classifica√ß√µes)
    async function desvincularLancamento(idMovimentacao) {
      if (!idMovimentacao) return;
      
      if (!confirm('Tem certeza que deseja desvincular este lan√ßamento? Todas as classifica√ß√µes e v√≠nculos com processos ser√£o removidos.')) {
        return;
      }
      
      try {
        const response = await fetch('/api/banco/desvincular-lancamento', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_movimentacao: idMovimentacao })
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
          alert(`‚úÖ ${data.mensagem}`);
          // Recarregar listas
          carregarLancamentosClassificados();
          if (abaConciliacaoAtiva === 'nao-classificados') {
            carregarLancamentosNaoClassificados();
          }
        } else {
          alert(`‚ùå Erro: ${data.mensagem || data.erro || 'Erro desconhecido'}`);
        }
      } catch (error) {
        console.error('Erro ao desvincular lan√ßamento:', error);
        alert(`‚ùå Erro ao desvincular lan√ßamento: ${error.message}`);
      }
    }

    async function editarLancamentoClassificado(elemento) {
      const lancamentoJson = elemento.getAttribute('data-lancamento');
      if (!lancamentoJson) {
        console.error('‚ùå Lan√ßamento n√£o encontrado no data attribute');
        return;
      }
      
      try {
        const lanc = JSON.parse(lancamentoJson.replace(/&#39;/g, "'").replace(/&quot;/g, '"'));
        
        // Limpar classifica√ß√µes antigas primeiro
        classificacoesAtuais = [];
        distribuicaoImpostos = {};
        impostosConfirmados = false;
        
        // Preparar objeto do lan√ßamento para edi√ß√£o
        lancamentoSelecionado = {
          id: lanc.id_movimentacao || lanc.id,
          valor: Math.abs(lanc.valor || 0),
          descricao: lanc.descricao || '',
          processo: lanc.processo_vinculado || '',
          eh_possivel_imposto_importacao: lanc.eh_possivel_imposto_importacao || false,
          requer_confirmacao: lanc.requer_confirmacao || false,
          banco: lanc.banco || '',
          agencia: lanc.agencia || '',
          conta: lanc.conta || '',
          sinal: lanc.sinal || '+',
          eh_credito: (lanc.sinal || '+') === '+'
        };
        
        // Buscar classifica√ß√µes existentes deste lan√ßamento ANTES de abrir o modal
        try {
          const classificacoes = await buscarClassificacoesLancamento(lanc.id_movimentacao || lanc.id);
          if (classificacoes && classificacoes.length > 0) {
            // Adicionar IDs √∫nicos para cada classifica√ß√£o (se n√£o tiverem)
            classificacoesAtuais = classificacoes.map((classif, idx) => ({
              ...classif,
              id: classif.id || `edit_${Date.now()}_${idx}` // Gerar ID √∫nico se n√£o existir
            }));
          }
        } catch (error) {
          console.error('Erro ao buscar classifica√ß√µes:', error);
          // Continuar sem classifica√ß√µes (permite nova classifica√ß√£o)
        }

        // ‚úÖ UX: se o lan√ßamento j√° foi classificado como "Impostos de Importa√ß√£o",
        // reabrir o modal j√° no modo de distribui√ß√£o (II/IPI/PIS/COFINS/Taxa),
        // em vez de mostrar como "uma despesa √∫nica".
        const isImpostosImportacao = (c) => {
          if (!c) return false;
          const tipo = String(c.tipo_despesa || '').toLowerCase();
          const cat = String(c.categoria_despesa || '').toUpperCase();
          // cobre varia√ß√µes ("Impostos de Importa√ß√£o", "IMPOSTOS_IMPORTACAO", etc.)
          return (
            tipo.includes('impostos de import') ||
            tipo === 'impostos de importa√ß√£o' ||
            tipo === 'impostos de importacao' ||
            cat.includes('IMPOSTOS')
          );
        };

        const temImpostosClassificados = Array.isArray(classificacoesAtuais) && classificacoesAtuais.some(isImpostosImportacao);
        const ehSomenteImpostos =
          Array.isArray(classificacoesAtuais) &&
          classificacoesAtuais.length === 1 &&
          isImpostosImportacao(classificacoesAtuais[0]);

        if (temImpostosClassificados) {
          // For√ßar aviso/checkbox aparecer (mesmo que a lista "classificados" n√£o traga a flag)
          lancamentoSelecionado.eh_possivel_imposto_importacao = true;
          // Preferir processo da classifica√ß√£o (se existir)
          const procDaClassif = (classificacoesAtuais.find(isImpostosImportacao) || {}).processo_referencia;
          if (procDaClassif && String(procDaClassif).trim()) {
            lancamentoSelecionado.processo = String(procDaClassif).trim();
          }
          // Se for somente impostos, n√£o faz sentido mostrar como "Despesa 1"
          if (ehSomenteImpostos) {
            classificacoesAtuais = [];
          }
        }
        
        // Abrir modal (preservar classifica√ß√µes carregadas para edi√ß√£o)
        abrirModalClassificar(lancamentoSelecionado, null, null, null, { preservarClassificacoes: true });
        
        // Se houver classifica√ß√µes, atualizar a lista ap√≥s o modal abrir
        if (classificacoesAtuais.length > 0) {
          setTimeout(() => {
            atualizarListaClassificacoes();
          }, 200);
        }

        // ‚úÖ Se j√° era impostos, abrir automaticamente a distribui√ß√£o e preencher valores gravados/sugeridos
        if (temImpostosClassificados) {
          setTimeout(async () => {
            try {
              const chk = document.getElementById('confirmar-impostos-importacao');
              if (chk) {
                chk.checked = true;
                await toggleDistribuicaoImpostos();
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è N√£o foi poss√≠vel abrir distribui√ß√£o de impostos automaticamente:', e);
            }
          }, 250);
        }
      } catch (e) {
        console.error('‚ùå Erro ao parsear lan√ßamento:', e);
      }
    }
    
    // ‚úÖ NOVO: Buscar classifica√ß√µes existentes de um lan√ßamento
    async function buscarClassificacoesLancamento(idMovimentacao) {
      try {
        const response = await fetch(`/api/banco/lancamento/${idMovimentacao}/classificacoes`);
        const data = await response.json();
        
        if (data.sucesso && data.lancamento && data.lancamento.classificacoes) {
          // Converter classifica√ß√µes para o formato esperado pelo modal
          return data.lancamento.classificacoes.map(classif => ({
            id_tipo_despesa: classif.id_tipo_despesa,
            processo_referencia: classif.processo_referencia || '',
            valor_despesa: classif.valor_despesa,
            percentual_valor: classif.percentual_valor,
            tipo_despesa: classif.tipo_despesa,
            categoria_despesa: classif.categoria_despesa
          }));
        }
        return [];
      } catch (error) {
        console.error('Erro ao buscar classifica√ß√µes:', error);
        return [];
      }
    }
    
    // ‚úÖ NOVO: Fun√ß√£o para abrir modal com objeto completo do lan√ßamento
    function abrirModalClassificarCompleto(elemento) {
      const lancamentoJson = elemento.getAttribute('data-lancamento');
      if (!lancamentoJson) {
        console.error('‚ùå Lan√ßamento n√£o encontrado no data attribute');
        return;
      }
      
      try {
        const lanc = JSON.parse(lancamentoJson.replace(/&#39;/g, "'").replace(/&quot;/g, '"'));
        abrirModalClassificar(lanc);
      } catch (e) {
        console.error('‚ùå Erro ao parsear lan√ßamento:', e);
        // Fallback para m√©todo antigo
        const id = elemento.getAttribute('data-id') || elemento.querySelector('[data-id]')?.getAttribute('data-id');
        if (id) {
          abrirModalClassificar({ id_movimentacao: parseInt(id) });
        }
      }
    }
    
    // ‚úÖ Fun√ß√£o principal para abrir modal (aceita objeto completo ou par√¢metros individuais)
    // opts: { preservarClassificacoes?: boolean }
    function abrirModalClassificar(lancamentoOuId, valor, descricao, processoReferencia, opts) {
      // Se recebeu objeto completo
      if (typeof lancamentoOuId === 'object' && lancamentoOuId !== null) {
        const valorOriginal = lancamentoOuId.valor || lancamentoOuId.valor_movimentacao || 0;
        const sinalMov = lancamentoOuId.sinal || (valorOriginal >= 0 ? '+' : '-');
        lancamentoSelecionado = {
          // ‚úÖ Robustez: o objeto pode vir do "n√£o classificado" (shape A) ou do "editar classificado" (shape B)
          // shape A (lista): { id_movimentacao, valor, descricao, processo_vinculado, ... }
          // shape B (editar): { id, valor, descricao, processo, ... }
          id: lancamentoOuId.id_movimentacao || lancamentoOuId.id_movimentacao_bancaria || lancamentoOuId.id,
          valor: Math.abs(valorOriginal),
          descricao: lancamentoOuId.descricao || lancamentoOuId.descricao_movimentacao || '',
          processo: lancamentoOuId.processo_vinculado || lancamentoOuId.processo || lancamentoOuId.processo_referencia || '',
          eh_possivel_imposto_importacao: lancamentoOuId.eh_possivel_imposto_importacao || false,
          requer_confirmacao: lancamentoOuId.requer_confirmacao || false,
          // ‚úÖ NOVO: Dados de contrapartida para Aportes
          nome_contrapartida: lancamentoOuId.nome_contrapartida || (lancamentoOuId.contrapartida ? lancamentoOuId.contrapartida.nome : ''),
          cpf_cnpj_contrapartida: lancamentoOuId.cpf_cnpj_contrapartida || (lancamentoOuId.contrapartida ? lancamentoOuId.contrapartida.cpf_cnpj : ''),
          // ‚úÖ NOVO (24/01/2026): Guardar sinal e flag de cr√©dito para UX de aporte
          sinal: sinalMov,
          eh_credito: sinalMov === '+'
        };
      } else {
        // M√©todo antigo (compatibilidade)
        const valorOriginal = valor || 0;
        const sinalMov = valorOriginal >= 0 ? '+' : '-';
        lancamentoSelecionado = {
          id: lancamentoOuId,
          valor: Math.abs(valorOriginal),
          descricao: descricao || '',
          processo: processoReferencia || '',
          eh_possivel_imposto_importacao: false,
          requer_confirmacao: false,
          sinal: sinalMov,
          eh_credito: sinalMov === '+'
        };
      }
      
      // ‚úÖ UX: limpar estado do modal ao abrir (evita parecer que "salvou sozinho")
      const preservarClassificacoes = !!(opts && opts.preservarClassificacoes === true);
      if (!preservarClassificacoes) {
        classificacoesAtuais = [];
      }
      distribuicaoImpostos = {};
      impostosConfirmados = false;
      impostosSugeridos = [];
      
      const modal = document.getElementById('modal-classificar-lancamento');
      if (modal) {
        // Limpar status de "salvou" de aberturas anteriores
        const statusDiv = document.getElementById('classificar-status');
        if (statusDiv) {
          statusDiv.style.display = 'none';
          statusDiv.innerHTML = '';
        }

        // Preencher informa√ß√µes do lan√ßamento
        const infoDiv = document.getElementById('classificar-lancamento-info');
        const valorFormatado = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(lancamentoSelecionado.valor);
        
        const descricao = lancamentoSelecionado.descricao || 'Sem descri√ß√£o';
        const processoReferencia = lancamentoSelecionado.processo || '';
        const ehPossivelImposto = lancamentoSelecionado.eh_possivel_imposto_importacao || false;
        
        infoDiv.innerHTML = `
          <div style="margin-bottom: 8px;"><strong>Valor Total:</strong> <span style="color: #e74c3c; font-size: 16px; font-weight: bold;">${valorFormatado}</span></div>
          <div style="margin-bottom: 8px;"><strong>Descri√ß√£o:</strong> ${descricao}</div>
          ${processoReferencia ? `<div><strong>Processo detectado:</strong> <span style="background: #3498db; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${processoReferencia}</span></div>` : ''}
          ${ehPossivelImposto ? `
            <div id="aviso-impostos" style="margin-top: 12px; padding: 12px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; font-size: 13px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 18px;">‚ö†Ô∏è</span>
                <strong style="color: #856404;">Este lan√ßamento pode ser de impostos de importa√ß√£o</strong>
              </div>
              <div style="margin-bottom: 8px; color: #856404; font-size: 12px;">
                Se este lan√ßamento cont√©m impostos de importa√ß√£o (II, IPI, PIS, COFINS), voc√™ pode distribuir o valor entre os tipos de imposto.
              </div>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="confirmar-impostos-importacao" onchange="toggleDistribuicaoImpostos()" style="width: 18px; height: 18px; cursor: pointer;">
                <strong style="color: #856404;">Confirmar que s√£o impostos de importa√ß√£o</strong>
              </label>
            </div>
          ` : ''}
          ${lancamentoSelecionado.eh_credito && !ehPossivelImposto ? `
            <div id="aviso-aporte" style="margin-top: 12px; padding: 12px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 6px; font-size: 13px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 18px;">üí∞</span>
                <strong style="color: #0d47a1;">Este lan√ßamento √© uma ENTRADA de recurso</strong>
              </div>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="confirmar-aporte-tributos" onchange="toggleAporteRecursos()" style="width: 18px; height: 18px; cursor: pointer;">
                <strong style="color: #0d47a1;">Classificar como Aporte de Tributos (Cliente)</strong>
              </label>
              <p style="margin-top: 8px; font-size: 11px; color: #1565c0;">
                Se marcado, este valor alimentar√° o saldo virtual do cliente para lastrear pagamentos de impostos (IN 1986).
              </p>
            </div>
          ` : ''}
          <div id="valor-restante" style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 12px;">
            <strong>Valor restante:</strong> <span id="valor-restante-valor">${valorFormatado}</span>
          </div>
        `;
        
        // Ocultar interface de impostos inicialmente
        const distribuicaoDiv = document.getElementById('distribuicao-impostos');
        if (distribuicaoDiv) {
          distribuicaoDiv.style.display = 'none';
        }

        // Garantir checkbox desmarcado (sempre inicia como n√£o confirmado)
        const chk = document.getElementById('confirmar-impostos-importacao');
        if (chk) chk.checked = false;
        
        // Carregar tipos de despesa
        carregarTiposDespesa().then(() => {
          const ehCredito = lancamentoSelecionado && (lancamentoSelecionado.eh_credito === true || lancamentoSelecionado.sinal === '+');
          const ehDebito = lancamentoSelecionado && (lancamentoSelecionado.eh_credito === false || lancamentoSelecionado.sinal === '-');

          // ‚úÖ NOVO (24/01/2026): Se for d√©bito de imposto, verificar lastro financeiro
          if (ehDebito && ehPossivelImposto) {
            verificarLastroFinanceiro(processoReferencia);
          }

          // ‚úÖ NOVO (24/01/2026): Se for entrada, ativar automaticamente o modo Aporte (esconder despesas)
          if (ehCredito && !ehPossivelImposto) {
            const chkAporteAuto = document.getElementById('confirmar-aporte-tributos');
            if (chkAporteAuto && !chkAporteAuto.checked) {
              chkAporteAuto.checked = true;
              try {
                toggleAporteRecursos();
              } catch (e) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel ativar modo Aporte automaticamente:', e);
              }
            }
          }

          // ‚úÖ UX: ao editar um lan√ßamento classificado, n√£o criar "Despesa 2" vazia.
          // S√≥ adiciona despesa automaticamente quando n√£o estamos preservando uma edi√ß√£o
          // OU quando ainda n√£o h√° nenhuma classifica√ß√£o.
          const preservarClassificacoes = !!(opts && opts.preservarClassificacoes === true);
          const chkAporte = document.getElementById('confirmar-aporte-tributos');
          const ehAporte = chkAporte && chkAporte.checked;
          if ((!preservarClassificacoes || classificacoesAtuais.length === 0) && (!ehCredito || !ehAporte)) {
            adicionarDespesa(processoReferencia);
          }
        });
        
        modal.style.display = 'flex';
      }
    }
    
    // ‚úÖ NOVO (24/01/2026): Verificar lastro financeiro do cliente (IN 1986)
    async function verificarLastroFinanceiro(processoRef) {
      const secaoLastro = document.getElementById('secao-lastro-financeiro');
      const corpoLastro = document.getElementById('lastro-info-corpo');
      if (!secaoLastro || !corpoLastro) return;

      if (!processoRef) {
        secaoLastro.style.display = 'none';
        return;
      }

      secaoLastro.style.display = 'block';
      corpoLastro.innerHTML = '‚è≥ Verificando saldo do cliente...';

      try {
        const response = await fetch(`/api/banco/lastro-cliente?processo=${encodeURIComponent(processoRef)}`);
        const data = await response.json();

        if (data.sucesso) {
          const saldo = data.saldo || 0;
          const valorImposto = lancamentoSelecionado.valor;
          const saldoFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(saldo);
          
          if (saldo >= valorImposto) {
            corpoLastro.innerHTML = `
              <div style="color: #2e7d32;">
                ‚úÖ <strong>Saldo Dispon√≠vel: ${saldoFormatado}</strong><br>
                O cliente possui recurso suficiente para este pagamento. Origem do dinheiro comprovada.
              </div>
            `;
          } else {
            secaoLastro.style.background = '#ffebee';
            secaoLastro.style.border = '1px solid #c62828';
            corpoLastro.innerHTML = `
              <div style="color: #c62828;">
                ‚ö†Ô∏è <strong>SALDO INSUFICIENTE: ${saldoFormatado}</strong><br>
                <strong>RISCO DE COMPLIANCE (IN 1986):</strong> N√£o foi identificado aporte suficiente deste cliente para cobrir este d√©bito.
              </div>
            `;
          }
        } else {
          corpoLastro.innerHTML = `‚ö†Ô∏è N√£o foi poss√≠vel verificar o saldo do cliente: ${data.erro || 'Erro desconhecido'}`;
        }
      } catch (error) {
        corpoLastro.innerHTML = `‚ùå Erro ao consultar lastro: ${error.message}`;
      }
    }

    function fecharModalClassificar() {
      const modal = document.getElementById('modal-classificar-lancamento');
      if (modal) {
        modal.style.display = 'none';
      }
      lancamentoSelecionado = null;
      classificacoesAtuais = [];
      distribuicaoImpostos = {};
      impostosConfirmados = false;
      impostosSugeridos = [];
      atualizarListaClassificacoes();
    }
    
    // ‚úÖ NOVO: Toggle da interface de distribui√ß√£o de impostos
    // ‚úÖ NOVO: Toggle da interface de distribui√ß√£o de impostos
    // ‚úÖ NOVO: Toggle da interface de distribui√ß√£o de impostos
    async function toggleDistribuicaoImpostos() {
      const checkbox = document.getElementById('confirmar-impostos-importacao');
      const distribuicaoDiv = document.getElementById('distribuicao-impostos');
      const containerDespesas = document.getElementById('classificacoes-container'); // Se√ß√£o de despesas normais
      const btnSugerir = document.getElementById('btn-sugerir-split');
      
      if (!checkbox || !distribuicaoDiv) return;
      
      impostosConfirmados = checkbox.checked;
      
      if (impostosConfirmados) {
        // Mostrar interface de distribui√ß√£o e ocultar despesas normais
        distribuicaoDiv.style.display = 'block';
        if (containerDespesas) {
          containerDespesas.style.setProperty('display', 'none', 'important');
        }
        if (btnSugerir) {
          btnSugerir.style.setProperty('display', 'none', 'important');
        }
        
        const processoRef = lancamentoSelecionado?.processo || '';
        if (processoRef) {
          await buscarEpreencherImpostosAutomatico(processoRef);
        } else {
          mostrarCampoProcessoImpostos();
        }
      } else {
        // Ocultar interface de distribui√ß√£o e mostrar despesas normais
        distribuicaoDiv.style.display = 'none';
        if (containerDespesas) {
          containerDespesas.style.display = 'block';
          containerDespesas.style.removeProperty('display');
        }
        if (btnSugerir) {
          btnSugerir.style.display = 'block';
          btnSugerir.style.removeProperty('display');
        }
        distribuicaoImpostos = {};
        atualizarTotalImpostos();
      }
    }

    // ‚úÖ NOVO (24/01/2026): Toggle para Aporte de Recursos (Entradas)
    function toggleAporteRecursos() {
      const checkbox = document.getElementById('confirmar-aporte-tributos');
      const containerDespesas = document.getElementById('classificacoes-container');
      const labelValorRestante = document.querySelector('#valor-restante strong');
      const secaoLastro = document.getElementById('secao-lastro-financeiro');
      const corpoLastro = document.getElementById('lastro-info-corpo');
      const btnSugerir = document.getElementById('btn-sugerir-split');
      const btnAdicionar = document.querySelector('button[onclick="adicionarDespesa()"]');
      
      console.log('üîÑ toggleAporteRecursos chamado. Checkbox:', checkbox?.checked);

      if (!checkbox || !containerDespesas) {
        console.error('‚ùå Elementos n√£o encontrados para toggleAporteRecursos');
        return;
      }

      if (checkbox.checked) {
        // √â um aporte: ocultar se√ß√£o de despesas COMPLETAMENTE
        containerDespesas.style.setProperty('display', 'none', 'important');
        if (btnSugerir) btnSugerir.style.setProperty('display', 'none', 'important');
        if (btnAdicionar) btnAdicionar.style.setProperty('display', 'none', 'important');
        if (labelValorRestante) labelValorRestante.textContent = 'Valor do Aporte:';
        
        // Mostrar quem √© o cliente (contrapartida)
        if (secaoLastro && corpoLastro) {
          secaoLastro.style.display = 'block';
          secaoLastro.style.background = '#e3f2fd';
          secaoLastro.style.border = '1px solid #2196f3';
          const tituloLastro = document.querySelector('#secao-lastro-financeiro strong');
          if (tituloLastro) tituloLastro.textContent = 'Identifica√ß√£o do Cliente (Aporte)';
          
          // ‚úÖ TENTAR EXTRAIR CNPJ DA DESCRI√á√ÉO SE ESTIVER VAZIO
          let nome = lancamentoSelecionado.nome_contrapartida;
          let cnpj = lancamentoSelecionado.cpf_cnpj_contrapartida;
          
          if (!cnpj || cnpj === 'N√£o identificado no extrato') {
            const desc = lancamentoSelecionado.descricao || '';
            const match = desc.match(/\b(\d{14}|\d{11})\b/);
            if (match) {
              cnpj = match[1];
              console.log('üéØ CNPJ extra√≠do via regex da descri√ß√£o:', cnpj);
              // Tentar buscar nome via API se extraiu CNPJ novo
              buscarNomePorCnpj(cnpj).then(nomeEncontrado => {
                if (nomeEncontrado) {
                  lancamentoSelecionado.nome_contrapartida = nomeEncontrado;
                  lancamentoSelecionado.cpf_cnpj_contrapartida = cnpj;
                  // Atualizar a UI novamente
                  toggleAporteRecursos();
                }
              });
            }
          }
          
          corpoLastro.innerHTML = `
            <div style="color: #0d47a1;">
              üë§ <strong>Cliente:</strong> ${nome || 'Buscando...'}<br>
              üìÑ <strong>CNPJ/CPF:</strong> ${cnpj || 'N√£o identificado'}<br><br>
              üí° Este valor ser√° adicionado ao saldo deste cliente para futuros pagamentos de impostos.
            </div>
          `;
        }
        console.log('üí∞ Modo Aporte ativado: ocultando despesas.');
      } else {
        // N√£o √© aporte: mostrar despesas novamente
        containerDespesas.style.display = 'block';
        containerDespesas.style.removeProperty('display');
        if (btnSugerir) {
          btnSugerir.style.display = 'block';
          btnSugerir.style.removeProperty('display');
        }
        if (btnAdicionar) {
          btnAdicionar.style.display = 'block';
          btnAdicionar.style.removeProperty('display');
        }
        if (labelValorRestante) labelValorRestante.textContent = 'Valor restante:';
        if (secaoLastro) secaoLastro.style.display = 'none';
      }
    }

    // ‚úÖ NOVO: Buscar nome da empresa pelo CNPJ via API interna
    async function buscarNomePorCnpj(cnpj) {
      try {
        const response = await fetch(`/api/utils/consultar-cnpj/${cnpj}`);
        const data = await response.json();
        return data.sucesso ? data.nome : null;
      } catch (e) {
        return null;
      }
    }


    // ‚úÖ NOVO: Mostrar campo para informar processo quando n√£o tiver
    function mostrarCampoProcessoImpostos() {
      const impostosListaDiv = document.getElementById('impostos-lista');
      if (!impostosListaDiv) return;
      
      impostosListaDiv.innerHTML = `
        <div style="padding: 16px; background: #fff; border-radius: 6px; border: 2px dashed #4caf50;">
          <div style="margin-bottom: 12px;">
            <strong style="color: #2e7d32; font-size: 14px;">üìã Informe o Processo</strong>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #555;">
              Para buscar automaticamente os impostos da DI/DUIMP, informe o n√∫mero do processo.
            </p>
          </div>
          <div style="display: flex; gap: 8px; align-items: end;">
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #333;">Processo:</label>
              <input 
                type="text" 
                id="processo-impostos-input" 
                placeholder="Ex: BGR.0070/25" 
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                onkeypress="if(event.key === 'Enter') buscarImpostosPorProcesso()">
            </div>
            <button 
              type="button"
              onclick="buscarImpostosPorProcesso()"
              style="padding: 8px 16px; background: #4caf50; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap;">
              üîç Buscar
            </button>
          </div>
          <div id="processo-impostos-status" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
        </div>
      `;
    }
    
    // ‚úÖ NOVO: Buscar impostos por processo informado
    async function buscarImpostosPorProcesso() {
      const processoInput = document.getElementById('processo-impostos-input');
      const statusDiv = document.getElementById('processo-impostos-status');
      
      if (!processoInput || !statusDiv) return;
      
      const processoRef = processoInput.value.trim();
      if (!processoRef) {
        statusDiv.innerHTML = '<span style="color: #c62828;">‚ö†Ô∏è Informe o n√∫mero do processo</span>';
        return;
      }
      
      // Atualizar processo no lan√ßamento selecionado
      if (lancamentoSelecionado) {
        lancamentoSelecionado.processo = processoRef;
      }
      
      // Atualizar processo na primeira classifica√ß√£o (se houver)
      if (classificacoesAtuais.length > 0) {
        classificacoesAtuais[0].processo_referencia = processoRef;
        atualizarListaClassificacoes();
      }
      
      statusDiv.innerHTML = '<span style="color: #856404;">‚è≥ Buscando impostos da DI/DUIMP...</span>';
      
      await buscarEpreencherImpostosAutomatico(processoRef);
    }
    
    // ‚úÖ NOVO: Buscar e preencher impostos automaticamente
    async function buscarEpreencherImpostosAutomatico(processoRef) {
      const statusDiv = document.getElementById('processo-impostos-status');
      const impostosListaDiv = document.getElementById('impostos-lista');
      const impostosStatusDiv = document.getElementById('impostos-status');
      
      // Atualizar status (pode estar em diferentes lugares)
      if (statusDiv) {
        statusDiv.innerHTML = '<span style="color: #856404;">‚è≥ Buscando DI/DUIMP pela API oficial...</span>';
      }
      if (impostosStatusDiv) {
        impostosStatusDiv.innerHTML = '<span style="color: #856404;">‚è≥ Buscando impostos...</span>';
      }
      
      try {
        // Buscar impostos sugeridos da DI/DUIMP
        console.log(`üîç Buscando impostos para processo: ${processoRef}`);
        // ‚úÖ Robustez: timeout para n√£o "travar" indefinidamente no status
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s
        const response = await fetch(`/api/banco/impostos-processo/${encodeURIComponent(processoRef)}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Resposta do endpoint de impostos:', data);
        console.log('üìä Impostos gravados:', data.impostos_gravados);
        console.log('üìä Impostos sugeridos:', data.impostos_sugeridos);

        // ‚úÖ Prioridade: quando j√° foi classificado, usar "impostos_gravados" (fonte da verdade).
        // Fallback: usar "impostos_sugeridos" (DI/DUIMP) quando ainda n√£o foram gravados.
        const listaImpostos = (data && data.sucesso && Array.isArray(data.impostos_gravados) && data.impostos_gravados.length > 0)
          ? data.impostos_gravados
          : (data && data.sucesso && Array.isArray(data.impostos_sugeridos) ? data.impostos_sugeridos : []);

        if (data.sucesso && listaImpostos && listaImpostos.length > 0) {
          // Preencher automaticamente os valores
          impostosSugeridos = listaImpostos;
          distribuicaoImpostos = {};
          
          let totalSugerido = 0;
          impostosSugeridos.forEach(imposto => {
            const tipo = imposto.tipo_imposto || imposto.tipo;
            const valor = parseFloat(imposto.valor_brl ?? imposto.valor ?? 0) || 0;
            if (tipo && valor > 0) {
              distribuicaoImpostos[tipo] = valor;
              totalSugerido += valor;
            }
          });
          
          console.log(`‚úÖ ${impostosSugeridos.length} imposto(s) encontrado(s). Total: R$ ${totalSugerido.toFixed(2)}`);
          console.log('üí∞ Distribui√ß√£o:', distribuicaoImpostos);
          
          // Criar interface com valores preenchidos
          criarInterfaceDistribuicao();
          
          const mensagemSucesso = `‚úÖ ${impostosSugeridos.length} imposto(s) encontrado(s) e preenchido(s) automaticamente! Total: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalSugerido)}`;
          
          if (statusDiv) {
            statusDiv.innerHTML = `<span style="color: #2e7d32;">${mensagemSucesso}</span>`;
          }
          if (impostosStatusDiv) {
            impostosStatusDiv.innerHTML = `<span style="color: #2e7d32;">${mensagemSucesso}</span>`;
          }
        } else {
          // Se n√£o encontrou impostos, mostrar interface vazia
          console.warn('‚ö†Ô∏è Nenhum imposto encontrado na resposta:', data);
          criarInterfaceDistribuicaoManual();
          const mensagemAviso = '<span style="color: #856404;">‚ö†Ô∏è Nenhum imposto encontrado na DI/DUIMP. Preencha manualmente.</span>';
          if (statusDiv) {
            statusDiv.innerHTML = mensagemAviso;
          }
          if (impostosStatusDiv) {
            impostosStatusDiv.innerHTML = mensagemAviso;
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao buscar impostos:', error);
        criarInterfaceDistribuicaoManual();
        const isAbort = (error && (error.name === 'AbortError' || String(error.message || '').toLowerCase().includes('aborted')));
        const msg = isAbort
          ? '‚è±Ô∏è Timeout ao buscar impostos (12s). Tente novamente.'
          : `‚ùå Erro ao buscar impostos: ${error.message}`;
        const mensagemErro = `<span style="color: #c62828;">${msg}</span>`;
        if (statusDiv) {
          statusDiv.innerHTML = mensagemErro;
        }
        if (impostosStatusDiv) {
          impostosStatusDiv.innerHTML = mensagemErro;
        }
      }
    }
    
    // ‚úÖ NOVO: Carregar impostos sugeridos da DI
    async function carregarImpostosSugeridos(processoReferencia) {
      try {
        const response = await fetch(`/api/banco/impostos-processo/${processoReferencia}`);
        const data = await response.json();
        
        if (data.sucesso) {
          impostosSugeridos = data.impostos_sugeridos || [];
          criarInterfaceDistribuicao();
        } else {
          console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar impostos sugeridos:', data.mensagem);
          criarInterfaceDistribuicaoManual();
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar impostos sugeridos:', error);
        criarInterfaceDistribuicaoManual();
      }
    }
    
    // ‚úÖ NOVO: Criar interface de distribui√ß√£o com valores sugeridos
    function criarInterfaceDistribuicao() {
      const impostosListaDiv = document.getElementById('impostos-lista');
      const impostosTotalLancamento = document.getElementById('impostos-total-lancamento');
      
      if (!impostosListaDiv) return;
      
      const valorTotal = lancamentoSelecionado?.valor || 0;
      const valorTotalFormatado = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valorTotal);
      
      if (impostosTotalLancamento) {
        impostosTotalLancamento.textContent = valorTotalFormatado;
      }
      
      // Tipos de imposto poss√≠veis
      const tiposImposto = [
        { codigo: 'II', nome: 'II (Imposto de Importa√ß√£o)', cor: '#3498db' },
        { codigo: 'IPI', nome: 'IPI (Imposto sobre Produtos Industrializados)', cor: '#9b59b6' },
        { codigo: 'PIS', nome: 'PIS', cor: '#e67e22' },
        { codigo: 'COFINS', nome: 'COFINS', cor: '#16a085' },
        { codigo: 'TAXA_UTILIZACAO', nome: 'Taxa SISCOMEX', cor: '#f39c12' },
        { codigo: 'ANTIDUMPING', nome: 'Antidumping', cor: '#e74c3c' }
      ];
      
      let html = '';
      
      tiposImposto.forEach(tipo => {
        // Buscar valor sugerido da DI
        const impostoSugerido = impostosSugeridos.find(i => i.tipo_imposto === tipo.codigo);
        const valorSugerido = impostoSugerido?.valor_brl || 0;
        const valorAtual = distribuicaoImpostos[tipo.codigo] || valorSugerido || 0;
        
        if (!distribuicaoImpostos[tipo.codigo] && valorSugerido > 0) {
          distribuicaoImpostos[tipo.codigo] = valorSugerido;
        }
        
        html += `
          <div style="display: flex; align-items: center; gap: 12px; padding: 8px; background: #fff; border-radius: 4px;">
            <div style="flex: 1; min-width: 200px;">
              <label style="font-size: 13px; color: #333; font-weight: 500;">${tipo.nome}:</label>
              ${valorSugerido > 0 ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">Sugerido: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorSugerido)}</div>` : ''}
            </div>
            <input 
              type="number" 
              id="imposto-${tipo.codigo}" 
              step="0.01" 
              min="0"
              value="${valorAtual.toFixed(2)}"
              onchange="atualizarImposto('${tipo.codigo}', this.value)"
              style="flex: 1; max-width: 150px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
              placeholder="0.00">
            <span style="font-size: 12px; color: #666; min-width: 60px;">BRL</span>
          </div>
        `;
      });
      
      impostosListaDiv.innerHTML = html;
      atualizarTotalImpostos();
    }
    
    // ‚úÖ NOVO: Criar interface de distribui√ß√£o manual (sem valores sugeridos)
    function criarInterfaceDistribuicaoManual() {
      criarInterfaceDistribuicao();
    }
    
    // ‚úÖ NOVO: Atualizar valor de um imposto
    function atualizarImposto(tipoImposto, valor) {
      const valorFloat = parseFloat(valor) || 0;
      distribuicaoImpostos[tipoImposto] = valorFloat;
      atualizarTotalImpostos();
    }
    
    // ‚úÖ NOVO: Atualizar total de impostos distribu√≠dos
    function atualizarTotalImpostos() {
      const totalDiv = document.getElementById('impostos-total-valor');
      const statusDiv = document.getElementById('impostos-status');
      
      if (!totalDiv) return;
      
      const total = Object.values(distribuicaoImpostos).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
      const valorTotal = lancamentoSelecionado?.valor || 0;
      const diferenca = valorTotal - total;
      
      const totalFormatado = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(total);
      
      totalDiv.textContent = totalFormatado;
      
      if (statusDiv) {
        if (Math.abs(diferenca) < 0.01) {
          statusDiv.innerHTML = '<span style="color: #2e7d32;">‚úÖ Total distribu√≠do corretamente!</span>';
          statusDiv.style.color = '#2e7d32';
        } else if (diferenca > 0) {
          statusDiv.innerHTML = `<span style="color: #856404;">‚ö†Ô∏è Faltam distribuir: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(diferenca)}</span>`;
          statusDiv.style.color = '#856404';
        } else {
          statusDiv.innerHTML = `<span style="color: #c62828;">‚ùå Excedeu em: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Math.abs(diferenca))}</span>`;
          statusDiv.style.color = '#c62828';
        }
      }
    }
    
    // ‚úÖ CORRE√á√ÉO 3: Adicionar uma nova despesa ao split
    function adicionarDespesa(processoPadrao = '') {
      // ‚úÖ NOVO (24/01/2026): Se estiver no modo Aporte ou Imposto, n√£o adicionar despesa
      const chkAporte = document.getElementById('confirmar-aporte-tributos');
      const chkImposto = document.getElementById('confirmar-impostos-importacao');
      const containerDespesas = document.getElementById('classificacoes-container');
      
      if ((chkAporte && chkAporte.checked) || (chkImposto && chkImposto.checked)) {
        console.log('‚ÑπÔ∏è Modo Aporte ou Imposto ativo: ignorando adicionarDespesa');
        if (containerDespesas) {
          containerDespesas.style.setProperty('display', 'none', 'important');
        }
        return;
      }

      const id = Date.now(); // ID √∫nico tempor√°rio
      classificacoesAtuais.push({
        id: id,
        id_tipo_despesa: '',
        processo_referencia: processoPadrao || '',
        valor_despesa: null
      });
      atualizarListaClassificacoes();
    }

    // ‚úÖ NOVO: Sugerir split para o lan√ßamento atual (read-only)
    async function sugerirSplitLancamento() {
      try {
        if (!lancamentoSelecionado || !lancamentoSelecionado.id) {
          alert('Selecione um lan√ßamento primeiro.');
          return;
        }

        // garantir que tipos de despesa est√£o carregados (para renderizar select)
        if (!tiposDespesa || tiposDespesa.length === 0) {
          await carregarTiposDespesa();
        }

        const btn = document.getElementById('btn-sugerir-split');
        if (btn) {
          btn.disabled = true;
          btn.textContent = '‚è≥ Sugerindo...';
        }

        const resp = await fetch(`/api/banco/lancamento/${lancamentoSelecionado.id}/sugestoes-split?limite_processos=3`);
        const data = await resp.json();

        if (!data.sucesso) {
          alert(data.mensagem || data.erro || 'N√£o foi poss√≠vel sugerir o split.');
          return;
        }

        const sugestoes = data.sugestoes || [];
        if (!sugestoes.length) {
          alert(data.mensagem || 'N√£o encontrei sugest√£o autom√°tica. Voc√™ pode preencher manualmente.');
          return;
        }

        // Preencher o split (classificacoesAtuais) com as sugest√µes
        classificacoesAtuais = sugestoes.map((s, idx) => ({
          id: Date.now() + idx,
          id_tipo_despesa: s.id_tipo_despesa || '',
          processo_referencia: s.processo_referencia || '',
          valor_despesa: typeof s.valor_despesa === 'number' ? s.valor_despesa : (parseFloat(s.valor_despesa) || null),
        }));

        atualizarListaClassificacoes();

        const msg = data.mensagem || 'Sugest√µes aplicadas. Revise e clique em "Salvar Classifica√ß√µes".';
        const statusDiv = document.getElementById('classificar-status');
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#e8f5e9';
          statusDiv.style.color = '#2e7d32';
          statusDiv.innerHTML = `‚úÖ ${msg}`;
        }
      } catch (e) {
        console.error('‚ùå Erro ao sugerir split:', e);
        alert('Erro ao sugerir split: ' + (e.message || e));
      } finally {
        const btn = document.getElementById('btn-sugerir-split');
        if (btn) {
          btn.disabled = false;
          btn.textContent = '‚ú® Sugerir split';
        }
      }
    }
    
    // ‚úÖ CORRE√á√ÉO 3: Remover uma despesa do split
    function removerDespesa(id) {
      classificacoesAtuais = classificacoesAtuais.filter(c => c.id !== id);
      atualizarListaClassificacoes();
    }
    
    // ‚úÖ CORRE√á√ÉO 3: Atualizar lista de classifica√ß√µes na UI
    function atualizarListaClassificacoes() {
      const listaDiv = document.getElementById('classificacoes-lista');
      const containerDespesas = document.getElementById('classificacoes-container');
      if (!listaDiv) return;
      
      // ‚úÖ NOVO (24/01/2026): Se estiver no modo Aporte, garantir que o container est√° oculto
      const chkAporte = document.getElementById('confirmar-aporte-tributos');
      if (chkAporte && chkAporte.checked) {
        if (containerDespesas) containerDespesas.style.setProperty('display', 'none', 'important');
        listaDiv.innerHTML = '';
        return;
      }

      if (classificacoesAtuais.length === 0) {
        listaDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhuma despesa adicionada. Clique em "Adicionar Despesa" para come√ßar.</p>';
        return;
      }
      
      let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
      
      classificacoesAtuais.forEach((classif, index) => {
        const valorFormatado = classif.valor_despesa 
          ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(classif.valor_despesa)
          : '';
        
        html += `
          <div style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #fff;" data-classificacao-id="${classif.id}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: #333;">Despesa ${index + 1}</strong>
              ${classificacoesAtuais.length > 1 ? `<button type="button" onclick="removerDespesa(${classif.id})" style="background: #e74c3c; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">‚úï Remover</button>` : ''}
            </div>
            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #666;">Tipo de Despesa:</label>
            <select class="classificacao-tipo-despesa modal-input" data-id="${classif.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;" onchange="atualizarClassificacao(${classif.id}, 'tipo', this.value)">
              <option value="">Selecione um tipo de despesa...</option>
              ${tiposDespesa.map(tipo => `<option value="${tipo.id_tipo_despesa}" ${classif.id_tipo_despesa == tipo.id_tipo_despesa ? 'selected' : ''}>${tipo.nome_despesa}</option>`).join('')}
            </select>
            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #666;">Processo (opcional):</label>
            <input type="text" class="classificacao-processo modal-input" data-id="${classif.id}" placeholder="Ex: DMD.0083/25" value="${classif.processo_referencia || ''}" style="width: 100%; margin-bottom: 8px;" onchange="atualizarClassificacao(${classif.id}, 'processo', this.value)">
            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #666;">Valor desta Despesa (opcional):</label>
            <input type="number" class="classificacao-valor modal-input" data-id="${classif.id}" step="0.01" placeholder="Ex: 5000.00" value="${classif.valor_despesa || ''}" style="width: 100%;" onchange="atualizarClassificacao(${classif.id}, 'valor', this.value)">
          </div>
        `;
      });
      
      html += '</div>';
      listaDiv.innerHTML = html;
      
      // Atualizar valor restante
      atualizarValorRestante();
    }
    
    // ‚úÖ CORRE√á√ÉO 3: Atualizar uma classifica√ß√£o espec√≠fica
    function atualizarClassificacao(id, campo, valor) {
      const classif = classificacoesAtuais.find(c => c.id === id);
      if (!classif) return;
      
      if (campo === 'tipo') {
        classif.id_tipo_despesa = valor ? parseInt(valor) : '';
      } else if (campo === 'processo') {
        const processoAnterior = classif.processo_referencia || '';
        classif.processo_referencia = valor || '';
        
        // ‚úÖ NOVO: Se mudou o processo e √© um lan√ßamento de impostos, oferecer buscar impostos novamente
        if (valor && valor.trim() !== '' && valor.trim() !== processoAnterior.trim()) {
          // Verificar se √© um lan√ßamento de impostos (verificar tipo de despesa ou flag do lan√ßamento)
          const tipoDespesaId = classif.id_tipo_despesa;
          const ehImposto = lancamentoSelecionado?.eh_possivel_imposto_importacao || 
                           (tipoDespesaId && tiposDespesa.find(t => t.id_tipo_despesa === tipoDespesaId && 
                           (t.nome_despesa?.toLowerCase().includes('imposto') || t.categoria_despesa === 'IMPOSTOS')));
          
          if (ehImposto) {
            // Mostrar alerta oferecendo buscar impostos automaticamente
            mostrarAlertaBuscarImpostos(id, valor.trim());
          }
        }
      } else if (campo === 'valor') {
        classif.valor_despesa = valor ? parseFloat(valor) : null;
      }
      
      atualizarValorRestante();
    }
    
    // ‚úÖ NOVO: Mostrar alerta para buscar impostos quando processo mudar
    function mostrarAlertaBuscarImpostos(classificacaoId, processoReferencia) {
      // ‚úÖ NOVO (24/01/2026): Se estiver no modo Aporte, ignorar
      const chkAporte = document.getElementById('confirmar-aporte-tributos');
      if (chkAporte && chkAporte.checked) return;

      const classif = classificacoesAtuais.find(c => c.id === classificacaoId);
      if (!classif) return;
      
      // Criar ou atualizar alerta na interface
      const alertaId = `alerta-impostos-${classificacaoId}`;
      let alertaDiv = document.getElementById(alertaId);
      
      if (!alertaDiv) {
        // Criar alerta
        const classifDiv = document.querySelector(`[data-classificacao-id="${classificacaoId}"]`);
        if (!classifDiv) return;
        
        alertaDiv = document.createElement('div');
        alertaDiv.id = alertaId;
        alertaDiv.style.cssText = 'margin-top: 8px; padding: 12px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 6px; font-size: 13px;';
        alertaDiv.innerHTML = `
          <div style="margin-bottom: 8px; color: #1976d2; font-weight: 500;">
            üí° Processo alterado para <strong>${processoReferencia}</strong>
          </div>
          <div style="margin-bottom: 8px; color: #555; font-size: 12px;">
            Deseja buscar os impostos automaticamente para este processo?
          </div>
          <div style="display: flex; gap: 8px;">
            <button type="button" onclick="buscarImpostosParaClassificacao('${classificacaoId}', '${processoReferencia.replace(/'/g, "\\'")}')" 
                    style="flex: 1; padding: 6px 12px; background: #2196f3; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
              ‚úÖ Buscar Impostos
            </button>
            <button type="button" onclick="fecharAlertaImpostos('${alertaId}')" 
                    style="padding: 6px 12px; background: #e0e0e0; color: #666; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ‚úï Fechar
            </button>
          </div>
        `;
        
        // Inserir ap√≥s o campo de processo (procurar pelo input com data-id)
        const processoInput = classifDiv.querySelector(`input.classificacao-processo[data-id="${classificacaoId}"]`);
        if (processoInput && processoInput.parentElement) {
          // Inserir ap√≥s o input de processo, antes do pr√≥ximo label
          processoInput.parentElement.insertBefore(alertaDiv, processoInput.nextSibling);
        } else {
          // Fallback: inserir no final do div
          classifDiv.appendChild(alertaDiv);
        }
      } else {
        // Atualizar alerta existente
        const processoSpan = alertaDiv.querySelector('div strong');
        if (processoSpan) {
          processoSpan.textContent = processoReferencia;
        }
        const buscarBtn = alertaDiv.querySelector('button[onclick*="buscarImpostosParaClassificacao"]');
        if (buscarBtn) {
          buscarBtn.setAttribute('onclick', `buscarImpostosParaClassificacao('${classificacaoId}', '${processoReferencia.replace(/'/g, "\\'")}')`);
        }
        alertaDiv.style.display = 'block';
      }
    }
    
    // ‚úÖ NOVO: Buscar impostos para uma classifica√ß√£o espec√≠fica
    async function buscarImpostosParaClassificacao(classificacaoId, processoReferencia) {
      if (!processoReferencia || processoReferencia.trim() === '') {
        alert('Por favor, informe um processo v√°lido.');
        return;
      }
      
      const classif = classificacoesAtuais.find(c => c.id === classificacaoId);
      if (!classif) return;
      
      try {
        // Buscar impostos do processo
        const response = await fetch(`/api/banco/impostos-processo/${encodeURIComponent(processoReferencia)}`);
        const data = await response.json();
        
        if (data.sucesso && data.impostos_sugeridos && data.impostos_sugeridos.length > 0) {
          // Preencher valores automaticamente
          let totalImpostos = 0;
          const distribuicao = {};
          
          data.impostos_sugeridos.forEach(imposto => {
            const tipo = imposto.tipo || imposto.tipo_imposto;
            const valor = parseFloat(imposto.valor || imposto.valor_brl || 0);
            if (tipo && valor > 0) {
              distribuicao[tipo] = valor;
              totalImpostos += valor;
            }
          });
          
          // Atualizar classifica√ß√£o com o total de impostos
          classif.valor_despesa = totalImpostos;
          
          // Atualizar interface
          const valorInput = document.querySelector(`[data-classificacao-id="${classificacaoId}"] .classificacao-valor`);
          if (valorInput) {
            valorInput.value = totalImpostos.toFixed(2);
          }
          
          // Fechar alerta
          fecharAlertaImpostos(`alerta-impostos-${classificacaoId}`);
          
          // Mostrar mensagem de sucesso
          mostrarMensagemSucesso(`‚úÖ Impostos buscados automaticamente! Total: R$ ${totalImpostos.toFixed(2)}`);
          
          // Atualizar valor restante
          atualizarValorRestante();
        } else {
          alert('‚ö†Ô∏è Nenhum imposto encontrado para este processo.');
        }
      } catch (error) {
        console.error('Erro ao buscar impostos:', error);
        alert('‚ùå Erro ao buscar impostos. Tente novamente.');
      }
    }
    
    // ‚úÖ NOVO: Fechar alerta de impostos
    function fecharAlertaImpostos(alertaId) {
      const alertaDiv = document.getElementById(alertaId);
      if (alertaDiv) {
        alertaDiv.style.display = 'none';
      }
    }
    
    // ‚úÖ NOVO: Mostrar mensagem de sucesso tempor√°ria
    function mostrarMensagemSucesso(mensagem) {
      const mensagemDiv = document.createElement('div');
      mensagemDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: #4caf50; color: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-size: 14px;';
      mensagemDiv.textContent = mensagem;
      document.body.appendChild(mensagemDiv);
      
      setTimeout(() => {
        mensagemDiv.style.opacity = '0';
        mensagemDiv.style.transition = 'opacity 0.3s';
        setTimeout(() => mensagemDiv.remove(), 300);
      }, 3000);
    }
    
    // ‚úÖ CORRE√á√ÉO 3: Atualizar valor restante
    function atualizarValorRestante() {
      if (!lancamentoSelecionado) return;
      
      const valorTotal = lancamentoSelecionado.valor;
      let valorUsado = 0;
      
      classificacoesAtuais.forEach(classif => {
        if (classif.valor_despesa) {
          valorUsado += classif.valor_despesa;
        }
      });
      
      const valorRestante = valorTotal - valorUsado;
      const valorRestanteFormatado = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valorRestante);
      
      const valorRestanteDiv = document.getElementById('valor-restante-valor');
      if (valorRestanteDiv) {
        valorRestanteDiv.textContent = valorRestanteFormatado;
        if (valorRestante < 0) {
          valorRestanteDiv.style.color = '#e74c3c';
          valorRestanteDiv.parentElement.style.background = '#ffebee';
        } else if (valorRestante === 0) {
          valorRestanteDiv.style.color = '#2e7d32';
          valorRestanteDiv.parentElement.style.background = '#e8f5e9';
        } else {
          valorRestanteDiv.style.color = '#856404';
          valorRestanteDiv.parentElement.style.background = '#fff3cd';
        }
      }
    }
    
    async function carregarTiposDespesa() {
      try {
        console.log('üîç Carregando tipos de despesa...');
        const response = await fetch('/api/banco/tipos-despesa');
        const data = await response.json();
        
        console.log('üì¶ Resposta do endpoint:', data);
        
        if (data.sucesso && data.tipos && data.tipos.length > 0) {
          tiposDespesa = data.tipos;
          console.log(`‚úÖ ${tiposDespesa.length} tipos de despesa carregados`);
          
          // Retornar para usar em atualizarListaClassificacoes
          return tiposDespesa;
        } else {
          console.error('‚ùå Nenhum tipo de despesa encontrado:', data);
          tiposDespesa = [];
          return [];
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar tipos de despesa:', error);
        tiposDespesa = [];
        return [];
      }
    }
    
    async function salvarClassificacao() {
      if (!lancamentoSelecionado) {
        alert('Nenhum lan√ßamento selecionado');
        return;
      }
      
      // ‚úÖ NOVO (24/01/2026): Se for Aporte de Tributos, ignorar outras valida√ß√µes
      const chkAporte = document.getElementById('confirmar-aporte-tributos');
      const ehAporte = chkAporte && chkAporte.checked;

      // ‚úÖ NOVO: Se houver distribui√ß√£o de impostos confirmada, validar apenas impostos
      const temDistribuicaoImpostos = !ehAporte && impostosConfirmados && Object.keys(distribuicaoImpostos).length > 0;
      
      if (ehAporte) {
        // Valida√ß√£o m√≠nima para aporte: apenas confirmar que √© entrada
        if (lancamentoSelecionado.valor <= 0) {
          alert('Apenas entradas de recurso podem ser classificadas como Aporte.');
          return;
        }
      } else if (temDistribuicaoImpostos) {
        // Validar apenas a soma dos impostos
        const valorTotal = Math.abs(lancamentoSelecionado.valor); // Valor absoluto (lan√ßamento √© negativo)
        const somaImpostos = Object.values(distribuicaoImpostos).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
        
        if (somaImpostos > valorTotal) {
          alert(`A soma dos impostos (${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(somaImpostos)}) excede o valor total do lan√ßamento (${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorTotal)})`);
          return;
        }
        
        // Permitir pequena diferen√ßa (at√© R$ 0,01) por arredondamento
        if (Math.abs(somaImpostos - valorTotal) > 0.01 && somaImpostos < valorTotal) {
          const diferenca = valorTotal - somaImpostos;
          if (!confirm(`A soma dos impostos (${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(somaImpostos)}) √© menor que o valor do lan√ßamento (${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorTotal)}). Faltam distribuir ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(diferenca)}. Deseja continuar mesmo assim?`)) {
            return;
          }
        }
      } else {
        // Valida√ß√£o normal para despesas (n√£o impostos)
        if (classificacoesAtuais.length === 0) {
          alert('Adicione pelo menos uma despesa para classificar');
          return;
        }
        
        // Validar que todas t√™m tipo de despesa
        const classificacoesInvalidas = classificacoesAtuais.filter(c => !c.id_tipo_despesa);
        if (classificacoesInvalidas.length > 0) {
          alert('Todas as despesas devem ter um tipo selecionado');
          return;
        }
        
        // Validar valores (soma n√£o pode exceder valor total)
        const valorTotal = Math.abs(lancamentoSelecionado.valor);
        let somaValores = 0;
        classificacoesAtuais.forEach(c => {
          if (c.valor_despesa) {
            somaValores += parseFloat(c.valor_despesa) || 0;
          }
        });
        
        if (somaValores > valorTotal) {
          alert(`A soma dos valores (${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(somaValores)}) excede o valor total do lan√ßamento (${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorTotal)})`);
          return;
        }
      }
      
      const statusDiv = document.getElementById('classificar-status');
      const salvarBtn = document.getElementById('classificar-salvar-btn');
      
      salvarBtn.disabled = true;
      salvarBtn.textContent = '‚è≥ Salvando...';
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '‚è≥ Salvando classifica√ß√µes...';
      
      try {
        // ‚úÖ NOVO: Se houver distribui√ß√£o de impostos confirmada, preparar dados de forma diferente
        const temDistribuicaoImpostos = impostosConfirmados && Object.keys(distribuicaoImpostos).length > 0;
        
        let classificacoes = [];
        if (!temDistribuicaoImpostos) {
          // Preparar m√∫ltiplas classifica√ß√µes (despesas normais)
          classificacoes = classificacoesAtuais
            .filter(c => c.id_tipo_despesa) // Apenas classifica√ß√µes v√°lidas
            .map(c => ({
              id_tipo_despesa: parseInt(c.id_tipo_despesa),
              processo_referencia: c.processo_referencia || null,
              valor_despesa: c.valor_despesa || null
            }));
        }
        // Se houver apenas distribui√ß√£o de impostos, classificacoes fica vazio
        
        // ‚úÖ NOVO: Preparar body com distribui√ß√£o de impostos se houver
        const body = {
          id_movimentacao: lancamentoSelecionado.id,
          classificacoes: classificacoes
        };

        // ‚úÖ NOVO (24/01/2026): Adicionar natureza_recurso se for Aporte de Tributos
        if (ehAporte) {
          body.natureza_recurso = 'APORTE_TRIBUTOS';
          console.log('üí∞ Natureza do recurso: APORTE_TRIBUTOS');
        }
        
        // Se impostos foram confirmados e distribu√≠dos, adicionar distribui√ß√£o
        if (temDistribuicaoImpostos) {
          body.distribuicao_impostos = distribuicaoImpostos;
          // ‚úÖ NOVO: Adicionar processo_referencia se foi informado
          const processoInput = document.getElementById('processo-impostos-input');
          console.log('üîç DEBUG salvarClassificacoes:', {
            processoInput: processoInput,
            processoInputValue: processoInput ? processoInput.value : 'N/A',
            lancamentoSelecionado: lancamentoSelecionado,
            lancamentoSelecionadoProcesso: lancamentoSelecionado ? lancamentoSelecionado.processo : 'N/A'
          });
          
          // Tentar obter processo de v√°rias fontes
          let processoRef = null;
          if (processoInput && processoInput.value) {
            processoRef = processoInput.value.trim();
          } else if (lancamentoSelecionado && lancamentoSelecionado.processo) {
            processoRef = lancamentoSelecionado.processo.trim();
          }
          
          if (processoRef) {
            body.processo_referencia = processoRef;
            console.log('‚úÖ processo_referencia adicionado ao body:', processoRef);
          } else {
            console.warn('‚ö†Ô∏è processo_referencia n√£o encontrado!');
          }
        }
        
        // ‚úÖ NOVO: Verificar se deve usar servi√ßo V2 (robusto)
        // Pode ser ativado via localStorage ou par√¢metro na URL
        const usarV2 = localStorage.getItem('conciliacao_usar_v2') === 'true' || 
                      new URLSearchParams(window.location.search).get('v2') === 'true';
        
        const url = usarV2 
          ? '/api/banco/classificar-lancamento?v2=true'
          : '/api/banco/classificar-lancamento';
        
        if (usarV2) {
          console.log('üîí Usando servi√ßo V2 (robusto) para classifica√ß√£o');
        }
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
          statusDiv.style.background = '#e8f5e9';
          statusDiv.style.color = '#2e7d32';
          // Preferir mensagem do backend (especialmente para fluxo de impostos)
          statusDiv.innerHTML = `‚úÖ ${data.mensagem || `${classificacoes.length} classifica√ß√£o(√µes) salva(s) com sucesso!`}`;
          
          salvarBtn.disabled = false;
          salvarBtn.textContent = 'üíæ Salvar Classifica√ß√µes';
          
          // Fechar modal e atualizar lista ap√≥s 1 segundo
          setTimeout(() => {
            fecharModalClassificar();
            carregarLancamentosNaoClassificados();
          }, 1000);
        } else {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.innerHTML = `‚ùå Erro: ${data.mensagem || data.resposta || data.erro || 'Erro desconhecido'}`;
          
          salvarBtn.disabled = false;
          salvarBtn.textContent = 'üíæ Salvar Classifica√ß√µes';
        }
      } catch (error) {
        console.error('Erro ao salvar classifica√ß√£o:', error);
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = `‚ùå Erro ao salvar: ${error.message}`;
        
        salvarBtn.disabled = false;
        salvarBtn.textContent = 'üíæ Salvar Classifica√ß√µes';
      }
    }
    
    function atualizarContaCustomizada() {
      const select = document.getElementById('banco-conta-select');
      const customDiv = document.getElementById('banco-conta-custom');
      
      if (select.value === '') {
        // Conta personalizada - mostrar campos de ag√™ncia/conta (sempre BB)
        customDiv.style.display = 'grid';
      } else {
        // Conta pr√©-definida - verificar se √© Santander
        const partes = select.value.split('|');
        if (partes[0] === 'SANTANDER') {
          // Santander - n√£o precisa de ag√™ncia/conta (API j√° vinculada)
          customDiv.style.display = 'none';
        } else {
          // BB - tamb√©m n√£o precisa mostrar (j√° est√° na sele√ß√£o)
          customDiv.style.display = 'none';
        }
      }
    }
    
    // Listener para mudan√ßa na sele√ß√£o de conta
    document.getElementById('banco-conta-select').addEventListener('change', atualizarContaCustomizada);
    
    async function sincronizarExtratoBancario() {
      const statusDiv = document.getElementById('banco-sync-status');
      const syncBtn = document.getElementById('banco-sync-btn');
      const contaSelect = document.getElementById('banco-conta-select');
      const diasInput = document.getElementById('banco-dias-input');
      
      // Validar elementos
      if (!statusDiv || !syncBtn || !contaSelect || !diasInput) {
        alert('‚ùå Erro: Elementos do modal n√£o encontrados. Recarregue a p√°gina.');
        return;
      }
      
      // Desabilitar bot√£o durante sincroniza√ß√£o
      syncBtn.disabled = true;
      syncBtn.textContent = '‚è≥ Sincronizando...';
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '‚è≥ Sincronizando extratos...';
      
      try {
        // Obter banco, ag√™ncia e conta
        let banco = 'BB';  // Default
        let agencia, conta;
        
        if (!contaSelect.value || contaSelect.value === '' || contaSelect.value === null) {
          // Conta personalizada (apenas BB)
          const agenciaInput = document.getElementById('banco-agencia-input');
          const contaInput = document.getElementById('banco-conta-input');
          if (!agenciaInput || !contaInput) {
            throw new Error('Campos de ag√™ncia/conta personalizada n√£o encontrados');
          }
          agencia = agenciaInput.value.trim();
          conta = contaInput.value.trim();
          if (!agencia || !conta) {
            throw new Error('Preencha ag√™ncia e conta ou selecione uma conta pr√©-definida');
          }
          banco = 'BB';  // Conta personalizada sempre √© BB
        } else {
          // Conta pr√©-definida
          const partes = contaSelect.value.split('|');
          
          if (partes[0] === 'SANTANDER') {
            // ‚úÖ Santander - API j√° est√° vinculada √† conta, n√£o precisa de ag√™ncia/conta
            banco = 'SANTANDER';
            agencia = null;
            conta = null;
          } else {
            // Banco do Brasil (formato: "agencia|conta")
            banco = 'BB';
            agencia = partes[0];
            conta = partes[1];
          }
        }
        
        const dias = parseInt(diasInput.value) || 7;
        
        // Preparar body da requisi√ß√£o
        const body = {
          banco: banco,
          dias_retroativos: dias
        };
        
        // Adicionar ag√™ncia e conta apenas para BB
        if (banco === 'BB') {
          if (!agencia || !conta) {
            throw new Error('Ag√™ncia e conta s√£o obrigat√≥rias para Banco do Brasil');
          }
          body.agencia = agencia;
          body.conta = conta;
        }
        
        const response = await fetch('/api/banco/sincronizar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body)
        });
        
        // ‚úÖ Verificar se a resposta √© JSON antes de fazer parse
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          let errorMsg = `Servidor retornou ${response.status} (esperado JSON, recebido: ${contentType || 'text/html'})`;
          // Se for HTML, tentar extrair mensagem de erro
          if (text.includes('<title>') || text.includes('<html>')) {
            const match = text.match(/<title>(.*?)<\/title>/i) || text.match(/<h1>(.*?)<\/h1>/i);
            if (match) {
              errorMsg += `. Erro: ${match[1]}`;
            } else {
              errorMsg += `. Resposta HTML recebida (poss√≠vel erro 500 ou 404)`;
            }
          } else {
            errorMsg += `. Resposta: ${text.substring(0, 200)}`;
          }
          throw new Error(errorMsg);
        }
        
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          const text = await response.text();
          throw new Error(`Erro ao parsear JSON: ${jsonError.message}. Resposta: ${text.substring(0, 200)}`);
        }
        
        if (data.sucesso) {
          statusDiv.style.background = '#e8f5e9';
          statusDiv.style.color = '#2e7d32';
          
          let statusHTML = `‚úÖ <strong>Sincroniza√ß√£o conclu√≠da!</strong><br>`;
          statusHTML += `üìä Total processado: ${data.total || 0} lan√ßamentos<br>`;
          statusHTML += `‚úÖ Novos inseridos: ${data.novos || 0}<br>`;
          statusHTML += `‚è≠Ô∏è Duplicados (pulados): ${data.duplicados || 0}`;
          
          if (data.erros > 0) {
            statusHTML += `<br>‚ùå Erros: ${data.erros}`;
          }
          
          if (data.processos_detectados && data.processos_detectados.length > 0) {
            statusHTML += `<br><br>üîó <strong>Processos detectados automaticamente:</strong><br>`;
            data.processos_detectados.slice(0, 5).forEach(proc => {
              statusHTML += `‚Ä¢ ${proc}<br>`;
            });
            if (data.processos_detectados.length > 5) {
              statusHTML += `‚Ä¢ ... e mais ${data.processos_detectados.length - 5}`;
            }
          }
          
          statusDiv.innerHTML = statusHTML;
          
          // ‚úÖ Reabilitar bot√£o mesmo ap√≥s sucesso (antes de fechar modal)
          syncBtn.disabled = false;
          syncBtn.textContent = 'üîÑ Sincronizar';
          
          // Fechar modal ap√≥s 3 segundos
          setTimeout(() => {
            fecharModalSincronizarBanco();
            // Adicionar mensagem no chat
            adicionarMensagemChat('mAIke', data.resposta || `‚úÖ Extrato banc√°rio sincronizado com sucesso!<br>üìä ${data.novos || 0} novos lan√ßamentos inseridos.`);
          }, 3000);
        } else {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.innerHTML = `‚ùå <strong>Erro na sincroniza√ß√£o:</strong><br>${data.erro || data.mensagem || 'Erro desconhecido'}`;
          syncBtn.disabled = false;
          syncBtn.textContent = 'üîÑ Sincronizar';
        }
      } catch (error) {
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = `‚ùå <strong>Erro ao sincronizar:</strong><br>${error.message}`;
        syncBtn.disabled = false;
        syncBtn.textContent = 'üîÑ Sincronizar';
      }
    }
    
    // Fechar modal de sincroniza√ß√£o banc√°ria ao clicar fora dele ou pressionar ESC
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('modal-sync-banco');
      if (modal && event.target === modal) {
        fecharModalSincronizarBanco();
      }
    });
    
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('modal-sync-banco');
        if (modal && modal.style.display === 'flex') {
          fecharModalSincronizarBanco();
        }
      }
    });
    
    // ‚úÖ NOVO: Chat Proativo - Buscar alertas automaticamente
    let alertasLidosIds = new Set(); // IDs de alertas j√° exibidos
    let intervaloAlertas = null;
    
    // ‚úÖ Fun√ß√£o desabilitada - endpoint n√£o existe na vers√£o independente
    async function buscarEExibirAlertas() {
      // Endpoint /api/chat/alertas n√£o dispon√≠vel na vers√£o independente
      // Silenciosamente ignorar
      return;
    }
    
    // ‚úÖ Iniciar polling de alertas
    function iniciarPollingAlertas() {
      // Buscar alertas imediatamente
      buscarEExibirAlertas();
      
      // Configurar polling a cada 30 segundos
      if (intervaloAlertas) {
        clearInterval(intervaloAlertas);
      }
      intervaloAlertas = setInterval(buscarEExibirAlertas, 30000); // 30 segundos
    }
    
    // ‚úÖ Parar polling quando a p√°gina for fechada
    function pararPollingAlertas() {
      if (intervaloAlertas) {
        clearInterval(intervaloAlertas);
        intervaloAlertas = null;
      }
    }
    
    // Fun√ß√£o para formatar respostas do chat
    function formatarRespostaChat(texto) {
      if (!texto) return '';
      
      // Se j√° √© HTML (cont√©m tags), retornar como est√°
      if (texto.includes('<div') && texto.includes('</div>')) {
        texto = texto.replace(/\*{3,}/g, '');
        texto = texto.replace(/-{3,}/g, '');
        return texto;
      }
      
      // Remover separadores de linha
      const linhas = texto.split('\n');
      const linhasLimpas = linhas.filter(linha => {
        const linhaTrim = linha.trim();
        if (/^[\*\-=]{3,}$/.test(linhaTrim)) {
          return false;
        }
        return true;
      });
      texto = linhasLimpas.join('\n');
      
      // Remover separadores restantes
      texto = texto.replace(/\s*\*{3,}\s*/g, ' ');
      texto = texto.replace(/\s*-{3,}\s*/g, ' ');
      texto = texto.replace(/\s*={3,}\s*/g, ' ');
      
      // Converter markdown b√°sico para HTML
      // IMPORTANTE: Converter links ANTES de converter quebras de linha
      // Primeiro, converter links markdown [texto](url) para <a> tags (usar fun√ß√£o para evitar problemas com $)
      texto = texto.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, textoLink, url) {
        // Escapar HTML no texto do link (j√° est√° seguro, mas por precau√ß√£o)
        const textoEscapado = textoLink.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return '<a href="' + url + '" style="color:#075e54; text-decoration:underline; font-weight:500; cursor:pointer;" target="_blank" rel="noopener noreferrer">' + textoEscapado + '</a>';
      });
      
      // ‚úÖ NOVO (18/01/2026): Converter URLs diretas (https://, http://) em links clic√°veis
      // Regex para detectar URLs completas (http://, https://)
      // Evitar URLs que j√° est√£o dentro de tags <a> (verificar se n√£o h√° <a> antes sem </a>)
      const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+[^\s<>"{}|\\^`\[\].,;:!?])/gi;
      // ‚ö†Ô∏è IMPORTANTE: como h√° 1 grupo capturado na regex, a assinatura do callback √©:
      // (match, group1, offset, string)
      texto = texto.replace(urlRegex, function(match, _capturado, offset, original) {
        const url = match;
        const textoOriginal = (typeof original === 'string') ? original : String(original ?? '');
        const pos = (typeof offset === 'number') ? offset : 0;
        // Verificar se j√° n√£o est√° dentro de uma tag <a> (evitar duplica√ß√£o)
        const antes = textoOriginal.substring(0, pos);
        const ultimoAberto = antes.lastIndexOf('<a ');
        const ultimoFechado = antes.lastIndexOf('</a>');
        
        // Se h√° um <a> aberto sem fechamento antes, n√£o converter (j√° est√° em um link)
        if (ultimoAberto > ultimoFechado) {
          return url;
        }
        
        // Criar link clic√°vel
        return '<a href="' + url + '" style="color:#075e54; text-decoration:underline; font-weight:500; cursor:pointer;" target="_blank" rel="noopener noreferrer">' + url + '</a>';
      });
      
      // Depois converter outros elementos markdown
      texto = texto
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code style="background:#f5f5f5; padding:2px 4px; border-radius:3px; font-family:monospace;">$1</code>');
      
      // Converter quebras de linha POR √öLTIMO (depois de todos os outros processamentos)
      texto = texto
        .replace(/\n\n+/g, '<br>')
        .replace(/\n/g, '<br>');
      
      return texto;
    }

    // ‚úÖ Decorar processos (XXX.0000/00) no HTML gerado.
    // Faz replace apenas em trechos fora de tags para n√£o quebrar atributos/HTML.
    function decorarProcessosEmHtml(html) {
      if (!html) return html;
      const re = /\b([A-Z]{2,5}\.\d{4}\/\d{2})\b/gi;
      if (!re.test(html)) return html;
      re.lastIndex = 0;
      const parts = String(html).split(/(<[^>]+>)/g);
      for (let i = 0; i < parts.length; i++) {
        const p = parts[i] || '';
        if (!p) continue;
        if (p.startsWith('<') && p.endsWith('>')) continue;
        parts[i] = p.replace(re, '<span class="mk-proc-badge">$1</span>');
      }
      return parts.join('');
    }
    
    function formatarHora() {
      const agora = new Date();
      const horas = String(agora.getHours()).padStart(2, '0');
      const minutos = String(agora.getMinutes()).padStart(2, '0');
      return `${horas}:${minutos}`;
    }

    // ‚úÖ Decorar refer√™ncias de processo como "badge" (ex.: GLT.0010/26)
    function aplicarBadgesProcesso(rootEl) {
      if (!rootEl) return;

      // Match simples (para pr√©-checagem)
      const hasProcess = /\b[A-Z]{2,5}\.\d{4}\/\d{2}\b/;
      // Match global (para substituir)
      const re = /\b([A-Z]{2,5}\.\d{4}\/\d{2})\b/g;

      const walker = document.createTreeWalker(
        rootEl,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode: (node) => {
            try {
              const txt = node.nodeValue || '';
              if (!txt || !hasProcess.test(txt)) return NodeFilter.FILTER_REJECT;
              const p = node.parentElement;
              if (!p) return NodeFilter.FILTER_ACCEPT;
              // N√£o mexer dentro de code/pre nem dentro de um badge j√° renderizado
              if (p.closest('code, pre, .mk-proc-badge')) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            } catch (e) {
              return NodeFilter.FILTER_REJECT;
            }
          }
        },
        false
      );

      const nodes = [];
      while (walker.nextNode()) nodes.push(walker.currentNode);

      for (const node of nodes) {
        const text = node.nodeValue || '';
        re.lastIndex = 0;
        let last = 0;
        let m;
        const frag = document.createDocumentFragment();
        while ((m = re.exec(text)) !== null) {
          const full = m[1];
          if (m.index > last) {
            frag.appendChild(document.createTextNode(text.slice(last, m.index)));
          }
          const badge = document.createElement('span');
          badge.className = 'mk-proc-badge';
          badge.textContent = full;
          frag.appendChild(badge);
          last = m.index + full.length;
        }
        if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
        if (node.parentNode) node.parentNode.replaceChild(frag, node);
      }
    }
    
    // ‚úÖ NOVO: Formatar data/hora da notifica√ß√£o
    function formatarDataNotificacao(dataISO) {
      if (!dataISO) return formatarHora(); // Fallback para hora atual
      
      try {
        // ‚ö†Ô∏è Corre√ß√£o de timezone:
        // - Se vier ISO SEM timezone (ex: "2026-01-16T20:15:21"), browsers interpretam como hor√°rio local.
        // - Nosso backend √†s vezes envia timestamps em UTC *sem* sufixo/offset.
        // -> Se n√£o houver 'Z' ou offset, assumir UTC e for√ßar parse como UTC (append 'Z').
        let texto = String(dataISO).trim();
        const temTimezone = /([zZ]|[+\-]\d{2}:\d{2})$/.test(texto);
        if (!temTimezone) {
          // Normalizar "YYYY-MM-DD HH:MM:SS" -> "YYYY-MM-DDTHH:MM:SSZ"
          if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(texto)) {
            texto = texto.replace(' ', 'T');
          }
          // Se j√° tem 'T', apenas for√ßar UTC
          texto = texto + 'Z';
        }
        const data = new Date(texto);
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        const horas = String(data.getHours()).padStart(2, '0');
        const minutos = String(data.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${ano} ${horas}:${minutos}`;
      } catch (e) {
        console.warn('‚ö†Ô∏è Erro ao formatar data da notifica√ß√£o:', e);
        return formatarHora(); // Fallback
      }
    }
    
    function adicionarMensagemChat(autor, mensagem) {
      const container = document.getElementById('chat-messages');
      if (!container) return;
      
      const div = document.createElement('div');
      const isUsuario = autor === 'Usu√°rio';
      div.className = `chat-message ${isUsuario ? 'usuario' : 'assistente'}`;
      
      const hora = formatarHora();
      const jaFormatada = mensagem.includes('<div style=') && mensagem.includes('</div>');
      
      if (jaFormatada) {
        const mensagemDecorada = decorarProcessosEmHtml(mensagem);
        div.innerHTML = `
          <span class="chat-message-header">${isUsuario ? 'üë§' : 'ü§ñ'} ${autor}</span>
          <div class="chat-message-content">${mensagemDecorada}</div>
          <div class="chat-message-time">${hora}</div>
        `;
      } else {
        const mensagemFormatada = formatarRespostaChat(mensagem);
        const mensagemDecorada = decorarProcessosEmHtml(mensagemFormatada);
        div.innerHTML = `
          <span class="chat-message-header">${isUsuario ? 'üë§' : 'ü§ñ'} ${autor}</span>
          <div class="chat-message-content">${mensagemDecorada}</div>
          <div class="chat-message-time">${hora}</div>
        `;
      }
      
      container.appendChild(div);
      // ‚úÖ Aplicar "badge" para processos nas mensagens do assistente
      if (!isUsuario) {
        try {
          aplicarBadgesProcesso(div.querySelector('.chat-message-content'));
        } catch (e) {}
      }
      container.scrollTop = container.scrollHeight;
    }
    
    // ‚úÖ Fun√ß√£o para buscar contagem de consultas pendentes (desabilitada - endpoint n√£o existe na vers√£o independente)
    async function atualizarContagemConsultasPendentes() {
      // Endpoint n√£o dispon√≠vel na vers√£o independente
      // Silenciosamente ignorar erros 404
      try {
        const badge = document.getElementById('consultas-pendentes-badge');
        if (badge) badge.style.display = 'none';
      } catch (error) {
        // Ignorar silenciosamente
      }
    }
    
    // ‚úÖ Fun√ß√£o para mostrar consultas pendentes (clicar na bolinha)
    function mostrarConsultasPendentes() {
      const input = document.getElementById('chat-input');
      if (input) {
        input.value = 'quais consultas est√£o pendentes?';
        // Disparar evento de submit
        const form = document.getElementById('chat-form');
        if (form) {
          form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
      }
    }
    
    // ‚úÖ Fun√ß√£o auxiliar para enviar mensagem programaticamente (usada pelo menu)
    function enviarMensagem(mensagem) {
      const input = document.getElementById('chat-input');
      if (input && mensagem) {
        input.value = mensagem;
        // Disparar evento de submit
        const form = document.getElementById('chat-form');
        if (form) {
          const event = new Event('submit', { cancelable: true, bubbles: true });
          form.dispatchEvent(event);
        }
      }
    }
    
    // ‚úÖ Atualizar contagem ao carregar e periodicamente (desabilitado - endpoint n√£o existe)
    // ‚úÖ NOVO: Fun√ß√£o para carregar email sender do backend
    async function carregarEmailSender() {
      try {
        const response = await fetch('/api/config/email');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.config && data.config.email_sender) {
            const emailInput = document.getElementById('email-sender-input');
            if (emailInput) {
              emailInput.value = data.config.email_sender;
              emailInput.placeholder = data.config.email_sender;
            }
          }
          // ‚úÖ NOVO: Carregar mailbox de leitura do Graph
          if (data.success && data.config && data.config.email_default_mailbox) {
            const mailboxInput = document.getElementById('email-mailbox-input');
            if (mailboxInput) {
              mailboxInput.value = data.config.email_default_mailbox;
              mailboxInput.placeholder = data.config.email_default_mailbox;
            }
          }
        }
        
        // ‚úÖ NOVO (21/01/2026): Carregar configura√ß√µes do Mercante
        const mercanteResponse = await fetch('/api/config/mercante');
        if (mercanteResponse.ok) {
          const mercanteData = await mercanteResponse.json();
          if (mercanteData.success && mercanteData.config) {
            const mercanteUserInput = document.getElementById('mercante-user-input');
            if (mercanteUserInput && mercanteData.config.mercante_user) {
              mercanteUserInput.value = mercanteData.config.mercante_user;
              mercanteUserInput.placeholder = mercanteData.config.mercante_user;
            }
            // Senha n√£o √© mostrada por seguran√ßa, apenas placeholder
            const mercantePassInput = document.getElementById('mercante-pass-input');
            if (mercantePassInput) {
              if (mercanteData.config.mercante_pass_configured) {
                mercantePassInput.placeholder = 'Senha configurada (deixe em branco para manter)';
              } else {
                mercantePassInput.placeholder = 'Digite a senha do Mercante';
              }
            }
          }
        }

        // ‚úÖ NOVO (24/01/2026): Carregar configura√ß√µes de rede
        await carregarConfigRede();
      } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao carregar configura√ß√µes:', error);
      }
    }
    
    // ‚úÖ NOVO: Fun√ß√£o para salvar email sender
    async function salvarEmailSender() {
      const emailInput = document.getElementById('email-sender-input');
      const mailboxInput = document.getElementById('email-mailbox-input');
      if (!emailInput || !emailInput.value) {
        alert('Por favor, informe um email v√°lido.');
        return;
      }
      
      const emailSender = emailInput.value.trim();
      if (!emailSender.includes('@')) {
        alert('Por favor, informe um email v√°lido.');
        return;
      }

      const emailMailbox = mailboxInput ? mailboxInput.value.trim() : '';
      if (emailMailbox && !emailMailbox.includes('@')) {
        alert('Por favor, informe um email v√°lido para a caixa de leitura (Microsoft 365).');
        return;
      }
      
      try {
        const response = await fetch('/api/config/email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email_sender: emailSender,
            email_default_mailbox: emailMailbox || emailSender,
            smtp_server: 'smtp.gmail.com',
            smtp_port: 587
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('‚úÖ Email sender salvo:', emailSender);
            alert('‚úÖ Configura√ß√£o de email salva!\n\nüí° Dica: se voc√™ alterou a caixa de leitura, use "ver emails" para testar.');
            fecharModalConfig();
          } else {
            console.error('‚ùå Erro ao salvar email sender:', data.error);
            alert('‚ùå Erro ao salvar email: ' + (data.error || 'Erro desconhecido'));
          }
        } else {
          alert('‚ùå Erro ao salvar email. Tente novamente.');
        }
      } catch (error) {
        console.error('‚ùå Erro ao salvar email sender:', error);
        alert('‚ùå Erro ao salvar email: ' + error.message);
      }
    }
    
    // ‚úÖ NOVO (21/01/2026): Fun√ß√£o para carregar configura√ß√µes do Mercante
    async function carregarConfigMercante() {
      try {
        const response = await fetch('/api/config/mercante');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.config) {
            const userInput = document.getElementById('mercante-user-input');
            if (userInput && data.config.mercante_user) {
              userInput.value = data.config.mercante_user;
              userInput.placeholder = data.config.mercante_user;
            }
            const passInput = document.getElementById('mercante-pass-input');
            if (passInput) {
              if (data.config.mercante_pass_configured) {
                passInput.placeholder = 'Senha configurada (deixe em branco para manter)';
              } else {
                passInput.placeholder = 'Digite a senha do Mercante';
              }
            }
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao carregar configura√ß√µes do Mercante:', error);
      }
    }
    
    // ‚úÖ NOVO (21/01/2026): Fun√ß√£o para salvar configura√ß√µes do Mercante
    async function salvarConfigMercante() {
      const userInput = document.getElementById('mercante-user-input');
      if (!userInput || !userInput.value) {
        alert('Por favor, informe o CPF do Mercante.');
        return;
      }
      
      const mercanteUser = userInput.value.trim();
      const passInput = document.getElementById('mercante-pass-input');
      const mercantePass = (passInput && passInput.value) ? passInput.value.trim() : '';
      
      try {
        const response = await fetch('/api/config/mercante', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mercante_user: mercanteUser,
            mercante_pass: mercantePass
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('‚úÖ Configura√ß√£o do Mercante salva');
            alert('‚úÖ Configura√ß√£o do Mercante salva com sucesso!\n\n‚ö†Ô∏è IMPORTANTE: Reinicie o Flask para que as mudan√ßas tenham efeito.');
            if (passInput) passInput.value = ''; // Limpar campo de senha ap√≥s salvar
          } else {
            console.error('‚ùå Erro ao salvar configura√ß√£o do Mercante:', data.error);
            alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
          }
        } else {
          alert('‚ùå Erro ao salvar configura√ß√£o do Mercante. Tente novamente.');
        }
      } catch (error) {
        console.error('‚ùå Erro ao salvar configura√ß√£o do Mercante:', error);
        alert('‚ùå Erro ao salvar: ' + error.message);
      }
    }
    
    // ‚úÖ NOVO (21/01/2026): Fun√ß√£o para salvar todas as configura√ß√µes (Email + Mercante)
    async function salvarTodasConfigs() {
      // Mostrar loading no bot√£o de salvar
      const salvarBtn = document.querySelector('#modal-config .modal-btn-save');
      if (!salvarBtn) return;
      
      const originalText = salvarBtn.textContent;
      salvarBtn.disabled = true;
      salvarBtn.textContent = '‚è≥ Salvando...';

      try {
        await salvarEmailSender();
        await salvarConfigMercante();
        await salvarConfigRede();
        
        // ‚úÖ NOVO (24/01/2026): For√ßar recarregamento do adaptador SQL no backend
        await fetch('/api/config/network/refresh', { method: 'POST' });
        
        alert('‚úÖ Todas as configura√ß√µes foram salvas e aplicadas!');
        fecharModalConfig();
      } catch (e) {
        console.error('Erro ao salvar configura√ß√µes:', e);
        alert('‚ùå Erro ao salvar algumas configura√ß√µes. Verifique o console.');
      } finally {
        salvarBtn.disabled = false;
        salvarBtn.textContent = originalText;
      }
    }

    // ‚úÖ NOVO (24/01/2026): Carregar configura√ß√µes de rede
    async function carregarConfigRede() {
      try {
        const response = await fetch('/api/config/network');
        const data = await response.json();
        if (data.success) {
          const sqlModeSelect = document.getElementById('sql-mode-select');
          const kanbanUrlInput = document.getElementById('kanban-url-input');
          
          if (sqlModeSelect) sqlModeSelect.value = data.config.sql_server_mode || 'auto';
          if (kanbanUrlInput) kanbanUrlInput.value = data.config.kanban_api_url || '';
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar configura√ß√£o de rede:', error);
      }
    }

    // ‚úÖ NOVO (24/01/2026): Salvar configura√ß√µes de rede
    async function salvarConfigRede() {
      const sqlModeSelect = document.getElementById('sql-mode-select');
      const kanbanUrlInput = document.getElementById('kanban-url-input');
      
      if (!sqlModeSelect || !kanbanUrlInput) return;
      
      const sqlMode = sqlModeSelect.value;
      const kanbanUrl = kanbanUrlInput.value.trim();
      
      try {
        const response = await fetch('/api/config/network', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sql_server_mode: sqlMode,
            kanban_api_url: kanbanUrl
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('‚úÖ Configura√ß√£o de rede salva');
          } else {
            console.error('‚ùå Erro ao salvar configura√ß√£o de rede:', data.error);
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao salvar configura√ß√£o de rede:', error);
      }
    }
    
    // ‚úÖ NOVO (13/01/2026): Vari√°vel para armazenar arquivo anexado
    let arquivoAnexado = null;
    // ‚úÖ NOVO: Vari√°veis para grava√ß√£o de √°udio
    let mediaRecorder = null;
    let audioChunks = [];
    let gravandoAudio = false;
    let streamGravacao = null;
    
    // ‚úÖ NOVO (13/01/2026): Handler do bot√£o de anexo
    function setupAnexoHandler() {
      const attachBtn = document.getElementById('chat-attach-btn');
      const fileInput = document.getElementById('chat-file-input');
      
      if (attachBtn && fileInput) {
        attachBtn.addEventListener('click', () => {
          fileInput.click();
        });
        
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('‚ö†Ô∏è Apenas arquivos PDF s√£o permitidos');
            return;
          }
          
          // Armazenar arquivo
          arquivoAnexado = file;
          
          // Mostrar preview no chat
          adicionarMensagemChat('Usu√°rio', `üìé ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
          
          // Se mensagem cont√©m "pague esse boleto" ou similar, processar automaticamente
          const input = document.getElementById('chat-input');
          const mensagem = input.value.toLowerCase();
          if (mensagem.includes('pague') && (mensagem.includes('boleto') || mensagem.includes('esse'))) {
            await processarBoletoUpload(file);
            input.value = '';
            arquivoAnexado = null;
            fileInput.value = '';
          }
        });
      }
    }
    
    // ‚úÖ NOVO: Handler do bot√£o de microfone (mensagem de voz simples)
    function setupVoiceHandler() {
      const micBtn = document.getElementById('chat-mic-btn');
      if (!micBtn) return;
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || typeof MediaRecorder === 'undefined') {
        micBtn.style.display = 'none';
        console.warn('üé§ Navegador n√£o suporta grava√ß√£o de √°udio (MediaRecorder). Bot√£o de voz ocultado.');
        return;
      }
      
      micBtn.addEventListener('click', async () => {
        // Iniciar grava√ß√£o
        if (!gravandoAudio) {
          try {
            streamGravacao = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = [];
            
            mediaRecorder = new MediaRecorder(streamGravacao);
            mediaRecorder.ondataavailable = (event) => {
              if (event.data && event.data.size > 0) {
                audioChunks.push(event.data);
              }
            };
            
            mediaRecorder.onstop = async () => {
              try {
                micBtn.classList.remove('recording');
                micBtn.textContent = 'üé§';
                
                if (audioChunks.length === 0) {
                  return;
                }
                
                const mimeType = mediaRecorder && mediaRecorder.mimeType ? mediaRecorder.mimeType : 'audio/webm';
                const blob = new Blob(audioChunks, { type: mimeType });
                if (blob.size === 0) {
                  return;
                }
                
                await enviarMensagemVoz(blob);
              } catch (error) {
                console.error('‚ùå Erro ao processar √°udio gravado:', error);
                adicionarMensagemChat('mAIke', `‚ùå Erro ao processar √°udio gravado: ${error.message || error}`);
              } finally {
                if (streamGravacao) {
                  try {
                    streamGravacao.getTracks().forEach(t => t.stop());
                  } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao parar stream de grava√ß√£o:', e);
                  }
                  streamGravacao = null;
                }
                mediaRecorder = null;
                gravandoAudio = false;
              }
            };
            
            mediaRecorder.start();
            gravandoAudio = true;
            micBtn.classList.add('recording');
            micBtn.textContent = '‚èπ';
          } catch (error) {
            console.error('‚ùå Erro ao acessar microfone:', error);
            alert('N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes do navegador.');
            if (streamGravacao) {
              try {
                streamGravacao.getTracks().forEach(t => t.stop());
              } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao parar stream ap√≥s falha de permiss√£o:', e);
              }
              streamGravacao = null;
            }
            mediaRecorder = null;
            gravandoAudio = false;
            micBtn.classList.remove('recording');
            micBtn.textContent = 'üé§';
          }
        } else {
          // Parar grava√ß√£o
          try {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
              mediaRecorder.stop();
            }
          } catch (error) {
            console.error('‚ö†Ô∏è Erro ao parar grava√ß√£o de √°udio:', error);
          }
        }
      });
    }
    
    // ‚úÖ NOVO: Enviar mensagem de voz para o backend
    async function enviarMensagemVoz(blob) {
      const mensagensContainer = document.getElementById('chat-messages');
      if (!mensagensContainer) return;
      
      // Mostrar loading no chat
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'chat-loading-voice';
      loadingDiv.className = 'chat-loading';
      loadingDiv.innerHTML = '<span class="chat-message-header">ü§ñ mAIke</span><div class="chat-message-content">üé§ Transcrevendo sua mensagem de voz...</div><div class="chat-message-time">' + formatarHora() + '</div>';
      mensagensContainer.appendChild(loadingDiv);
      mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
      
      try {
        const formData = new FormData();
        formData.append('audio', blob, 'mensagem-voz.webm');
        formData.append('session_id', obterSessionId());
        formData.append('language', 'pt');
        
        const response = await fetch('/api/chat/voice', {
          method: 'POST',
          body: formData
        });
        
        const resultado = await response.json().catch(() => ({}));
        
        if (loadingDiv && loadingDiv.parentNode) {
          loadingDiv.parentNode.removeChild(loadingDiv);
        }
        
        if (!response.ok || !resultado || resultado.sucesso === false) {
          const msgErro = (resultado && (resultado.mensagem || resultado.erro)) || 'Erro ao processar mensagem de voz.';
          adicionarMensagemChat('mAIke', `‚ùå ${msgErro}`);
          return;
        }
        
        const textoUsuario = (resultado.texto_usuario || '').trim();
        const resposta = (resultado.resposta || '').trim();
        
        if (textoUsuario) {
          adicionarMensagemChat('Usu√°rio', textoUsuario);
        } else {
          adicionarMensagemChat('Usu√°rio', 'üé§ (mensagem de voz)');
        }
        
        if (resposta) {
          adicionarMensagemChat('mAIke', resposta);
        }
        
        if (resultado.audio_url) {
          try {
            const audio = new Audio(resultado.audio_url);
            audio.play().catch(err => {
              console.warn('‚ö†Ô∏è N√£o foi poss√≠vel reproduzir √°udio TTS:', err);
            });
          } catch (e) {
            console.warn('‚ö†Ô∏è Erro ao criar √°udio TTS:', e);
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao enviar mensagem de voz:', error);
        if (loadingDiv && loadingDiv.parentNode) {
          loadingDiv.parentNode.removeChild(loadingDiv);
        }
        adicionarMensagemChat('mAIke', `‚ùå Erro ao enviar mensagem de voz: ${error.message || error}`);
      }
    }
    
    // ‚úÖ NOVO (13/01/2026): Fun√ß√£o auxiliar para obter sessionId
    function obterSessionId() {
      let sessionId = localStorage.getItem('chat-session-id');
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chat-session-id', sessionId);
      }
      return sessionId;
    }
    
    // ‚úÖ NOVO (13/01/2026): Processar upload de boleto
    async function processarBoletoUpload(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('session_id', obterSessionId());
      
      // Mostrar loading
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'chat-loading';
      loadingDiv.className = 'chat-loading';
      loadingDiv.innerHTML = '<span class="chat-message-header">ü§ñ mAIke</span><div class="chat-message-content">üìÑ Processando boleto...</div><div class="chat-message-time">' + formatarHora() + '</div>';
      document.getElementById('chat-messages').appendChild(loadingDiv);
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
      
      try {
        const response = await fetch('/api/banco/upload-boleto', {
          method: 'POST',
          body: formData
        });
        
        const resultado = await response.json();
        
        // Remover loading
        const loading = document.getElementById('chat-loading');
        if (loading) loading.remove();
        
        if (resultado.sucesso) {
          const dados = resultado.dados || {};
          
          // ‚úÖ CORRE√á√ÉO: Se o agent retornou resposta formatada, usar ela
          if (resultado.resposta) {
            adicionarMensagemChat('mAIke', resultado.resposta);
          } else {
            // Fallback: formatar resposta manualmente
            let resposta = `üìÑ **Boleto Processado!**\n\n`;
            resposta += `**C√≥digo de Barras:** \`${dados.codigo_barras || 'N/A'}\`\n`;
            resposta += `**Valor:** R$ ${(dados.valor || 0).toFixed(2).replace('.', ',')}\n`;
            if (dados.vencimento) {
              resposta += `**Vencimento:** ${dados.vencimento}\n`;
            }
            if (dados.beneficiario) {
              resposta += `**Benefici√°rio:** ${dados.beneficiario}\n`;
            }
            if (dados.saldo_disponivel !== null && dados.saldo_disponivel !== undefined) {
              resposta += `\n**Saldo Dispon√≠vel:** R$ ${dados.saldo_disponivel.toFixed(2).replace('.', ',')}\n`;
              resposta += `**Saldo Ap√≥s Pagamento:** R$ ${dados.saldo_apos_pagamento.toFixed(2).replace('.', ',')}\n`;
              
              if (dados.saldo_disponivel < dados.valor) {
                resposta += `\n‚ö†Ô∏è **Saldo insuficiente!**`;
              } else {
                resposta += `\nüí° **Pronto para pagar!**`;
              }
            }
            adicionarMensagemChat('mAIke', resposta);
          }
          
          // ‚úÖ NOVO: Se pagamento foi iniciado automaticamente, mostrar mensagem adicional
          if (resultado.pagamento_iniciado && resultado.payment_id) {
            setTimeout(() => {
              adicionarMensagemChat('mAIke', `üí° **Pagamento iniciado automaticamente!**\n\nDigite **"continue o pagamento"** para autorizar o pagamento de R$ ${(dados.valor || 0).toFixed(2).replace('.', ',')}.`);
            }, 1000);
          }
          
          // Se tem saldo suficiente, abrir modal de aprova√ß√£o (se n√£o foi iniciado automaticamente)
          if (resultado.acao === 'aprovar_pagamento' && !resultado.pagamento_iniciado && dados.saldo_disponivel >= dados.valor) {
            setTimeout(() => abrirModalAprovacaoBoleto(dados), 500);
          }
        } else {
          let erroMsg = `‚ùå **Erro ao processar boleto:** ${resultado.erro || 'Erro desconhecido'}`;
          
          // Se for PDF escaneado, adicionar sugest√£o
          if (resultado.sugestao === 'fornecer_dados_manuais' || resultado.erro.includes('escaneado') || resultado.erro.includes('n√£o retornou texto')) {
            erroMsg += '\n\nüí° **Alternativa:** Voc√™ pode me fornecer os dados manualmente:\n';
            erroMsg += '- C√≥digo de barras (44 ou 47 d√≠gitos)\n';
            erroMsg += '- Valor do boleto\n';
            erroMsg += '- Data de vencimento (opcional)\n\n';
            erroMsg += 'Exemplo: "pague boleto c√≥digo 34191093216412992293280145580009313510000090000 valor 900.00"';
          }
          
          adicionarMensagemChat('mAIke', erroMsg);
        }
      } catch (error) {
        const loading = document.getElementById('chat-loading');
        if (loading) loading.remove();
        adicionarMensagemChat('mAIke', `‚ùå **Erro ao processar boleto:** ${error.message}`);
        throw error; // Re-lan√ßar para que o catch externo possa tratar
      }
    }
    
    // ‚úÖ NOVO (13/01/2026): Vari√°vel global para dados do boleto em aprova√ß√£o
    let dadosBoletoAprovacao = null;
    
    // ‚úÖ NOVO (13/01/2026): Abrir modal de aprova√ß√£o de pagamento
    function abrirModalAprovacaoBoleto(dados) {
      dadosBoletoAprovacao = dados;
      const modal = document.getElementById('modal-aprovar-boleto');
      const dadosDiv = document.getElementById('boleto-dados-aprovacao');
      
      if (!modal || !dadosDiv) return;
      
      // Preencher dados
      let html = '<div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin-bottom: 16px;">';
      html += '<div style="margin-bottom: 8px;"><strong>C√≥digo de Barras:</strong><br><code style="font-size: 12px; word-break: break-all;">' + dados.codigo_barras + '</code></div>';
      html += '<div style="margin-bottom: 8px;"><strong>Valor:</strong> R$ ' + dados.valor.toFixed(2).replace('.', ',') + '</div>';
      if (dados.vencimento) {
        html += '<div style="margin-bottom: 8px;"><strong>Vencimento:</strong> ' + dados.vencimento + '</div>';
      }
      if (dados.beneficiario) {
        html += '<div style="margin-bottom: 8px;"><strong>Benefici√°rio:</strong> ' + dados.beneficiario + '</div>';
      }
      if (dados.saldo_disponivel !== null && dados.saldo_disponivel !== undefined) {
        html += '<hr style="margin: 12px 0; border: none; border-top: 1px solid #ddd;">';
        html += '<div style="margin-bottom: 8px;"><strong>Saldo Dispon√≠vel:</strong> R$ ' + dados.saldo_disponivel.toFixed(2).replace('.', ',') + '</div>';
        html += '<div><strong>Saldo Ap√≥s Pagamento:</strong> R$ ' + dados.saldo_apos_pagamento.toFixed(2).replace('.', ',') + '</div>';
      }
      html += '</div>';
      
      dadosDiv.innerHTML = html;
      
      // Mostrar modal
      modal.style.display = 'flex';
    }
    
    // ‚úÖ NOVO (13/01/2026): Fechar modal de aprova√ß√£o
    function fecharModalAprovacaoBoleto() {
      const modal = document.getElementById('modal-aprovar-boleto');
      if (modal) {
        modal.style.display = 'none';
      }
      dadosBoletoAprovacao = null;
    }
    
    // ‚úÖ NOVO (13/01/2026): Confirmar e processar pagamento
    async function confirmarPagamentoBoleto() {
      if (!dadosBoletoAprovacao) {
        alert('‚ùå Dados do boleto n√£o encontrados');
        return;
      }
      
      const btn = document.getElementById('aprovar-boleto-btn');
      const statusDiv = document.getElementById('boleto-status-aprovacao');
      
      if (btn) btn.disabled = true;
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#fff3cd';
        statusDiv.style.color = '#856404';
        statusDiv.textContent = '‚è≥ Processando pagamento...';
      }
      
      try {
        // 1. Iniciar pagamento
        const paymentId = 'boleto-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const hoje = new Date().toISOString().split('T')[0];
        
        const iniciarResponse = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mensagem: `iniciar pagamento de boleto com payment_id ${paymentId} c√≥digo ${dadosBoletoAprovacao.codigo_barras} data ${hoje}`,
            session_id: obterSessionId()
          })
        });
        
        const iniciarData = await iniciarResponse.json();
        
        if (!iniciarData.resposta || iniciarData.resposta.includes('‚ùå')) {
          throw new Error(iniciarData.resposta || 'Erro ao iniciar pagamento');
        }
        
        // 2. Efetivar pagamento
        const efetivarResponse = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mensagem: `efetivar pagamento de boleto ${paymentId} valor ${dadosBoletoAprovacao.valor}`,
            session_id: obterSessionId()
          })
        });
        
        const efetivarData = await efetivarResponse.json();
        
        if (efetivarData.resposta && !efetivarData.resposta.includes('‚ùå')) {
          // Sucesso!
          if (statusDiv) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.textContent = '‚úÖ Pagamento efetivado com sucesso!';
          }
          
          // Mostrar resposta no chat
          adicionarMensagemChat('mAIke', efetivarData.resposta);
          
          // Fechar modal ap√≥s 2 segundos
          setTimeout(() => {
            fecharModalAprovacaoBoleto();
          }, 2000);
        } else {
          throw new Error(efetivarData.resposta || 'Erro ao efetivar pagamento');
        }
      } catch (error) {
        if (statusDiv) {
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.color = '#721c24';
          statusDiv.textContent = '‚ùå Erro: ' + error.message;
        }
        if (btn) btn.disabled = false;
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Desabilitado: endpoint n√£o existe na vers√£o independente
      // atualizarContagemConsultasPendentes();
      // setInterval(atualizarContagemConsultasPendentes, 30000);
      
      // ‚úÖ NOVO: Carregar modelo inicial e atualizar indicador
      carregarModeloInicial();
      
      // ‚úÖ NOVO: Carregar PTAX no cabe√ßalho
      carregarPTAX();
      
      // ‚úÖ Adicionar hora na mensagem inicial
      const initialTime = document.getElementById('initial-message-time');
      if (initialTime) {
        initialTime.textContent = formatarHora();
      }
      
      // ‚úÖ NOVO (13/01/2026): Setup handler de anexo
      setupAnexoHandler();
      // ‚úÖ NOVO: Setup handler de voz
      setupVoiceHandler();
    });
    
    window.enviarMensagemChat = async function(event) {
      event.preventDefault();
      const input = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send-btn');
      const fileInput = document.getElementById('chat-file-input');
      const mensagem = input.value.trim();
      
      // ‚úÖ NOVO (13/01/2026): Se h√° arquivo anexado e mensagem sobre boleto, processar upload
      if (arquivoAnexado && mensagem.toLowerCase().includes('pague') && (mensagem.toLowerCase().includes('boleto') || mensagem.toLowerCase().includes('esse'))) {
        // Desabilitar bot√£o durante processamento
        input.disabled = true;
        sendBtn.disabled = true;
        
        try {
          await processarBoletoUpload(arquivoAnexado);
        } catch (error) {
          console.error('Erro ao processar boleto:', error);
          adicionarMensagemChat('mAIke', `‚ùå **Erro ao processar boleto:** ${error.message}`);
        } finally {
          // Reabilitar bot√£o
          input.disabled = false;
          sendBtn.disabled = false;
          input.value = '';
          arquivoAnexado = null;
          if (fileInput) fileInput.value = '';
        }
        return;
      }
      
      if (!mensagem) return;
      
      // Adicionar mensagem do usu√°rio
      adicionarMensagemChat('Usu√°rio', mensagem);
      input.value = '';
      
      // Limpar arquivo anexado ap√≥s enviar mensagem
      arquivoAnexado = null;
      if (fileInput) fileInput.value = '';
      input.disabled = true;
      sendBtn.disabled = true;
      
      // Indicador de carregamento
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'chat-loading';
      loadingDiv.className = 'chat-loading';
      loadingDiv.innerHTML = '<span class="chat-message-header">ü§ñ mAIke</span><div class="chat-message-content">Pensando...</div><div class="chat-message-time">' + formatarHora() + '</div>';
      document.getElementById('chat-messages').appendChild(loadingDiv);
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
      
      const mensagemLower = mensagem.toLowerCase();
      const comandoDireto = /(?:registr[ae]r?\s+(?:a\s+)?(?:duimp|o\s+duimp)|cri[ae]r?\s+duimp|ger[ae]r?\s+duimp|fazer\s+duimp)/.test(mensagemLower);
      
      // ‚úÖ NOVO: Obter modelo selecionado
      // PRIORIDADE: Backend (.env) > localStorage > padr√£o
      let modelSelecionado = localStorage.getItem('chat-ia-model') || '';
      if (!modelSelecionado) {
        // Tentar buscar do backend se n√£o tiver no localStorage
        try {
          const configResponse = await fetch('/api/config');
          if (configResponse.ok) {
            const config = await configResponse.json();
            if (config.model) {
              modelSelecionado = config.model;
              localStorage.setItem('chat-ia-model', config.model);
            }
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Erro ao buscar modelo do backend:', e);
        }
        // Fallback final
        if (!modelSelecionado) {
          modelSelecionado = 'gpt-3.5-turbo'; // Padr√£o
        }
      }
      
      // ‚úÖ Temperatura padr√£o (0.5)
      const temperatureSelecionada = '0.5';
      
      // ‚úÖ Atualizar indicador do modelo no cabe√ßalho
      atualizarIndicadorModelo(modelSelecionado);
      
      // ‚úÖ NOVO: Obter session_id
      const sessionId = obterSessionId();
      
      // ‚úÖ STREAMING: Usar endpoint de streaming
      let fullResponse = '';
      let toolCalls = null;
      let finalResponse = '';
      
      try {
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              mensagem: mensagem,
              historico: chatHistorico.slice(-5),
              executar_acao: comandoDireto,
              model: modelSelecionado || null,
              temperature: temperatureSelecionada ? parseFloat(temperatureSelecionada) : null,
              session_id: sessionId
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // ‚úÖ STREAMING: Processar Server-Sent Events
          console.log('üîÑ Iniciando streaming...');
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let chunkCount = 0;
          
          // Criar mensagem vazia para streaming
          const messageId = Date.now();
          const messageElement = adicionarMensagemChat('mAIke', '<div id="streaming-' + messageId + '">üí≠ Pensando...</div>');
          const streamingDiv = document.getElementById('streaming-' + messageId);
          
          if (!streamingDiv) {
            console.error('‚ùå Erro: streamingDiv n√£o encontrado');
            throw new Error('Elemento de streaming n√£o encontrado');
          }
          
          // ‚úÖ Parser SSE mais robusto: suporta eventos com m√∫ltiplas linhas "data:"
          // (alguns ambientes podem quebrar linhas longas, e o parser antigo assumia 1 linha por evento)
          let eventDataBuffer = '';
          let shouldExitStreamLoop = false;

          async function processarEventoSSE(jsonStr) {
            try {
              const data = JSON.parse(jsonStr);
              chunkCount++;

              if (data.chunk) {
                fullResponse += data.chunk;
                if (streamingDiv) {
                  // ‚úÖ Aplicar badge de processo Paging/Streaming
                  const html = decorarProcessosEmHtml(formatarRespostaChat(fullResponse));
                  streamingDiv.innerHTML = html;
                  try { aplicarBadgesProcesso(streamingDiv); } catch (e) {}
                  const chatContainer = document.getElementById('chat-messages');
                  if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                }
              }

              if (data.tool_calls) {
                toolCalls = data.tool_calls;
              }

              if (data.comando_interface) {
                const comando = data.comando_interface;
                switch(comando.acao) {
                  case 'abrir_menu':
                    abrirMenuDrawer();
                    if (streamingDiv) streamingDiv.innerHTML = '‚úÖ Menu aberto! Escolha uma op√ß√£o.';
                    break;
                  case 'abrir_concilia√ß√£o':
                    fecharMenuDrawer();
                    setTimeout(() => abrirModalConciliacao(), 300);
                    if (streamingDiv) streamingDiv.innerHTML = '‚úÖ Abrindo concilia√ß√£o banc√°ria...';
                    break;
                  case 'abrir_sincroniza√ß√£o':
                    fecharMenuDrawer();
                    setTimeout(() => abrirModalSincronizarBanco(), 300);
                    if (streamingDiv) streamingDiv.innerHTML = '‚úÖ Abrindo sincroniza√ß√£o de extratos...';
                    break;
                  case 'abrir_legisla√ß√£o':
                    fecharMenuDrawer();
                    setTimeout(() => abrirModalImportarLegislacao(), 300);
                    if (streamingDiv) streamingDiv.innerHTML = '‚úÖ Abrindo importa√ß√£o de legisla√ß√£o...';
                    break;
                  case 'abrir_config':
                    fecharMenuDrawer();
                    setTimeout(() => abrirModalConfig(), 300);
                    if (streamingDiv) streamingDiv.innerHTML = '‚úÖ Abrindo configura√ß√µes...';
                    break;
                  default:
                    if (streamingDiv) streamingDiv.innerHTML = data.resposta || '‚úÖ Comando executado!';
                }
                return { stop: true };
              }

              if (data.done) {
                finalResponse = data.resposta_final || fullResponse;
                if (data.resposta_final && data.resposta_final !== fullResponse) {
                  fullResponse = data.resposta_final;
                  finalResponse = data.resposta_final;
                }
                if (streamingDiv) {
                  const html = decorarProcessosEmHtml(formatarRespostaChat(finalResponse));
                  streamingDiv.innerHTML = html;
                  try { aplicarBadgesProcesso(streamingDiv); } catch (e) {}
                }
                return { done: true };
              }

              if (data.error) {
                if (streamingDiv) {
                  const html = decorarProcessosEmHtml(formatarRespostaChat(fullResponse + '\n\n‚ùå Erro: ' + data.error));
                  streamingDiv.innerHTML = html;
                  try { aplicarBadgesProcesso(streamingDiv); } catch (e) {}
                }
                return { done: true };
              }
            } catch (e) {
              console.error('‚ùå Erro ao processar evento SSE:', e, jsonStr.substring(0, 120));
            }
            return {};
          }

          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              // ‚úÖ Flush final: se a conex√£o fechar sem linha vazia final, tentar processar o que sobrou
              try {
                // Se ainda tem algo no buffer, tratar como linha √∫nica pendente
                if (buffer && buffer.trim().length > 0) {
                  const maybeLine = buffer;
                  if (maybeLine.startsWith('data:')) {
                    const payload = maybeLine.replace(/^data:\s?/, '');
                    eventDataBuffer += payload;
                  }
                  buffer = '';
                }
                if (eventDataBuffer) {
                  await processarEventoSSE(eventDataBuffer);
                  eventDataBuffer = '';
                }
              } catch (e) {
                console.warn('‚ö†Ô∏è Flush final do SSE falhou:', e);
              }
              break;
            }

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';

            for (const line of lines) {
              // SSE: linha vazia delimita fim do evento
              if (line.trim() === '') {
                if (eventDataBuffer) {
                  const resultado = await processarEventoSSE(eventDataBuffer);
                  eventDataBuffer = '';
                  if (resultado.stop || resultado.done) {
                    // For√ßar sa√≠da limpa do while/for
                    buffer = '';
                    shouldExitStreamLoop = true;
                    break;
                  }
                }
                continue;
              }

              // SSE: pode vir como "data: ..." ou "data:..."
              if (line.startsWith('data:')) {
                const payload = line.replace(/^data:\s?/, '');
                eventDataBuffer += payload;
              }
            }

            // ‚úÖ Se j√° recebemos done/stop, sair do loop de leitura imediatamente
            if (shouldExitStreamLoop) {
              break;
            }
          }
          
          // Remover indicador de carregamento
          const loading = document.getElementById('chat-loading');
          if (loading) loading.remove();
          
          // ‚úÖ Processar resposta final
          const data = {
            sucesso: true,
            resposta: finalResponse || fullResponse,
            tool_calls: toolCalls
          };
          
          if (data.sucesso) {
            // ‚úÖ NOVO: Se solicitar nome, destacar a mensagem
            if (data.solicitar_nome) {
              let resposta = formatarRespostaChat(data.resposta);
              adicionarMensagemChat('mAIke', resposta);
              // ‚úÖ NOVO: Incluir _resultado_interno no hist√≥rico para recuperar estado (email, etc)
              chatHistorico.push({ 
                mensagem, 
                resposta: data.resposta,
                _resultado_interno: data._resultado_interno || {}  // ‚úÖ Incluir resultado interno
              });
              return; // N√£o processar mais nada nesta mensagem
            }
            
            // ‚úÖ STREAMING: A resposta j√° foi adicionada e atualizada durante o streaming
            // N√£o precisa adicionar novamente - apenas garantir que est√° formatada corretamente
            // O streamingDiv j√° cont√©m a resposta formatada
            
            // ‚úÖ CR√çTICO: Se o contexto foi limpo, limpar o hist√≥rico do frontend tamb√©m
            if (data.limpar_historico_frontend || data.contexto_limpo) {
              console.log('‚úÖ Contexto limpo detectado - limpando hist√≥rico do frontend');
              chatHistorico = [];  // Limpar hist√≥rico completamente
            } else {
              // ‚úÖ NOVO: Incluir _resultado_interno no hist√≥rico para recuperar estado (email, etc)
              chatHistorico.push({ 
                mensagem, 
                resposta: data.resposta,
                _resultado_interno: data._resultado_interno || {}  // ‚úÖ Incluir resultado interno
              });
            }
          } else {
            const erroMsg = data.mensagem || data.erro || 'Erro desconhecido';
            adicionarMensagemChat('mAIke', `‚ùå Erro: ${erroMsg}`);
          }
        } catch (streamError) {
          // Erro no streaming - tentar fallback para endpoint normal
          console.warn('Erro no streaming, tentando endpoint normal:', streamError);
          const loading = document.getElementById('chat-loading');
          if (loading) loading.remove();
          
          // Fallback para endpoint normal
          try {
            const response = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                mensagem: mensagem,
                historico: chatHistorico.slice(-5),
                executar_acao: comandoDireto,
                model: modelSelecionado || null,
                temperature: temperatureSelecionada ? parseFloat(temperatureSelecionada) : null,
                session_id: sessionId
              })
            });
            
            const data = await response.json();
            
            // ‚úÖ NOVO: Detectar e executar comandos de interface
            if (data.comando_interface) {
              const comando = data.comando_interface;
              console.log('üéØ Comando de interface detectado:', comando);
              
              // Executar a√ß√£o correspondente
              switch(comando.acao) {
                case 'abrir_menu':
                  abrirMenuDrawer();
                  adicionarMensagemChat('mAIke', '‚úÖ Menu aberto! Escolha uma op√ß√£o.');
                  break;
                case 'abrir_concilia√ß√£o':
                  fecharMenuDrawer();
                  setTimeout(() => abrirModalConciliacao(), 300);
                  adicionarMensagemChat('mAIke', '‚úÖ Abrindo concilia√ß√£o banc√°ria...');
                  break;
                case 'abrir_sincroniza√ß√£o':
                  fecharMenuDrawer();
                  setTimeout(() => abrirModalSincronizarBanco(), 300);
                  adicionarMensagemChat('mAIke', '‚úÖ Abrindo sincroniza√ß√£o de extratos...');
                  break;
                case 'abrir_legisla√ß√£o':
                  fecharMenuDrawer();
                  setTimeout(() => abrirModalImportarLegislacao(), 300);
                  adicionarMensagemChat('mAIke', '‚úÖ Abrindo importa√ß√£o de legisla√ß√£o...');
                  break;
                case 'abrir_config':
                  fecharMenuDrawer();
                  setTimeout(() => abrirModalConfig(), 300);
                  adicionarMensagemChat('mAIke', '‚úÖ Abrindo configura√ß√µes...');
                  break;
                default:
                  adicionarMensagemChat('mAIke', data.resposta || '‚úÖ Comando executado!');
              }
              return; // N√£o processar como resposta normal
            }
            
            if (data.sucesso) {
              // ‚úÖ CR√çTICO: Se o contexto foi limpo, limpar o hist√≥rico do frontend tamb√©m
              if (data.limpar_historico_frontend || data.contexto_limpo) {
                console.log('‚úÖ Contexto limpo detectado - limpando hist√≥rico do frontend');
                chatHistorico = [];  // Limpar hist√≥rico completamente
              } else {
                // ‚úÖ NOVO: Incluir _resultado_interno no hist√≥rico para recuperar estado (email, etc)
                chatHistorico.push({ 
                  mensagem, 
                  resposta: data.resposta,
                  _resultado_interno: data._resultado_interno || {}  // ‚úÖ Incluir resultado interno
                });
              }
              
              let resposta = formatarRespostaChat(data.resposta);
              adicionarMensagemChat('mAIke', resposta);
            } else {
              const erroMsg = data.mensagem || data.erro || 'Erro desconhecido';
              adicionarMensagemChat('mAIke', `‚ùå Erro: ${erroMsg}`);
            }
          } catch (fallbackError) {
            adicionarMensagemChat('mAIke', `‚ùå Erro ao processar mensagem: ${fallbackError.message}`);
          }
        } finally {
          input.disabled = false;
          sendBtn.disabled = false;
          input.focus();
        }
    };
    
    function fecharChat() {
      // Voltar para a aplica√ß√£o principal
      if (window.opener) {
        // Se foi aberto em nova janela, fechar
        window.close();
      } else {
        // Se n√£o, redirecionar para a aplica√ß√£o principal
        window.location.href = '/';
      }
    }
    
    // ‚úÖ NOVO: Gerar ou recuperar session_id
    function obterSessionId() {
      let sessionId = localStorage.getItem('chat-session-id');
      if (!sessionId) {
        // Gerar ID √∫nico baseado em timestamp + random
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chat-session-id', sessionId);
      }
      return sessionId;
    }
    
    // Verificar status do servi√ßo ao carregar
    document.addEventListener('DOMContentLoaded', async () => {
      // ‚úÖ NOVO: Verificar se √© primeira vez (sem nome) e mostrar mensagem de boas-vindas
      const sessionId = obterSessionId();
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            mensagem: 'teste',
            session_id: sessionId
          })
        });
        const data = await response.json();
        const statusDiv = document.getElementById('chat-status');
        if (statusDiv) {
          if (data.erro === 'IA_DESABILITADA') {
            statusDiv.className = 'chat-status error';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '‚ö†Ô∏è Servi√ßo de IA n√£o est√° habilitado. Configure DUIMP_AI_ENABLED=true e DUIMP_AI_API_KEY no arquivo .env';
          } else {
            statusDiv.style.display = 'none';
          }
        }
        
        // ‚úÖ NOVO: Se solicitar nome, mostrar mensagem de boas-vindas
        if (data.solicitar_nome) {
          adicionarMensagemChat('mAIke', data.resposta);
        }
      } catch (e) {
        console.error('Erro ao verificar status do chat:', e);
      }
      
      // ‚úÖ NOVO: Polling de notifica√ß√µes de processos
      iniciarPollingNotificacoes();
      
      // Focar no input
      document.getElementById('chat-input').focus();
    });
    
    // ‚úÖ NOVO: Polling de notifica√ß√µes de processos
    let pollingNotificacoesInterval = null;
    let notificacoesLidas = new Set(); // IDs de notifica√ß√µes j√° exibidas
    
    // ‚úÖ NOVO: Fila de reprodu√ß√£o de √°udio TTS
    class AudioQueue {
      constructor() {
        this.queue = [];
        this.isPlaying = false;
        this.currentAudio = null;
        this.userMuted = localStorage.getItem('tts_muted') === 'true'; // Lembrar prefer√™ncia
        this.volume = parseFloat(localStorage.getItem('tts_volume') || '1.0'); // Volume padr√£o: 100%
      }
      
      // Adicionar notifica√ß√£o √† fila
      addNotification(notificacao) {
        if (!notificacao.audio_url) {
          console.warn('‚ö†Ô∏è AudioQueue: Notifica√ß√£o sem audio_url:', notificacao);
          return;
        }
        
        if (this.userMuted) {
          console.log('üîá AudioQueue: Usu√°rio mutado, ignorando √°udio');
          return;
        }
        
        console.log(`üéµ AudioQueue: Adicionando √°udio √† fila - ${notificacao.audio_url}`);
        
        this.queue.push({
          id: notificacao.id,
          audioUrl: notificacao.audio_url,
          titulo: notificacao.titulo,
          prioridade: this._calcularPrioridade(notificacao)
        });
        
        // Ordenar por prioridade (maior primeiro)
        this.queue.sort((a, b) => b.prioridade - a.prioridade);
        
        // Iniciar reprodu√ß√£o se n√£o estiver tocando
        if (!this.isPlaying) {
          this.playNext();
        }
      }
      
      // Reproduzir pr√≥ximo da fila
      async playNext() {
        if (this.isPlaying || this.queue.length === 0) {
          if (this.isPlaying) {
            console.log('üéµ AudioQueue: J√° est√° tocando, aguardando...');
          } else {
            console.log('üéµ AudioQueue: Fila vazia');
          }
          return;
        }
        
        this.isPlaying = true;
        const item = this.queue.shift();
        
        try {
          // Construir URL completa se necess√°rio
          let audioUrl = item.audioUrl;
          if (!audioUrl.startsWith('http')) {
            // URL relativa, adicionar origem
            audioUrl = window.location.origin + audioUrl;
          }
          
          console.log(`üéµ AudioQueue: Reproduzindo √°udio: ${audioUrl}`);
          
          this.currentAudio = new Audio(audioUrl);
          this.currentAudio.volume = this.volume;
          
          // Eventos
          this.currentAudio.onended = () => {
            console.log(`‚úÖ AudioQueue: √Åudio finalizado - ${item.titulo}`);
            this.isPlaying = false;
            this.currentAudio = null;
            // Pausa de 500ms entre notifica√ß√µes
            setTimeout(() => this.playNext(), 500);
          };
          
          this.currentAudio.onerror = (error) => {
            console.error('‚ùå AudioQueue: Erro ao reproduzir √°udio:', item.audioUrl, error);
            this.isPlaying = false;
            this.currentAudio = null;
            this.playNext(); // Pula para pr√≥xima
          };
          
          this.currentAudio.onloadstart = () => {
            console.log('üì• AudioQueue: Carregando √°udio...');
          };
          
          this.currentAudio.oncanplay = () => {
            console.log('‚úÖ AudioQueue: √Åudio pronto para reproduzir');
          };
          
          // ‚úÖ CORRE√á√ÉO: Tentar reproduzir com tratamento de autoplay policy
          console.log(`üîç DEBUG AudioQueue: Tentando reproduzir √°udio - audioUnlocked: ${window.audioUnlocked || false}`);
          
          // ‚úÖ CORRE√á√ÉO: Se √°udio n√£o est√° desbloqueado, n√£o tentar reproduzir automaticamente
          // Aguardar intera√ß√£o do usu√°rio (que vai desbloquear e reproduzir)
          if (!window.audioUnlocked) {
            console.warn('‚ö†Ô∏è AudioQueue: √Åudio n√£o desbloqueado. Aguardando intera√ß√£o do usu√°rio...');
            console.log('üí° Clique em qualquer lugar da p√°gina para habilitar √°udio');
            // N√£o tentar reproduzir ainda - aguardar intera√ß√£o do usu√°rio
            // O √°udio ser√° reproduzido na pr√≥xima tentativa ap√≥s o usu√°rio interagir
            this.isPlaying = false;
            this.currentAudio = null;
            // Manter na fila para tentar novamente depois
            this.queue.unshift(item); // Adicionar de volta no in√≠cio da fila
            return;
          }
          
          try {
            await this.currentAudio.play();
            console.log('‚ñ∂Ô∏è AudioQueue: √Åudio iniciado com sucesso');
          } catch (playError) {
            console.error('‚ùå AudioQueue: Erro ao reproduzir:', {
              name: playError.name,
              message: playError.message
            });
            // Erro comum: autoplay bloqueado pelo navegador
            if (playError.name === 'NotAllowedError' || playError.name === 'NotSupportedError') {
              console.warn('‚ö†Ô∏è AudioQueue: Autoplay bloqueado pelo navegador. Aguardando intera√ß√£o do usu√°rio...');
              console.log('üí° Clique em qualquer lugar da p√°gina para habilitar √°udio');
              // N√£o tentar desbloquear automaticamente - aguardar intera√ß√£o do usu√°rio
              this.isPlaying = false;
              this.currentAudio = null;
              // Manter na fila para tentar novamente depois
              this.queue.unshift(item);
            } else {
              throw playError; // Re-lan√ßar outros erros
            }
          }
          
        } catch (error) {
          console.error('‚ùå AudioQueue: Erro ao iniciar √°udio:', error);
          console.error('   URL:', item.audioUrl);
          console.error('   Erro completo:', error.message);
          console.error('   Tipo de erro:', error.name);
          this.isPlaying = false;
          this.currentAudio = null;
          this.playNext();
        }
      }
      
      // Calcular prioridade (1-10)
      _calcularPrioridade(notif) {
        const prioridades = {
          'pendencia_bloqueante': 10,
          'atraso_critico': 9,
          'chegada': 8,
          'status_di_mudou': 7,
          'status_duimp_mudou': 7,
          'status_ce_mudou': 7,
          'afrmm_pago': 5,
          'icms_pago': 5,
          'pendencia_resolvida': 4,
          'frete_pago': 4
        };
        
        return prioridades[notif.tipo_notificacao] || 3;
      }
      
      // Pular notifica√ß√£o atual
      skip() {
        if (this.currentAudio) {
          this.currentAudio.pause();
          this.currentAudio = null;
          this.isPlaying = false;
          this.playNext();
        }
      }
      
      // Limpar fila
      clear() {
        this.queue = [];
        if (this.currentAudio) {
          this.currentAudio.pause();
          this.currentAudio = null;
        }
        this.isPlaying = false;
      }
      
      // Mutar/desmutar
      toggleMute() {
        this.userMuted = !this.userMuted;
        localStorage.setItem('tts_muted', this.userMuted);
        
        if (this.userMuted && this.currentAudio) {
          this.currentAudio.pause();
          this.currentAudio = null;
          this.isPlaying = false;
        }
        
        return this.userMuted;
      }
      
      // Ajustar volume
      setVolume(volume) {
        this.volume = Math.max(0, Math.min(1, volume));
        localStorage.setItem('tts_volume', this.volume);
        
        if (this.currentAudio) {
          this.currentAudio.volume = this.volume;
        }
      }
    }
    
    // Inst√¢ncia global da fila de √°udio
    const audioQueue = new AudioQueue();
    
    // ‚úÖ NOVO: Desbloquear √°udio quando usu√°rio interagir (necess√°rio para autoplay policy)
    // ‚úÖ NOVO: Tornar audioUnlocked global para debug
    window.audioUnlocked = false;
    let audioUnlocked = false;
    let unlockAttempts = 0;
    const MAX_UNLOCK_ATTEMPTS = 5;
    
    function unlockAudio() {
      if (audioUnlocked) {
        return Promise.resolve(true); // J√° desbloqueado
      }
      
      // ‚úÖ ESTRAT√âGIA SIMPLIFICADA: Tentar reproduzir o primeiro √°udio da fila diretamente
      // Isso √© mais confi√°vel que um √°udio base64 inline (que n√£o funciona em alguns navegadores)
      if (audioQueue.queue.length > 0 && !audioQueue.isPlaying) {
        console.log('üîì Tentando desbloquear reproduzindo primeiro √°udio da fila...');
        // Tentar reproduzir o primeiro √°udio da fila
        return audioQueue.playNext().then(() => {
          // Se conseguiu reproduzir, √°udio est√° desbloqueado
          audioUnlocked = true;
          window.audioUnlocked = true;
          console.log('‚úÖ √Åudio desbloqueado - autoplay habilitado (reproduzindo primeiro √°udio)');
          return true;
        }).catch(err => {
          console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel desbloquear reproduzindo primeiro √°udio:`, err.name);
          return false;
        });
      }
      
      // Se n√£o h√° √°udios na fila, retornar false (aguardar intera√ß√£o do usu√°rio)
      return Promise.resolve(false);
    }
    
    // ‚úÖ CORRE√á√ÉO: Tentar desbloquear em qualquer intera√ß√£o do usu√°rio (sem once: true)
    // Isso permite m√∫ltiplas tentativas se a primeira falhar
    // ‚úÖ NOVO: Ap√≥s desbloquear, tentar reproduzir √°udios pendentes na fila
    // ‚úÖ CORRE√á√ÉO: Adicionar debounce para evitar m√∫ltiplas chamadas
    let handleUserInteractionTimeout = null;
    let lastInteractionTime = 0;
    const INTERACTION_DEBOUNCE_MS = 500; // 500ms de debounce
    
    function handleUserInteraction() {
      const now = Date.now();
      
      // ‚úÖ Debounce: ignorar se foi chamado muito recentemente
      if (now - lastInteractionTime < INTERACTION_DEBOUNCE_MS) {
        return;
      }
      lastInteractionTime = now;
      
      // Limpar timeout anterior se existir
      if (handleUserInteractionTimeout) {
        clearTimeout(handleUserInteractionTimeout);
      }
      
      // ‚úÖ Debounce: executar ap√≥s pequeno delay para evitar m√∫ltiplas chamadas
      handleUserInteractionTimeout = setTimeout(() => {
        // ‚úÖ CORRE√á√ÉO: Resetar contador de tentativas quando usu√°rio interagir
        // Isso permite novas tentativas ap√≥s intera√ß√£o do usu√°rio
        if (unlockAttempts >= MAX_UNLOCK_ATTEMPTS) {
          unlockAttempts = 0; // Resetar contador para permitir novas tentativas
          console.log('üîÑ Resetando contador de tentativas de desbloqueio ap√≥s intera√ß√£o do usu√°rio');
        }
        
        if (!audioUnlocked) {
          // ‚úÖ ESTRAT√âGIA SIMPLIFICADA: Tentar reproduzir o primeiro √°udio da fila diretamente
          // Isso desbloqueia o autoplay automaticamente quando o usu√°rio interage
          if (audioQueue.queue.length > 0 && !audioQueue.isPlaying) {
            console.log('üîì Tentando desbloquear reproduzindo primeiro √°udio da fila ap√≥s intera√ß√£o...');
            // Tentar reproduzir o primeiro √°udio da fila
            audioQueue.playNext().then(() => {
              // Se conseguiu reproduzir, √°udio est√° desbloqueado
              audioUnlocked = true;
              window.audioUnlocked = true;
              console.log('‚úÖ √Åudio desbloqueado ap√≥s intera√ß√£o do usu√°rio (reproduzindo primeiro √°udio)');
            }).catch(err => {
              console.warn('‚ö†Ô∏è N√£o foi poss√≠vel desbloquear reproduzindo primeiro √°udio:', err.name);
            });
          } else {
            // Se n√£o h√° √°udios na fila, apenas marcar como desbloqueado para pr√≥xima vez
            audioUnlocked = true;
            window.audioUnlocked = true;
            console.log('‚úÖ √Åudio desbloqueado ap√≥s intera√ß√£o do usu√°rio (sem √°udios na fila)');
          }
        } else {
          // ‚úÖ NOVO: Se j√° est√° desbloqueado mas n√£o est√° reproduzindo, tentar reproduzir pendentes
          if (audioQueue.queue.length > 0 && !audioQueue.isPlaying) {
            console.log(`üîÑ √Åudio j√° desbloqueado, reproduzindo ${audioQueue.queue.length} √°udio(s) pendente(s)...`);
            audioQueue.playNext();
          }
        }
      }, 100); // 100ms de delay para debounce
    }
    
    document.addEventListener('click', handleUserInteraction);
    document.addEventListener('keydown', handleUserInteraction);
    document.addEventListener('touchstart', handleUserInteraction);
    
    // ‚úÖ REMOVIDO: Tentativa autom√°tica de desbloqueio n√£o funciona
    // O √°udio s√≥ pode ser desbloqueado ap√≥s intera√ß√£o do usu√°rio (pol√≠tica do navegador)
    
    // ‚úÖ NOVO: Contador de falhas consecutivas para evitar spam de erros
    let falhasConsecutivas = 0;
    const MAX_FALHAS_CONSECUTIVAS = 3;
    let servidorIndisponivel = false;
    
    function iniciarPollingNotificacoes() {
      // Buscar notifica√ß√µes a cada 30 segundos
      buscarNotificacoes(); // Primeira busca imediata
      
      pollingNotificacoesInterval = setInterval(() => {
        // ‚úÖ CORRE√á√ÉO: S√≥ tentar buscar se servidor n√£o estiver marcado como indispon√≠vel
        // ou se j√° passou tempo suficiente desde a √∫ltima tentativa
        if (!servidorIndisponivel || falhasConsecutivas < MAX_FALHAS_CONSECUTIVAS) {
          buscarNotificacoes();
        }
      }, 30000); // 30 segundos
    }
    
    function pararPollingNotificacoes() {
      if (pollingNotificacoesInterval) {
        clearInterval(pollingNotificacoesInterval);
        pollingNotificacoesInterval = null;
      }
    }
    
    async function buscarNotificacoes() {
      try {
        const response = await fetch('/api/notificacoes?apenas_nao_lidas=true&limite=10');
        if (!response.ok) {
          falhasConsecutivas++;
          if (falhasConsecutivas >= MAX_FALHAS_CONSECUTIVAS && !servidorIndisponivel) {
            servidorIndisponivel = true;
            console.warn('‚ö†Ô∏è Servidor n√£o est√° respondendo. Verifique se o Flask est√° rodando na porta 5001.');
            console.warn('üí° Para iniciar o servidor, execute: python3 app.py');
          }
          return;
        }
        
        // ‚úÖ CORRE√á√ÉO: Resetar contador de falhas se a requisi√ß√£o foi bem-sucedida
        if (falhasConsecutivas > 0) {
          falhasConsecutivas = 0;
          servidorIndisponivel = false;
          console.log('‚úÖ Conex√£o com servidor restaurada');
        }
        
        const data = await response.json();
        if (data.success && data.notificacoes) {
          // Processar notifica√ß√µes em lote para evitar duplicatas
          const novasNotificacoes = data.notificacoes.filter(notif => !notificacoesLidas.has(notif.id));
          
          if (novasNotificacoes.length > 0) {
            console.log(`üì¨ ${novasNotificacoes.length} nova(s) notifica√ß√£o(√µes) detectada(s)`);
            
            // ‚úÖ CORRE√á√ÉO: Exibir primeiro, depois marcar como lida
            // Isso garante que o √°udio seja adicionado √† fila antes de qualquer outra a√ß√£o
            novasNotificacoes.forEach((notif, index) => {
              setTimeout(() => {
                exibirNotificacao(notif);
                notificacoesLidas.add(notif.id);
                
                // Marcar como lida ap√≥s exibir (com pequeno delay para garantir que √°udio foi adicionado)
                setTimeout(() => {
                  marcarNotificacaoLida(notif.id);
                }, 1000); // 1 segundo ap√≥s exibir
              }, index * 200); // 200ms entre cada notifica√ß√£o
            });
          }
        }
      } catch (error) {
        falhasConsecutivas++;
        // ‚úÖ CORRE√á√ÉO: S√≥ logar erro se for erro de conex√£o (n√£o logar erros de rede repetidamente)
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          if (falhasConsecutivas >= MAX_FALHAS_CONSECUTIVAS && !servidorIndisponivel) {
            servidorIndisponivel = true;
            console.warn('‚ö†Ô∏è Servidor n√£o est√° respondendo. Verifique se o Flask est√° rodando na porta 5001.');
            console.warn('üí° Para iniciar o servidor, execute: python3 app.py');
          } else if (falhasConsecutivas < MAX_FALHAS_CONSECUTIVAS) {
            console.warn(`‚ö†Ô∏è Erro ao buscar notifica√ß√µes (tentativa ${falhasConsecutivas}/${MAX_FALHAS_CONSECUTIVAS}):`, error.message);
          }
        } else {
          console.warn('Erro ao buscar notifica√ß√µes:', error);
        }
      }
    }
    
    function exibirNotificacao(notif) {
      // Adicionar notifica√ß√£o no chat como mensagem do assistente (mesmo padr√£o visual)
      const chatMessages = document.getElementById('chat-messages');
      if (!chatMessages) return;
      
      // Verificar se j√° existe uma notifica√ß√£o com o mesmo ID (evitar duplicatas)
      const existingNotif = chatMessages.querySelector(`[data-notificacao-id="${notif.id}"]`);
      if (existingNotif) {
        return; // J√° foi exibida
      }
      
      // ‚úÖ Usar o mesmo padr√£o visual das mensagens do assistente
      const notifDiv = document.createElement('div');
      notifDiv.className = 'chat-message assistente';
      notifDiv.setAttribute('data-notificacao-id', notif.id);
      
      // ‚úÖ NOVO: Adicionar data da notifica√ß√£o na mensagem
      const dataNotificacao = notif.criado_em ? formatarDataNotificacao(notif.criado_em) : formatarHora();
      const mensagemComData = notif.mensagem + (notif.mensagem.trim().endsWith('.') ? '' : '') + `\n\nüìÖ Data: ${dataNotificacao}`;
      
      // Formatar mensagem (t√≠tulo + mensagem com data)
      const mensagemCompleta = notif.titulo + '\n\n' + mensagemComData;
      const mensagemFormatada = formatarRespostaChat(mensagemCompleta);
      const mensagemDecorada = decorarProcessosEmHtml(mensagemFormatada);
      
      const hora = formatarDataNotificacao(notif.criado_em) || formatarHora();
      
      // ‚úÖ Usar a mesma estrutura HTML das mensagens do assistente
      notifDiv.innerHTML = `
        <span class="chat-message-header">ü§ñ mAIke</span>
        <div class="chat-message-content">${mensagemDecorada}</div>
        <div class="chat-message-time">${hora}</div>
      `;
      // ‚úÖ Aplicar "badge" para processos tamb√©m nas notifica√ß√µes
      try {
        aplicarBadgesProcesso(notifDiv.querySelector('.chat-message-content'));
      } catch (e) {}
      
      chatMessages.appendChild(notifDiv);
      
      // Scroll suave para baixo
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
      
      // ‚úÖ NOVO: Reproduzir √°udio TTS se dispon√≠vel
      console.log(`üîç DEBUG exibirNotificacao: Notifica√ß√£o ${notif.id}`, {
        tem_dados_extras: !!notif.dados_extras,
        tipo_dados_extras: typeof notif.dados_extras,
        dados_extras: notif.dados_extras
      });
      
      if (notif.dados_extras) {
        // Extrair audio_url dos dados_extras (pode ser string JSON ou objeto)
        let audioUrl = null;
        if (typeof notif.dados_extras === 'string') {
          try {
            const dados = JSON.parse(notif.dados_extras);
            audioUrl = dados.audio_url;
            console.log(`üîç DEBUG: Parseou string JSON, audioUrl:`, audioUrl);
          } catch (e) {
            console.warn('‚ö†Ô∏è Erro ao parsear dados_extras:', e);
          }
        } else {
          audioUrl = notif.dados_extras.audio_url;
          console.log(`üîç DEBUG: dados_extras √© objeto, audioUrl:`, audioUrl);
        }
        
        if (audioUrl) {
          console.log(`üîä ‚úÖ √Åudio encontrado para notifica√ß√£o ${notif.id}: ${audioUrl}`);
          // Adicionar √† fila de reprodu√ß√£o
          audioQueue.addNotification({
            id: notif.id,
            audio_url: audioUrl,
            titulo: notif.titulo,
            tipo_notificacao: notif.tipo_notificacao
          });
        } else {
          console.warn(`‚ö†Ô∏è Notifica√ß√£o ${notif.id} n√£o tem audio_url nos dados_extras`);
          console.warn(`   dados_extras completo:`, JSON.stringify(notif.dados_extras));
        }
      } else {
        console.warn(`‚ö†Ô∏è Notifica√ß√£o ${notif.id} n√£o tem dados_extras`);
      }
      
      // Efeito de notifica√ß√£o do navegador (opcional)
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(notif.titulo, {
          body: notif.mensagem.replace(/\n/g, ' ').substring(0, 100) + '...',
          icon: '/static/favicon.ico',
          tag: `notif-${notif.id}` // Evita notifica√ß√µes duplicadas do navegador
        });
      }
    }
    
    async function marcarNotificacaoLida(id) {
      try {
        const response = await fetch(`/api/notificacoes/${id}/marcar-lida`, { method: 'POST' });
        if (!response.ok) {
          console.warn(`Erro ao marcar notifica√ß√£o ${id} como lida: ${response.status}`);
        }
      } catch (error) {
        console.warn('Erro ao marcar notifica√ß√£o como lida:', error);
      }
    }
    
    // Solicitar permiss√£o para notifica√ß√µes do navegador (opcional)
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
    
    // ‚úÖ NOVO: Fun√ß√£o para alternar TTS (mutar/desmutar)
    function toggleTTS() {
      const muted = audioQueue.toggleMute();
      const btn = document.getElementById('tts-toggle-btn');
      
      if (muted) {
        btn.innerHTML = 'üîá';
        btn.style.background = 'rgba(244, 67, 54, 0.3)'; // Vermelho quando mutado
        btn.title = 'Notifica√ß√µes por voz desativadas (clique para ativar)';
      } else {
        btn.innerHTML = 'üîä';
        btn.style.background = 'rgba(255,255,255,0.2)'; // Normal quando ativo
        btn.title = 'Notifica√ß√µes por voz ativadas (clique para desativar)';
      }
    }
    
    // ‚úÖ Atualizar bot√£o TTS ao carregar p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('tts-toggle-btn');
      if (btn && audioQueue.userMuted) {
        btn.innerHTML = 'üîá';
        btn.style.background = 'rgba(244, 67, 54, 0.3)';
        btn.title = 'Notifica√ß√µes por voz desativadas (clique para ativar)';
      }
    });
    
    // ‚úÖ NOVO: Fun√ß√£o global para testar notifica√ß√£o manualmente (dispon√≠vel no console)
    window.testarNotificacaoTTS = function(notificacaoId) {
      console.log(`üß™ Testando notifica√ß√£o ID ${notificacaoId}...`);
      
      fetch(`/api/teste/reproduzir-notificacao/${notificacaoId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.notificacao) {
            console.log('‚úÖ Notifica√ß√£o encontrada:', data.notificacao);
            exibirNotificacao(data.notificacao);
          } else {
            console.error('‚ùå Erro:', data.error);
          }
        })
        .catch(e => console.error('‚ùå Erro:', e));
    };
    
    // ‚úÖ Parar polling quando a p√°gina for fechada ou navegada
    window.addEventListener('beforeunload', pararPollingNotificacoes);
    window.addEventListener('pagehide', pararPollingNotificacoes);
    
    // Prevenir zoom em double-tap no iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // ‚úÖ Prevenir pull-to-refresh no iOS Safari
    let touchStartY = 0;
    document.addEventListener('touchstart', function(e) {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchmove', function(e) {
      const touchY = e.touches[0].clientY;
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      
      // Se est√° no topo e est√° puxando para baixo, prevenir
      if (scrollTop === 0 && touchY > touchStartY) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // ‚úÖ Melhorar experi√™ncia de scroll no iOS
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
      chatMessages.style.webkitOverflowScrolling = 'touch';
      chatMessages.style.overscrollBehavior = 'contain';
      // ‚úÖ Otimiza√ß√µes adicionais para performance em respostas grandes
      chatMessages.style.touchAction = 'pan-y';
      chatMessages.style.willChange = 'scroll-position';
      chatMessages.style.transform = 'translateZ(0)';
      chatMessages.style.webkitTransform = 'translateZ(0)';
    }
    
    // ‚úÖ Esconder barra de navega√ß√£o do Safari quando em modo standalone
    function esconderBarraNavegacao() {
      // Detectar se est√° em modo standalone (adicionado √† tela inicial)
      const isStandalone = window.navigator.standalone || 
                          window.matchMedia('(display-mode: standalone)').matches ||
                          document.referrer.includes('android-app://');
      
      if (isStandalone) {
        // Adicionar classe para CSS
        document.body.classList.add('standalone-mode');
        
        // Esconder barra de navega√ß√£o do Safari no iOS
        // For√ßar altura total da viewport
        const setViewportHeight = () => {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
      }
    }
    
    // Executar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', esconderBarraNavegacao);
    } else {
      esconderBarraNavegacao();
    }
  </script>
</body>
</html>

